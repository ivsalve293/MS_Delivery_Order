html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Steel Mart MS Delivery Order | Smart Dispatch Sheet</title>
  <meta name="description" content="Create, validate, and print professional MS Delivery Orders." />
  <meta name="theme-color" content="#dc2626" />

  <style>
    :root{
      /* Theme */
      --bg:#fff5f5;
      --surface:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(220,38,38,.14);
      --border2:rgba(15,23,42,.08);

      --brand:#dc2626;
      --brand2:#b91c1c;
      --brand3:#ef4444;

      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;

      --radius:16px;
      --radius2:22px;

      --shadow-sm: 0 8px 20px rgba(15,23,42,.07);
      --shadow:    0 16px 44px rgba(15,23,42,.11);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans","Liberation Sans", sans-serif;

      --ring: 0 0 0 4px rgba(220,38,38,.22);

      --ease: cubic-bezier(.2,.8,.2,1);
      --ease2:cubic-bezier(.16,1,.3,1);
      --dur1: .16s;
      --dur2: .28s;

      /* ‚úÖ Wider desktop max */
      --page-max:1320px;

      /* Type scale */
      --fs-body: 14px;
      --fs-label: 12px;
      --fs-help: 12px;
      --fs-h2: 12px;
      --lh: 1.5;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      line-height:var(--lh);
      text-rendering:optimizeLegibility;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;

      background:
        radial-gradient(900px 500px at 10% 0%, rgba(220,38,38,.14), transparent 60%),
        radial-gradient(700px 500px at 100% 10%, rgba(239,68,68,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(220,38,38,.08), transparent 60%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 55%, #ffffff 100%);
      overflow-x:hidden;
      font-size: var(--fs-body);
    }

    body::before{
      content:"";
      position:fixed; inset:-40% -30%;
      background:
        radial-gradient(closest-side, rgba(220,38,38,.06), transparent 65%),
        radial-gradient(closest-side, rgba(239,68,68,.05), transparent 70%);
      filter: blur(18px);
      transform: translate3d(0,0,0);
      animation: bgFloat 20s var(--ease2) infinite alternate;
      pointer-events:none;
      z-index:-1;
      opacity:.9;
    }
    @keyframes bgFloat{
      0%{ transform: translate(-2%, -1%) scale(1); }
      100%{ transform: translate(2%, 1%) scale(1.05); }
    }

    .wrap{max-width:var(--page-max);margin:0 auto;padding:18px 14px 50px;}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.80);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(220,38,38,.12);
    }
    .topbar-inner{
      max-width:var(--page-max);margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      gap:12px;
    }

    .brand{display:flex;align-items:center;gap:12px;min-width:240px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand3));
      color:white;font-weight:950;display:grid;place-items:center;
      box-shadow: 0 16px 34px rgba(220,38,38,.24);
      letter-spacing:.03em;
      position:relative; overflow:hidden;
      user-select:none;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-60% -40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.30), transparent);
      transform: rotate(25deg) translateX(-40%);
      animation: shimmer 3.2s var(--ease2) infinite;
    }
    @keyframes shimmer{
      0%{ transform: rotate(25deg) translateX(-55%); opacity:.30; }
      100%{ transform: rotate(25deg) translateX(55%); opacity:.22; }
    }

    .brand h1{
      margin:0;
      font-size:15px;
      line-height:1.15;
      letter-spacing:.01em;
      font-weight:950;
    }
    .brand p{
      margin:2px 0 0;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:800;
    }

    .actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(220,38,38,.14);
      box-shadow: var(--shadow-sm);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background:var(--ok);
      box-shadow:0 0 0 4px rgba(22,163,74,.12);
      flex:0 0 auto;
    }
    .dot.warn{background:var(--warn);box-shadow:0 0 0 4px rgba(245,158,11,.14);}
    .dot.danger{background:var(--danger);box-shadow:0 0 0 4px rgba(239,68,68,.14);}

    /* Buttons */
    .btn{
      border:1px solid rgba(220,38,38,.14);
      background:rgba(255,255,255,.92);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      transition: transform var(--dur1) var(--ease), box-shadow var(--dur1) var(--ease), border-color var(--dur1) var(--ease), background var(--dur1) var(--ease);
      box-shadow: var(--shadow-sm);
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-height:40px;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);box-shadow: var(--shadow);}
    .btn:active{transform:translateY(0px) scale(.99);}
    .btn:focus{outline:none;box-shadow:var(--ring), var(--shadow);border-color:rgba(220,38,38,.35);}

    .btn.primary{
      border-color:transparent;
      background: linear-gradient(90deg,var(--brand),var(--brand2));
      color:white;
      box-shadow: 0 18px 44px rgba(220,38,38,.24);
    }
    .btn.primary:hover{box-shadow: 0 22px 58px rgba(220,38,38,.28);}

    .btn.secondary{
      background: rgba(255,255,255,.92);
      border-color: rgba(220,38,38,.20);
    }

    .btn.ghost{
      background:transparent;
      box-shadow:none;
      border-color:rgba(220,38,38,.12);
      color:#374151;
    }
    .btn.ghost:hover{background:rgba(220,38,38,.05);}

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1fr 320px; /* ‚úÖ narrower sidebar */
      gap:16px;
      align-items:start;
      margin-top:16px;
    }
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }

    /* Cards */
    .card{
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.88));
      border:1px solid rgba(220,38,38,.14);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
      transform: translateY(8px);
      opacity:0;
      animation: cardIn .50s var(--ease2) forwards;
    }
    @keyframes cardIn{ to{ transform: translateY(0); opacity:1; } }

    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(820px 160px at 18% 0%, rgba(220,38,38,.18), transparent 60%),
        radial-gradient(820px 160px at 82% 0%, rgba(239,68,68,.11), transparent 60%);
      opacity:.65;
      pointer-events:none;
    }
    .card::after{
      content:"";
      position:absolute; top:-90px; right:-90px;
      width:190px;height:190px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(220,38,38,.14), transparent 65%);
      pointer-events:none;
    }

    .card h2{
      margin:0 0 12px;
      font-size:var(--fs-h2);
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#991b1b;
      display:flex;align-items:center;gap:10px;
      font-weight:950;
    }
    .card h2::before{
      content:"";
      width:18px;height:6px;border-radius:99px;
      background: linear-gradient(90deg,var(--brand), #ff9aa7);
      box-shadow: 0 10px 18px rgba(220,38,38,.14);
      flex:0 0 auto;
    }

    /* Form grid */
    .grid{display:grid;grid-template-columns: repeat(12, 1fr);gap:12px;}
    .field{grid-column: span 6;}
    .field.span-12{grid-column: span 12;}
    .field.span-4{grid-column: span 4;}
    .field.span-3{grid-column: span 3;}
    @media (max-width: 720px){
      .field, .field.span-12, .field.span-4, .field.span-3{grid-column:span 12;}
    }

    label{
      display:flex;align-items:baseline;justify-content:space-between;
      gap:10px;
      font-size:var(--fs-label);
      font-weight:950;
      color:#374151;
      margin:2px 0 6px;
    }
    label .req{color:var(--danger);font-weight:950;margin-left:8px;}

    /* ‚úÖ Freight label left only */
    .freight-left-label label{ justify-content:flex-start; }

    input, textarea, select{
      width:100%;
      border:1px solid rgba(220,38,38,.16);
      background: rgba(255,255,255,.94);
      border-radius:14px;
      padding:11px 12px;
      font-size:13px;
      transition: border-color var(--dur1) var(--ease), box-shadow var(--dur1) var(--ease), transform var(--dur1) var(--ease), background var(--dur1) var(--ease);
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
    }
    textarea{min-height:82px;resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(55,65,81,.65)}
    input:focus, textarea:focus, select:focus{
      outline:none;
      border-color:rgba(220,38,38,.46);
      box-shadow:var(--ring);
      background:#fff;
      transform: translateY(-1px);
    }
    input[readonly]{background:#fff1f2;color:#6b7280;border-color:rgba(220,38,38,.10)}

    .help{margin:8px 0 0;font-size:var(--fs-help);color:var(--muted)}
    .error{margin:6px 0 0;font-size:12px;color:var(--danger);min-height:16px}

    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:8px 0 6px;
    }
    .toolbar-left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toolbar-right{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}

    /* Tables */
    .table-wrap{
      width:100%;
      overflow:auto;
      border-radius:16px;
      -webkit-overflow-scrolling:touch;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid rgba(220,38,38,.14);
      border-radius:16px;
      background:white;

      table-layout:auto; /* ‚úÖ allow columns to fit naturally */
      box-shadow: 0 8px 22px rgba(15,23,42,.06);
    }

    /* ‚úÖ Desktop fit: tighter cells + smaller header */
    table th, table td{
      padding:10px 8px;
    }
    td input, td select{
      min-width:0; /* ‚úÖ prevent inputs from forcing width */
      width:100%;
      max-width:100%;
      box-sizing:border-box;
      display:block;
    }

    thead th{
      font-size:10px;           /* ‚úÖ smaller header */
      letter-spacing:.10em;
      text-transform:uppercase;
      color:#6b7280;
      background: linear-gradient(180deg, #fff, #fff5f5);
      border-bottom:1px solid rgba(220,38,38,.12);
      text-align:left;
      white-space:nowrap;

      position: sticky;
      top: 0;
      z-index: 2;
    }

    tbody td{
      border-bottom:1px solid rgba(15,23,42,.06);
      vertical-align:top;
      overflow:hidden;
    }
    tbody tr:last-child td{border-bottom:none}
    .cell-center{text-align:center}
    .mini{padding:10px 10px;border-radius:12px;font-size:13px;}

    .bd{
      background: #fff1f2;
      border:1px dashed rgba(220,38,38,.28);
      color:#9f1239;
      font-weight:900;
    }

    .icon{
      width:40px;height:40px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid rgba(220,38,38,.14);
      background: #fff;
      cursor:pointer;
      transition: transform var(--dur1) var(--ease), box-shadow var(--dur1) var(--ease), background var(--dur1) var(--ease);
      box-shadow: var(--shadow-sm);
    }
    .icon:hover{transform: translateY(-1px);box-shadow: var(--shadow);background: #fff5f5;}

    .tfoot{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      margin-top:12px;flex-wrap:wrap;
    }
    .totalbox{
      display:flex;align-items:center;gap:10px;
      padding:11px 13px;border-radius:14px;
      border:1px solid rgba(220,38,38,.14);
      background: linear-gradient(180deg, #fff, #fff5f5);
      font-weight:950;
      box-shadow: var(--shadow-sm);
    }
    .totalbox span{
      color:var(--muted);font-weight:900;font-size:11px;
      letter-spacing:.14em;text-transform:uppercase
    }
    .totalbox strong{font-family:var(--mono);font-size:14px;color:#991b1b}

    /* Summary */
    .summary{
      position:sticky; top:74px;
      border:1px solid rgba(220,38,38,.20);
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,245,245,.92));
    }
    @media (max-width: 980px){ .summary{position:relative;top:auto} }

    .kv{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 0;
      border-bottom:1px dashed rgba(220,38,38,.18);
      gap:12px;
    }
    .kv:last-child{border-bottom:none}
    .kv span{
      color:var(--muted);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:950
    }
    .kv strong{
      font-family:var(--mono);
      font-size:13px;
      color:#991b1b;
      padding:6px 10px;
      border-radius:12px;
      background: rgba(220,38,38,.06);
      border:1px solid rgba(220,38,38,.10);
      min-width:120px;
      text-align:right;
    }

    .banner{
      display:none;
      margin:12px 0 0;
      padding:12px 14px;
      border:1px solid rgba(220,38,38,.18);
      background: linear-gradient(180deg, #fff, #fff5f5);
      color:#991b1b;
      border-radius:18px;
      box-shadow: var(--shadow-sm);
    }
    .banner.show{display:block}

    .toast{
      position:fixed;left:50%;bottom:18px;
      transform:translateX(-50%) translateY(10px);
      background:rgba(17,24,39,.92);color:white;
      padding:10px 12px;border-radius:999px;
      display:none;gap:10px;align-items:center;z-index:1000;
      box-shadow:0 22px 70px rgba(15,23,42,.35);
      font-size:13px;
      opacity:0;
      transition: opacity var(--dur2) var(--ease2), transform var(--dur2) var(--ease2);
    }
    .toast.show{display:flex; opacity:1; transform:translateX(-50%) translateY(0)}
    .toast button{
      border:1px solid rgba(255,255,255,.22);
      background:transparent;color:white;
      padding:6px 10px;border-radius:999px;
      cursor:pointer;font-weight:950;font-size:12px;
    }

    /* Print-only output */
    .print-only{display:none;}
    #printText{display:none;} /* Hide the old text view */
    #printTableLayout{display:none;}

    /* New Print Table Styling */
    .print-table {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid #000;
        font-family: "Segoe UI", sans-serif;
        color: #000;
    }
    .print-table td, .print-table th {
        border: 1px solid #000;
        padding: 6px 8px;
        font-size: 13px;
        vertical-align: middle;
    }
    .print-table .label {
        font-weight: bold;
        background-color: #f0f0f0; /* Light gray background for labels */
        width: 140px;
    }
    .print-table .header-val {
        font-weight: 500;
    }
    .print-table th {
        background-color: #f0f0f0;
        text-align: center;
        font-weight: bold;
        text-transform: uppercase;
    }
    .print-table .center { text-align: center; }
    .print-table .right { text-align: right; }
    
    .spacer-row td { height: 10px; border-left: 2px solid #000; border-right: 2px solid #000; }
    
    @media print{
      @page{size:A4 portrait;margin:10mm;}
      body{background:#fff; margin:0; padding:0;}
      .topbar, .actions, .summary, .banner, .toast, .no-print{display:none !important}

      .wrap{max-width:none;margin:0;padding:0}
      .layout{grid-template-columns:1fr; gap:0}
      main{display:none !important;}
      
      /* Show new table layout */
      .print-only{display:block !important;}
      #printTableLayout{display:block;}
      
      .card{
        box-shadow:none;border:0;border-radius:0;
        padding:0; margin:0;
        opacity:1; transform:none;
      }
      .card::before,.card::after{display:none}
    }
  </style>
</head>

<body>
  <div class="topbar no-print">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">SM</div>
        <div>
          <h1>MS Delivery Order</h1>
          <p>Smart Steel Dispatch Sheet</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="savePill" title="Autosave status">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">Draft</span>
        </div>

        <button class="btn ghost" type="button" data-action="reset">üßπ Reset</button>
        <button class="btn secondary" type="button" data-action="exportCsv">‚¨áÔ∏è Export CSV</button>
        <button class="btn secondary" type="button" data-action="copySummary">üìã Copy Summary</button>
        <button class="btn primary" type="button" data-action="print">üñ®Ô∏è Print</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="banner" id="resumeBanner">
      <strong>Resume draft?</strong>
      <span id="resumeMeta" style="margin-left:6px;"></span>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn secondary" type="button" id="resumeYes">‚Ü©Ô∏è Resume</button>
        <button class="btn ghost" type="button" id="resumeNo">üóëÔ∏è Discard</button>
      </div>
    </div>

    <div class="layout">
      <main>
        <form id="doForm" novalidate>
          <section class="card" aria-label="Party details">
            <h2>Party Details</h2>
            <div class="grid">
              <div class="field">
                <label for="dealerName">Dealer Name <span class="req">*</span></label>
                <input id="dealerName" name="dealerName" autocomplete="organization" required />
                <p class="error" id="err-dealerName" aria-live="polite"></p>
              </div>

              <div class="field">
                <label for="billingName">Billing Name <span class="req">*</span></label>
                <input id="billingName" name="billingName" required />
                <p class="error" id="err-billingName" aria-live="polite"></p>
              </div>

              <div class="field span-12">
                <label for="billingAddress">Billing Address <span class="req">*</span></label>
                <textarea id="billingAddress" name="billingAddress" rows="3" required></textarea>
                <p class="error" id="err-billingAddress" aria-live="polite"></p>
              </div>

              <div class="field span-12">
                <label for="dispatchAddress">Dispatch Address</label>
                <textarea id="dispatchAddress" name="dispatchAddress" rows="3"></textarea>
              </div>
            </div>
          </section>

          <section class="card" style="margin-top:14px" aria-label="Rates and Freight">
            <div class="toolbar">
              <div class="toolbar-left">
                <h2 style="margin:0">Item &amp; Sauda Rates</h2>
              </div>
              <div class="toolbar-right no-print">
                <button class="btn secondary" type="button" data-action="addItemRate">‚ûï Add Item</button>
              </div>
            </div>

            <div class="table-wrap">
              <table aria-label="Item Sauda table">
                <thead>
                  <tr>
                    <th style="width:44px; text-align:center;">#</th>
                    <th style="width:220px;">ITEM</th>
                    <th style="width:120px;">BILL TYPE</th>
                    <th style="width:140px;">SAUDA RATE</th>
                    <th style="width:120px;">OB</th>
                    <th style="width:64px;" class="cell-center no-print">REMOVE</th>
                  </tr>
                </thead>
                <tbody id="itemRatesBody"></tbody>
              </table>
            </div>

            <p class="error" id="err-itemRates" aria-live="polite"></p>

            <hr style="margin: 18px 0; border: 0; border-top: 1px dashed rgba(220,38,38,.18);">

            <!-- ‚úÖ NO CARD NAME/HEADING HERE -->
            <!-- ‚úÖ ORDER: Date | Freight | Lorry No -->
            <div class="grid">
              <div class="field span-4">
                <label for="orderDate">Date</label>
                <input id="orderDate" name="orderDate" type="date" required />
                <p class="error" id="err-orderDate" aria-live="polite"></p>
              </div>

              <div class="field span-4 freight-left-label">
                <label for="freight"><span style="color:var(--danger); font-weight:950; margin-right:4px;">*</span> Freight</label>
                <input id="freight" name="freight" type="text" placeholder="e.g. 1200 or Included" />
              </div>

              <div class="field span-4">
                <label for="lorryNo">Lorry No</label>
                <input id="lorryNo" name="lorryNo" type="text" placeholder="e.g. MH12AB1234" />
              </div>
            </div>
          </section>

          <section class="card" style="margin-top:14px" aria-label="Items and rates">
            <div class="toolbar">
              <div class="toolbar-left">
                <h2 style="margin:0">Items</h2>
              </div>
              <div class="toolbar-right no-print">
                <button class="btn secondary" type="button" data-action="addLine">‚ûï Add line</button>
                <button class="btn" type="button" data-action="dupLast">üß¨ Duplicate last</button>
              </div>
            </div>

            <div class="table-wrap">
              <table aria-label="Items table">
                <thead>
                  <tr>
                    <th style="width:44px;">#</th>
                    <th style="width:200px;">Item</th>
                    <th style="width:260px;">Sizes</th>
                    <th style="width:120px;">Qty (MT)</th>
                    <th style="width:120px;">Net Rate</th>
                    <!-- Remarks Removed from Header -->
                    <th style="width:auto;">Breakdown</th>
                    <th style="width:64px;" class="cell-center no-print">Remove</th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>

            <div class="tfoot">
              <div class="totalbox">
                <span>Total Qty</span>
                <strong id="totalQtyText">‚Äî</strong>
              </div>
            </div>
          </section>

          <section class="card" style="margin-top:14px" aria-label="Notes and signatures">
            <h2>Notes &amp; Signatures</h2>
            <div class="grid">
              <div class="field span-12">
                <label for="note">Note</label>
                <textarea id="note" name="note" rows="3" placeholder="Any dispatch notes..."></textarea>
              </div>
              <div class="field">
                <label for="signedBy">Order Signed By</label>
                <input id="signedBy" name="signedBy" type="text" />
              </div>
              <div class="field">
                <label for="approvedBy">Approved By</label>
                <input id="approvedBy" name="approvedBy" type="text" />
              </div>
            </div>
          </section>
        </form>
      </main>

      <aside class="summary card" aria-label="Summary">
        <h2>Summary</h2>
        <div class="kv"><span>Total Qty</span><strong id="sumTotalQty">‚Äî</strong></div>
        <div class="kv"><span>Lines</span><strong id="sumItems">0</strong></div>
        <div class="kv"><span>Status</span><strong id="sumStatus">Draft</strong></div>
        <div class="kv"><span>Last Save</span><strong id="sumSavedAt">‚Äî</strong></div>
      </aside>
    </div>

    <!-- NEW PRINT LAYOUT START -->
    <div id="printTableLayout" class="print-only">
      <table class="print-table">
        <!-- Row 1: Dealer Name -->
        <tr>
          <td class="label">Dealer Name</td>
          <td colspan="3" class="header-val" id="p-dealerName"></td>
        </tr>
        <!-- Row 2: Billing Name -->
        <tr>
          <td class="label">Billing Name</td>
          <td colspan="3" class="header-val" id="p-billingName"></td>
        </tr>
        <!-- Row 3: Billing Address -->
        <tr>
          <td class="label">Billing Address</td>
          <td colspan="1" class="header-val" id="p-billingAddress"></td>
          <td colspan="1"></td> <!-- Empty filler -->
          <td colspan="1"></td> <!-- Empty filler -->
        </tr>
        <!-- Row 4: Dispatch Address -->
        <tr>
          <td class="label" style="white-space:nowrap">Dispatch Address</td>
          <td colspan="3" class="header-val" id="p-dispatchAddress"></td>
        </tr>
        
        <!-- Meta Data Rows -->
        <tr>
          <td class="label">Item</td>
          <td class="header-val" id="p-mainItem" style="font-weight:bold;"></td>
          <td class="label"></td>
          <td class="label"></td>
        </tr>
        <tr>
          <td class="label">Sauda Rate</td>
          <td class="header-val" id="p-saudaRate" style="font-weight:bold;"></td>
          <td class="label" style="text-align:right">Date:</td>
          <td class="header-val center" id="p-date"></td>
        </tr>
        <tr>
          <td class="label">Total Qty</td>
          <td class="header-val" id="p-totalQty"></td>
          <td class="label" style="text-align:right">Freight</td>
          <td class="header-val center" id="p-freight"></td>
        </tr>
        <tr>
          <td class="label">Lorry No</td>
          <td class="header-val" id="p-lorry"></td>
          <td class="label" style="text-align:right">OB:</td>
          <td class="header-val center" id="p-ob"></td>
        </tr>

        <!-- Main Items Header -->
        <tr style="height:30px;">
          <th style="width:50px;">Sr No</th>
          <th>Size</th>
          <th>Qty (ton)</th>
          <th>Net Rate</th>
          <th>Break Down</th>
        </tr>

        <!-- Dynamic Items Body -->
        <tbody id="p-itemsBody"></tbody>

        <!-- Footer Total -->
        <tr>
           <td colspan="2" class="right" style="font-weight:bold;">TOTAL</td>
           <td class="center" style="font-weight:bold;" id="p-finalQty"></td>
           <td colspan="2"></td>
        </tr>

        <!-- Spacer -->
        <tr style="height:20px"><td colspan="5" style="border:1px solid #000"></td></tr>

        <!-- Notes -->
        <tr>
          <td class="label">Note:</td>
          <td colspan="4" id="p-note" style="height:40px; vertical-align:top;"></td>
        </tr>

        <!-- Signatures -->
        <tr style="height:50px;">
           <td class="label" style="vertical-align:bottom">Order Signed By</td>
           <td id="p-signedBy" style="vertical-align:bottom"></td>
           <td colspan="2" class="right" style="vertical-align:bottom; font-weight:bold;">Approved By.</td>
           <td id="p-approvedBy" style="vertical-align:bottom"></td>
        </tr>
      </table>
    </div>
    <!-- NEW PRINT LAYOUT END -->

  </div>

  <div class="toast" id="toast">
    <span id="toastText">Deleted line</span>
    <button type="button" id="toastUndo">UNDO</button>
  </div>

  <!-- Templates -->
  <template id="itemRateRowTpl">
    <tr>
      <td class="cell-center" data-label="Sr"><strong class="ir-sr"></strong></td>
      <td data-label="Item">
        <select class="ir-item mini"></select>
      </td>
      <td data-label="Bill Type">
        <select class="ir-billtype mini">
          <option value="BILL">Bill</option>
          <option value="NC">NC</option>
        </select>
      </td>
      <td data-label="Sauda Rate">
        <input class="ir-sauda mini" type="number" step="0.01" min="0" inputmode="decimal" placeholder="e.g. 52000" />
      </td>
      <td data-label="OB">
        <input class="ir-ob mini" type="number" step="0.01" inputmode="decimal" placeholder="(optional)" />
      </td>
      <td class="cell-center no-print" data-label="Remove">
        <button type="button" class="icon" data-action="removeItemRate" title="Remove">üóëÔ∏è</button>
      </td>
    </tr>
  </template>

  <template id="itemRowTpl">
    <tr>
      <td class="cell-center" data-label="Sr"><strong class="sr"></strong></td>

      <td data-label="Item">
        <select class="rowItem mini"></select>
      </td>

      <td data-label="Sizes" class="sizeCell"></td>

      <td data-label="Qty (MT)">
        <input class="qty mini" type="number" step="0.001" min="0" inputmode="decimal" placeholder="0.000" />
      </td>

      <td data-label="Net Rate">
        <input class="rate mini" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" readonly />
      </td>

      <td data-label="Breakdown">
        <input class="bd mini bd" type="text" readonly placeholder="‚Äî" />
      </td>

      <!-- Remarks Removed from Template -->

      <td class="cell-center no-print" data-label="Remove">
        <button type="button" class="icon" data-action="remove" title="Remove line">üóëÔ∏è</button>
      </td>
    </tr>
  </template>

  <script>
  // =========================
  // Item list
  // =========================
  const ITEM_LIST = [
    "MS Pipe","MS Angle","MS Channel","Binding Wire","Nails",
    "Sqr Bar","Round Bar","Flats","HR Pipe","MS Structure ISMC","Heavy Structure ISMB"
  ];

  // =========================
  // Size -> SD mapping
  // NOTE: Any blank/null SD is treated as 0.
  // =========================
  const SIZE_SD_LIST = {
    "MS Pipe": [
      ["0.75\" 19x19(1.2) 4kg",7000],["0.75\" 19x19(1.6) 5kg",6500],["0.75\" 19x19(2.0) 6kg",6000],
      ["1\" 25x25(1.2) 6kg",5000],["1\" 25x25(1.6) 7kg",4000],["1\" 25x25(2.0) 9kg",4000],
      ["1\" 25x25(2.5) 11.5kg",4000],["1.25\" 32x32(1.2) 7kg",5000],["1.25\" 32x32(1.6) 9kg",3500],
      ["1.25\" 32x32(2.0) 11kg",3500],["1.25\" 32x32(2.5) 15.5kg",3500],["1.25\" 32x32(2.9) 17.5kg",3500],
      ["1.5\" 38x38(1.2) 8.5kg",4500],["1.5\" 38x38(1.6) 11kg",3000],["1.5\" 38x38(2.0) 13kg",3000],
      ["1.5\" 38x38(2.5) 17kg",3000],["1.5\" 38x38(2.9) 19kg",3000],["47x47(1.6) 14kg",3000],
      ["2\" 50x50(1.2) 11kg",4000],["2\" 50x50(1.6) 15kg",3000],["2\" 50x50(2.0) 18kg",3000],
      ["2\" 50x50(2.5) 23kg",3000],["2\" 50x50(2.9) 26kg",3000],["2.5\" 60x60(1.6) 17kg",3800],
      ["2.5\" 60x60(2.0) 22kg",3300],["2.5\" 60x60(2.5)28kg",3300],["3\" 72x72(1.6) 21kg",5000],
      ["3\" 72x72(2.0) 27kg",4000],["3\" 72x72(2.5) 33kg",4000],["3\" 72x72(2.9) 39kg",4000],
      ["1.5\"x 0.75\" 40x20 (1.2)7kg",4900],["1.5\"x 0.75\" 40x20 (1.6) 9kg",3900],
      ["1.5\"x 0.75\" 40x20 (2.0) 11kg",3900],["1.5\"x 0.75\" 40x20 (2.5) 15kg",3900],
      ["2\"x1\" 50x25 (1.2) 8.5kg",4000],["2\"x1\" 50x25 (1.6) 11kg",3000],["2\"x1\" 50x25 (2.0) 13kg",3000],
      ["2\"x1\" 50x25 (2.5) 18kg",3000],["2\"x1\" 50x25 (2.9) 21kg",3000],["60x40 (1.2) 10kg",4000],
      ["60x40 (1.6) 14kg",3000],["60x40 (2.0) 17kg",3000],["60x40 (2.5) 23kg",3000],["60x40 (2.9) 27kg",3000],
      ["75x25 (1.2) 10kg",4000],["75x25 (1.6) 14kg",3000],["75x25 (2.0) 17kg",3000],["75x25 (2.5) 22kg",3000],
      ["75x25 (1.2) 25kg",3000],["80x40 (1.6) 17kg",3800],["80x40 (2.0) 22kg",3300],["80x40 (2.5) 28kg",3300],
      ["80x40 (2.9) 31kg",3300],["96x48 (1.6) 21kg",5000],["96x48 (2.0) 27kg",4000],["96x48 (2.5) 33kg",4000],
      ["96x48 (2.9) 39kg",4000]
    ],
    "MS Angle": [
      ["25x3 (6.2 kg)",7800],["25x5 (10.5 kg)",7500],["32x3 (8 kg )",7500],["35x3 (10.6)",7800],
      ["35x4 (12kg)",7500],["35x5 (14.5kg)",7200],["40x4 (14kg)",7500],["40x5 (18kg)",7000],
      ["50x4 (17.5kg)",7500],["50x5 (21.5kg)",6400],["50x6 (26.6kg)",6100],["65x5(28.5 kg)",6400],
      ["65x6(34.5)",6100],["75x5",6400]
    ],
    "MS Channel": [
      ["C 75*40 (3\"X1.5\") 36KG",6400],["C 70*35 (3\"X1.5\") 22KG",7200],
      ["C 100*50 (4\"x 2\") 56KG",6100],["C 95x45 (4\"x2\") 36kg",7200]
    ],
    "Binding Wire": [["BW 18G Random",0],["BW 18G 10Kg",2500],["BW 18G 25Kg",0],["BW 20G 10Kg",3500],["BW 20G 25Kg",0]],
    "Nails": [["Nails 2\"",0],["Nails 2.5\"",0],["Nails 3\"",0]],
    "Sqr Bar": [["8mm",1500],["10mm",0],["12mm",0]],
    "Round Bar": [["8mm",0],["10mm",0],["12mm",0],["16mm",0]],
    "Flats": [["F 20x5",0],["F 25x3",0],["F 25x5",0],["F 32x5",0],["F 40x3",0],["F 40x5",0],["F 40x6",0],["F 50x5",0],["F 50x6",0]],
    "HR Pipe": [
      // SD 500
      ["1.25\" 41 OD (2.0) 8.8kg", 500],
      ["1.5\" 48.3 OD (2.0) 12.9kg", 500],
      ["2.0\" 60.3OD (2.0) 17.5kg", 500],
      ["4\" 114.3 OD (2.0) 33.8kg", 500],
      ["0.75\"x0.75\" 19X19 (2.0) 6.91kg", 500],
      ["1\" 25X25 (2.0) 8.9kg", 500],
      ["1.25\" 32X32 (2.0) 11.48kg", 500],
      ["1.5\" 38X38 (2.0) 13.8kg", 500],
      ["2\" 50X50 (2.0) 18.4kg", 500],
      ["2.5\" 60X60 (2.0) 22.3kg", 500],
      ["3\" 72X72 (2.0) 26.8kg", 500],
      ["4\" 100X100 (2.0) 37.5kg", 500],
      ["2\"x1\" 50X25 (2.0) 13.98kg", 500],
      ["2.5\"x1.5\" 60x40 (2.0) kg", 500],
      ["4\"x2\" 96X48 (2.0) 22.2kg", 500],
      ["1.25\" 41 OD (2.3) 10.38kg", 500],
      ["1.5\" 48.3 OD (2.3) 15.91kg", 500],
      ["2.0\" 60.3OD (2.3) 20.05kg", 500],
      ["4\" 114.3 OD (2.3) 38.73kg", 500],
      ["0.75\"x0.75\" 19X19 (2.3) 7.35kg", 500],
      ["1\" 25X25 (2.3) 9.99kg", 500],
      ["1.25\" 32X32 (2.3) 13.08kg", 500],
      ["1.5\" 38X38 (2.3) 15.72kg", 500],
      ["2\" 50X50 (2.3) 21kg", 500],
      ["2.5\" 60X60 (2.3) 25.4kg", 500],
      ["3\" 72X72 (2.3) 60.69kg", 500],
      ["4\" 100X100 (2.3) 43kg", 500],
      ["2\"x1\" 50X25 (2.3) 15.3kg", 500],
      ["2.5\"x1.5\" 60x40 (2.3) kg", 500],
      ["1\"x1.5\" 80X40 (2.3) 25.6kg", 500],
      ["4\"x2\" 96X48 (2.3) 30.69kg", 500],
      // SD 1500
      ["5\" 139.7 OD (2.0) 41.4kg", 1500],
      ["6\" 165.1 OD (2.0) 48.2kg", 1500],
      ["6\" 150X150 (2.0) 56.66kg", 1500],
      ["5\"X2.5 122X62 (2.0) 34.5kg", 1500],
      ["6\"X3\" 150X75 (2.0) 42.3kg", 1500],
      ["6\"X4\" 145X82 (2.0) 42.68kg", 1500],
      ["8\"X4\" 200X100 (2.0) 56.66kg", 1500],
      ["5\" 139.7 OD (2.3) 47.51kg", 1500],
      ["6\" 165.1 OD (2.3) 56.29kg", 1500],
      ["6\" 150X150 (2.3) 85.03kg", 1500],
      ["5\"X2.5 122X62 (2.3) 39.49kg", 1500],
      ["6\"X3\" 150X75 (2.3) 48.52kg", 1500],
      ["6\"X4\" 145X82 (2.3) 48.96kg", 1500],
      ["8\"X4\" 200X100 (2.3) 85.03kg", 1500],
      // SD 0
      ["1.25\" 41 OD (2.5) kg", 0],
      ["1.5\" 48.3 OD (2.5) 17.2kg", 0],
      ["2.0\" 60.3OD (2.5) 21.7kg", 0],
      ["4\" 114.3 OD (2.5) 42kg", 0],
      ["0.75\"x0.75\" 19X19 (2.5) 7.9kg", 0],
      ["1\" 25X25 (2.5) 10.8kg", 0],
      ["1.25\" 32X32 (2.5) 14.1kg", 0],
      ["1.5\" 38X38 (2.5) 17kg", 0],
      ["2\" 50X50 (2.5) 22.7kg", 0],
      ["2.5\" 60X60 (2.5) 27.5kg", 0],
      ["3\" 72X72 (2.5) 33.26kg", 0],
      ["4\" 100X100 (2.5) 46.7kg", 0],
      ["2\"x1\" 50X25 (2.5) 16.7kg", 0],
      ["2.5\"x1.5\" 60x40 (2.5) 22.76kg", 0],
      ["1\"x1.5\" 80X40 (2.5) 27.5kg", 0],
      ["4\"x2\" 96X48 (2.5) 33.5kg", 0],
      ["1.25\" 41 OD (2.8) 12.2kg", 0],
      ["1.5\" 48.3 OD (2.8) 19.2kg", 0],
      ["2.0\" 60.3OD (2.8) 24.2kg", 0],
      ["4\" 114.3 OD (2.8) 46.9kg", 0],
      ["0.75\"x0.75\" 19X19 (2.8) 8.88kg", 0],
      ["1\" 25X25 (2.8) 11.9kg", 0],
      ["1.25\" 32X32 (2.8) 15.7kg", 0],
      ["1.5\" 38X38 (2.8) 18.9kg", 0],
      ["2\" 50X50 (2.8) 25.3kg", 0],
      ["2.5\" 60X60 (2.8) 30.7kg", 0],
      ["3\" 72X72 (2.8) 37.09kg", 0],
      ["4\" 100X100 (2.8) 52.1kg", 0],
      ["2\"x1\" 50X25 (2.8) 18.6kg", 0],
      ["2.5\"x1.5\" 60x40 (2.8) kg", 0],
      ["3\"x1.5\" 80X40 (2.8) 30.7kg", 0],
      ["4\"x2\" 96X48 (2.8) 37.09kg", 0],
      ["1.25\" 41 OD (3.0) 13.2kg", 0],
      ["1.5\" 48.3 OD (3.0) 20.4kg", 0],
      ["2.0\" 60.3OD (3.0) 25.8kg", 0],
      ["4\" 114.3 OD (3.0) 50.2kg", 0],
      ["0.75\"x0.75\" 19X19 (3.0) 9.19kg", 0],
      ["1\" 25X25 (3.0) 12.63kg", 0],
      ["1.25\" 32X32 (3.0) 16.7kg", 0],
      ["1.5\" 38X38 (3.0) 20.1kg", 0],
      ["2\" 50X50 (3.0) 27kg", 0],
      ["2.5\" 60X60 (3.0) 32.7kg", 0],
      ["3\" 72X72 (3.0) 39.62kg", 0],
      ["4\" 100X100 (3.0) 55.7kg", 0],
      ["2\"x1\" 50X25 (3.0) 19.81kg", 0],
      ["2.5\"x1.5\" 80x40 (3.0) 30.7kg", 0],
      ["3\"x1.5\" 80X40 (3.0) 32kg", 0],
      ["4\"x2\" 96X48 (3.0) 39.62kg", 0],
      ["1.25\" 41 OD (3.2) 14.2kg", 0],
      ["1.5\" 48.3 OD (3.2) 21.7kg", 0],
      ["2.0\" 60.3OD (3.2) 27.5kg", 0],
      ["4\" 114.3 OD (3.2) 53.3kg", 0],
      ["0.75\"x0.75\" 19X19 (3.2) 9.68kg", 0],
      ["1\" 25X25 (3.2) 13.35kg", 0],
      ["1.25\" 32X32 (3.2) 17.6kg", 0],
      ["1.5\" 38X38 (3.2) 21.3kg", 0],
      ["2\" 50X50 (3.2) 28.7kg", 0],
      ["2.5\" 60X60 (3.2) 34.8kg", 0],
      ["3\" 72X72 (3.2) 42.14kg", 0],
      ["4\" 100X100 (3.2) 59.3kg", 0],
      ["2\"x1\" 50X25 (3.2) 21.01kg", 0],
      ["2.5\"x1.5\" 60x40 (3.2) 32.7kg", 0],
      ["3\"x1.5\" 80X40 (3.2) 32.7kg", 0],
      ["4\"x2\" 96X48 (3.2) 41.7kg", 0],
      ["1.25\" 41 OD (3.5) kg", 0],
      ["1.5\" 48.3 OD (3.5) 23.6kg", 0],
      ["2.0\" 60.3OD (3.5) 29.9kg", 0],
      ["4\" 114.3 OD (3.5) 58.8kg", 0],
      ["0.75\"x0.75\" 19X19 (3.5) 10.38kg", 0],
      ["1\" 25X25 (3.5) 14.4kg", 0],
      ["1.25\" 32X32 (3.5) 19.1kg", 0],
      ["1.5\" 38X38 (3.5) 23.1kg", 0],
      ["2\" 50X50 (3.5) 31.2kg", 0],
      ["2.5\" 60X60 (3.5) 37.9kg", 0],
      ["3\" 72X72 (3.5) 45.89kg", 0],
      ["4\" 100X100 (3.5) 64.7kg", 0],
      ["2\"x1\" 50X25 (3.5) 22.78kg", 0],
      ["2.5\"x1.5\" 60x40 (3.5) 34.8kg", 0],
      ["3\"x1.5\" 80X40 (3.5) 34.8kg", 0],
      ["4\"x2\" 96X48 (3.5) 44.1kg", 0],
      ["1.25\" 41 OD (4.0) kg", 0],
      ["1.5\" 48.3 OD (4.0) 26.6kg", 0],
      ["2.0\" 60.3OD (4.0) 33.9kg", 0],
      ["4\" 114.3 OD (4.0) 64.3kg", 0],
      ["0.75\"x0.75\" 19X19 (4.0) 11.48kg", 0],
      ["1\" 25X25 (4.0) 16.08kg", 0],
      ["1.25\" 32X32 (4.0) 21.4kg", 0],
      ["1.5\" 38X38 (4.0) 26kg", 0],
      ["2\" 50X50 (4.0) 35.2kg", 0],
      ["2.5\" 60X60 (4.0) 42.9kg", 0],
      ["3\" 72X72 (4.0) 52.06kg", 0],
      ["4\" 100X100 (4.0) 73.2kg", 0],
      ["2\"x1\" 50X25 (4.0) 25.65kg", 0],
      ["2.5\"x1.5\" 60x40 (4.0) 37.9kg", 0],
      ["3\"x1.5\" 80X40 (4.0) 37.9kg", 0],
      ["4\"x2\" 96X48 (4.0) 50.1kg", 0],
      ["1.25\" 41 OD (4.2) kg", 0],
      ["1.5\" 48.3 OD (4.2) 27.85kg", 0],
      ["2.0\" 60.3OD (4.2) 35.42kg", 0],
      ["4\" 114.3 OD (4.2) 69.5kg", 0],
      ["0.75\"x0.75\" 19X19 (4.2) 11.9kg", 0],
      ["1\" 25X25 (4.2) 16.72kg", 0],
      ["1.25\" 32X32 (4.2) 22.19kg", 0],
      ["1.5\" 38X38 (4.2) 27.17kg", 0],
      ["2\" 50X50 (4.2) 36.82kg", 0],
      ["2.5\" 60X60 (4.2) 44.86kg", 0],
      ["3\" 72X72 (4.2) 54.51kg", 0],
      ["4\" 100X100 (4.2) kg", 0],
      ["2\"x1\" 50X25 (4.2) 26.77kg", 0],
      ["2.5\"x1.5\" 60x40 (4.2) 44.86kg", 0],
      ["3\"x1.5\" 80X40 (4.2) 44.86kg", 0],
      ["4\"x2\" 96X48 (4.2) 54.51kg", 0],
      ["1.25\" 41 OD (4.3) 28.44kg", 0],
      ["2.0\" 60.3OD (4.3) 36.2kg", 0],
      ["4\" 114.3 OD (4.3) 71.11kg", 0],
      ["0.75\"x0.75\" 19X19 (4.3) 12.1kg", 0],
      ["1\" 25X25 (4.3) 17.04kg", 0],
      ["1.25\" 32X32 (4.3) 22.62kg", 0],
      ["1.5\" 38X38 (4.3) 27.74kg", 0],
      ["2\" 50X50 (4.3) 37.63kg", 0],
      ["2.5\" 60X60 (4.3) 45.85kg", 0],
      ["3\" 72X72 (4.3) 55.72kg", 0],
      ["4\" 100X100 (4.3) kg", 0],
      ["2\"x1\" 50X25 (4.3) 27.31kg", 0],
      ["2.5\"x1.5\" 60x40 (4.3) 45.85kg", 0],
      ["3\"x1.5\" 80X40 (4.3) 45.85kg", 0],
      ["4\"x2\" 96X48 (4.3) 55.72kg", 0],
      ["1.25\" 41 OD (4.5) kg", 0],
      ["1.5\" 48.3 OD (4.5) kg", 0],
      ["2.0\" 60.3OD (4.5) kg", 0],
      ["4\" 114.3 OD (4.5) kg", 0],
      ["0.75\"x0.75\" 19X19 (4.5) kg", 0],
      ["1\" 25X25 (4.5) kg", 0],
      ["1.25\" 32X32 (4.5) kg", 0],
      ["1.5\" 38X38 (4.5) kg", 0],
      ["2\" 50X50 (4.5) kg", 0],
      ["2.5\" 60X60 (4.5) kg", 0],
      ["3\" 72X72 (4.5) kg", 0],
      ["4\" 100X100 (4.5) kg", 0],
      ["2\"x1\" 50X25 (4.5) kg", 0],
      ["2.5\"x1.5\" 60x40 (4.5) kg", 0],
      ["3\"x1.5\" 80X40 (4.5) kg", 0],
      ["4\"x2\" 96X48 (4.5) 58.14kg", 0],
      ["1.25\" 41 OD (4.8) kg", 0],
      ["1.5\" 48.3 OD (4.8) kg", 0],
      ["2.0\" 60.3OD (4.8) kg", 0],
      ["4\" 114.3 OD (4.8) kg", 0],
      ["0.75\"x0.75\" 19X19 (4.8) kg", 0],
      ["1\" 25X25 (4.8) kg", 0],
      ["1.25\" 32X32 (4.8) kg", 0],
      ["1.5\" 38X38 (4.8) kg", 0],
      ["2\" 50X50 (4.8) kg", 0],
      ["2.5\" 60X60 (4.8) kg", 0],
      ["3\" 72X72 (4.8) kg", 0],
      ["4\" 100X100 (4.8) 87.47kg", 0],
      ["2\"x1\" 50X25 (4.8) kg", 0],
      ["2.5\"x1.5\" 60x40 (4.8) kg", 0],
      ["3\"x1.5\" 80X40 (4.8) kg", 0],
      ["4\"x2\" 96X48 (4.8) kg", 0],
      ["1.25\" 41 OD (5.5) 23.3kg", 0],
      ["1.5\" 48.3 OD (5.5) 25.9kg", 0],
      ["2.0\" 60.3OD (5.5) 45.31kg", 0],
      ["4\" 114.3 OD (5.5) 89.96kg", 0],
      ["0.75\"x0.75\" 19X19 (5.5) 14.21kg", 0],
      ["1\" 25X25 (5.5) 20.53kg", 0],
      ["1.25\" 32X32 (5.5) 27.9kg", 0],
      ["1.5\" 38X38 (5.5) 34.22kg", 0],
      ["2\" 50X50 (5.5) 46.86kg", 0],
      ["2.5\" 60X60 (5.5) 57.38kg", 0],
      ["3\" 72X72 (5.5) 70.01kg", 0],
      ["4\" 100X100 (5.5) 99.49kg", 0],
      ["2\"x1\" 50X25 (5.5) 33.69kg", 0],
      ["2.5\"x1.5\" 60x40 (5.5) 57.38kg", 0],
      ["3\"x1.5\" 80X40 (5.5) 57.38kg", 0],
      ["4\"x2\" 96X48 (5.5) 70.01kg", 0],
      ["1.25\" 41 OD (6.0) kg", 0],
      ["1.5\" 48.3 OD (6.0) 38.16kg", 0],
      ["2.0\" 60.3OD (6.0) 48.96kg", 0],
      ["4\" 114.3 OD (6.0) 97.69kg", 0],
      ["0.75\"x0.75\" 19X19 (6.0) 14.93kg", 0],
      ["1\" 25X25 (6.0) 21.82kg", 0],
      ["1.25\" 32X32 (6.0) 29.86kg", 0],
      ["1.5\" 38X38 (6.0) 36.75kg", 0],
      ["2\" 50X50 (6.0) 50.52kg", 0],
      ["2.5\" 60X60 (6.0) 62.02kg", 0],
      ["3\" 72X72 (6.0) 75.8kg", 0],
      ["4\" 100X100 (6.0) 107.86kg", 0],
      ["2\"x1\" 50X25 (6.0) 36.18kg", 0],
      ["2.5\"x1.5\" 60x40 (6.0) 62.02kg", 0],
      ["3\"x1.5\" 80X40 (6.0) 62.02kg", 0],
      ["4\"x2\" 96X48 (6.0) 75.8kg", 0],
      // SD 1000
      ["6\" 165.1 OD (2.5) 51.6kg", 1000],
      ["6\" 150X150 (2.5) 80.1kg", 1000],
      ["6\" 150X150 (2.5) 70.6kg", 1000],
      ["5\"X2.5 122X62 (2.5) 43.6kg", 1000],
      ["6\"X3\" 150X75 (2.5) 52.8kg", 1000],
      ["6\"X4\" 145X82 (2.5) 53.3kg", 1000],
      ["8\"X4\" 200X100 (2.5) 70.98kg", 1000],
      ["5\" 139.7 OD (2.8) 57.6kg", 1000],
      ["6\" 165.1 OD (2.8) 68.32kg", 1000],
      ["6\" 150X150 (2.8) 78.9kg", 1000],
      ["5\"X2.5 122X62 (2.8) 48.8kg", 1000],
      ["6\"X3\" 150X75 (2.8) 58.8kg", 1000],
      ["6\"X4\" 145X82 (2.8) 59.3kg", 1000],
      ["8\"X4\" 200X100 (2.8) 78.89kg", 1000],
      ["5\" 139.7 OD (3.0) 61.5kg", 1000],
      ["6\" 165.1 OD (3.0) 68.32kg", 1000],
      ["6\" 150X150 (3.0) 78.9kg", 1000],
      ["5\"X2.5 122X62 (3.0) 48.8kg", 1000],
      ["6\"X3\" 150X75 (3.0) 58.8kg", 1000],
      ["6\"X4\" 145X82 (3.0) 59.3kg", 1000],
      ["8\"X4\" 200X100 (3.0) 78.89kg", 1000],
      ["5\" 139.7 OD (3.2) 65.7kg", 1000],
      ["6\" 165.1 OD (3.2) 75.7kg", 1000],
      ["6\" 150X150 (3.2) 89.9kg", 1000],
      ["5\"X2.5 122X62 (3.2) 55.3kg", 1000],
      ["6\"X3\" 150X75 (3.2) 67kg", 1000],
      ["6\"X4\" 145X82 (3.2) 97.9kg", 1000],
      ["8\"X4\" 200X100 (3.2) 89.92kg", 1000],
      ["5\" 139.7 OD (3.5) 71.7kg", 1000],
      ["6\" 165.1 OD (3.5) 83.6kg", 1000],
      ["6\" 150X150 (3.5) 98.2kg", 1000],
      ["5\"X2.5 122X62 (3.5) 60.9kg", 1000],
      ["6\"X3\" 150X75 (3.5) 73.7kg", 1000],
      ["6\"X4\" 145X82 (3.5) 73.7kg", 1000],
      ["8\"X4\" 200X100 (3.5) 98.15kg", 1000],
      ["5\" 139.7 OD (4.0) 81.6kg", 1000],
      ["6\" 165.1 OD (4.0) 95.3kg", 1000],
      ["6\" 150X150 (4.0) 111.8kg", 1000],
      ["5\"X2.5 122X62 (4.0) 68.5kg", 1000],
      ["6\"X3\" 150X75 (4.0) 83.1kg", 1000],
      ["6\"X4\" 145X82 (4.0) 83.8kg", 1000],
      ["8\"X4\" 200X100 (4.0) 111.79kg", 1000],
      ["5\" 139.7 OD (4.2) 85.6kg", 1000],
      ["6\" 165.1 OD (4.2) 101.6kg", 1000],
      ["6\" 150X150 (4.2) 117.2kg", 1000],
      ["5\"X2.5 122X62 (4.2) 71.81kg", 1000],
      ["6\"X3\" 150X75 (4.2) 87.1kg", 1000],
      ["6\"X4\" 145X82 (4.2) kg", 1000],
      ["8\"X4\" 200X100 (4.2) 117.21kg", 1000],
      ["5\" 139.7 OD (4.3) 87.91kg", 1000],
      ["6\" 165.1 OD (4.3) 103.91kg", 1000],
      ["6\" 150X150 (4.3) 119.52kg", 1000],
      ["5\"X2.5 122X62 (4.3) 72.18kg", 1000],
      ["6\"X3\" 150X75 (4.3) 89.06kg", 1000],
      ["6\"X4\" 145X82 (4.3) 89.88kg", 1000],
      ["8\"X4\" 200X100 (4.3) 120kg", 1000],
      ["5\" 139.7 OD (4.5) kg", 1000],
      ["6\" 165.1 OD (4.5) kg", 1000],
      ["6\" 150X150 (4.5) 125.41kg", 1000],
      ["5\"X2.5 122X62 (4.5) kg", 1000],
      ["6\"X3\" 150X75 (4.5) kg", 1000],
      ["6\"X4\" 145X82 (4.5) 91.89kg", 1000],
      ["8\"X4\" 200X100 (4.5) 126kg", 1000],
      ["5\" 139.7 OD (4.8) kg", 1000],
      ["6\" 165.1 OD (4.8) kg", 1000],
      ["6\" 150X150 (4.8) 133.4kg", 1000],
      ["5\"X2.5 122X62 (4.8) kg", 1000],
      ["6\"X3\" 150X75 (4.8) kg", 1000],
      ["6\"X4\" 145X82 (4.8) kg", 1000],
      ["8\"X4\" 200X100 (4.8) kg", 1000],
      ["5\" 139.7 OD (5.5) 110.96kg", 1000],
      ["6\" 165.1 OD (5.5) 131.97kg", 1000],
      ["6\" 150X150 (5.5) 152.13kg", 1000],
      ["5\"X2.5 122X62 (5.5) 93.07kg", 1000],
      ["6\"X3\" 150X75 (5.5) 112.83kg", 1000],
      ["6\"X4\" 145X82 (5.5) 112.17kg", 1000],
      ["8\"X4\" 200X100 (5.5) 152.13kg", 1000],
      ["5\" 139.7 OD (6.0) 120.6kg", 1000],
      ["6\" 165.1 OD (6.0) 143.51kg", 1000],
      ["6\" 150X150 (6.0) 165.58kg", 1000],
      ["5\"X2.5 122X62 (6.0) 98.77kg", 1000],
      ["6\"X3\" 150X75 (6.0) 122.81kg", 1000],
      ["6\"X4\" 145X82 (6.0) 123.46kg", 1000],
      ["8\"X4\" 200X100 (6.0) 165.58kg", 1000]
    ],
    "MS Structure ISMC": [["MS Channel 125x65 -13.1kg/mtr",0],["MS Channel 150x75 -26.8kg/mtr",0],["MS Channel 200x75 -22.3kg/mtr",1100],["MS Channel 250x82 -34kg/mtr",2000],["MS Channel 300x90 -36kg/mtr",3500]],
    "Heavy Structure ISMB": [["Beam 125x70 13.3kg/mtr",0],["Beam 150x75 -15kg/mtr",0],["Beam 175x85 -19.5kg/mtr",0],["Beam 200x100 -24.2kg/mtr",500],["Beam 250x125 -37.3kg/mtr",1300]]
  };

  // Convert to FAST LOOKUP MAP + size arrays for datalist
  const SIZE_SD_MAP = Object.create(null);
  const SIZE_KEYS = Object.create(null);
  for (const [item, list] of Object.entries(SIZE_SD_LIST)){
    const m = Object.create(null);
    const keys = [];
    for (const [size, sdRaw] of list){
      const sd = Number.isFinite(+sdRaw) ? +sdRaw : 0;
      const k = String(size || "").trim();
      if (!k) continue;
      m[k] = sd;
      keys.push(k);
    }
    SIZE_SD_MAP[item] = m;
    SIZE_KEYS[item] = keys;
  }

  // =========================
  // DOM
  // =========================
  const orderDate = document.getElementById("orderDate");
  const TODAY = new Date().toISOString().slice(0,10);
  orderDate.max = TODAY;      // disable future dates
  orderDate.value = TODAY;    // default today

  const form = document.getElementById("doForm");

  const itemRatesBody = document.getElementById("itemRatesBody");
  const itemRateRowTpl = document.getElementById("itemRateRowTpl");

  const itemsBody = document.getElementById("itemsBody");
  const itemRowTpl = document.getElementById("itemRowTpl");

  const totalQtyText = document.getElementById("totalQtyText");

  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");

  const sumTotalQty = document.getElementById("sumTotalQty");
  const sumItems = document.getElementById("sumItems");
  const sumStatus = document.getElementById("sumStatus");
  const sumSavedAt = document.getElementById("sumSavedAt");

  const resumeBanner = document.getElementById("resumeBanner");
  const resumeMeta = document.getElementById("resumeMeta");
  const resumeYes = document.getElementById("resumeYes");
  const resumeNo = document.getElementById("resumeNo");

  const toast = document.getElementById("toast");
  const toastText = document.getElementById("toastText");
  const toastUndo = document.getElementById("toastUndo");
  let lastDeleted = null;
  let toastTimer = null;

  const printText = document.getElementById("printText");

  const STORAGE_KEY = "steelMart.deliveryOrder.v13_freight_label_only_left";
  let suppressSave = false;

  // =========================
  // Helpers
  // =========================
  function fmtTime(ts){
    try{
      const d = new Date(ts);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch(_){ return "‚Äî"; }
  }

  function setStatus(kind, label){
    statusText.textContent = label;
    sumStatus.textContent = label;
    statusDot.classList.remove("warn","danger");
    if (kind === "warn") statusDot.classList.add("warn");
    if (kind === "danger") statusDot.classList.add("danger");
  }

  function showToast(message, undoFn){
    toastText.textContent = message;
    toast.classList.add("show");
    lastDeleted = undoFn || null;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
      toast.classList.remove("show");
      lastDeleted = null;
    }, 4500);
  }
  toastUndo.addEventListener("click", () => {
    if (lastDeleted) lastDeleted();
    toast.classList.remove("show");
    lastDeleted = null;
  });

  function setErr(id, msg){
    const p = document.getElementById("err-" + id);
    if (p) p.textContent = msg || "";
  }

  // Freight: blank / Included / any text -> 0, number -> that number
  function getFreightNumber(){
    const raw = (document.getElementById("freight")?.value || "").trim();
    const n = parseFloat(raw);
    return Number.isFinite(n) ? n : 0;
  }

  // =========================
  // WhatsApp / Print text builder
  // =========================
  function buildWhatsAppText(){
    const data = collectData();
    // Reusing existing text logic just for copy summary
    const clean = v => { const s = String(v ?? "").trim(); return (!s || s === "-" || s === "‚Äî") ? "" : s; };
    const dealer = clean(data.dealerName);
    const date = clean(data.orderDate);
    
    // ... Simplified builder for clipboard copy ...
    let out = [`${dealer} ‚Äì MS Delivery Order`, `Date: ${date}`];
    return out.join("\n"); 
  }
  
  // =========================
  // PRINT LAYOUT RENDERER
  // =========================
  function renderPrintTable() {
    const data = collectData();
    
    // 1. Populate Header Fields
    document.getElementById("p-dealerName").textContent = data.dealerName;
    document.getElementById("p-billingName").textContent = data.billingName;
    document.getElementById("p-billingAddress").textContent = data.billingAddress;
    document.getElementById("p-dispatchAddress").textContent = data.dispatchAddress;
    
    // Dates & Freight
    const dateStr = data.orderDate ? new Date(data.orderDate).toLocaleDateString("en-GB") : "";
    document.getElementById("p-date").textContent = dateStr;
    document.getElementById("p-freight").textContent = data.freight;
    document.getElementById("p-lorry").textContent = data.lorryNo;
    
    // 2. Handle Item/Sauda Header (Takes the first one found)
    const firstRate = data.itemRates && data.itemRates[0] ? data.itemRates[0] : {};
    document.getElementById("p-mainItem").textContent = firstRate.item || "";
    document.getElementById("p-saudaRate").textContent = firstRate.sauda || "";
    document.getElementById("p-ob").textContent = firstRate.ob || "";

    // 3. Populate Items Grid
    const tbody = document.getElementById("p-itemsBody");
    tbody.innerHTML = "";
    
    let totalQty = 0;
    
    data.items.forEach((it, idx) => {
        const tr = document.createElement("tr");
        
        // Sr No
        const tdSr = document.createElement("td");
        tdSr.className = "center";
        tdSr.textContent = idx + 1;
        tr.appendChild(tdSr);
        
        // Size
        const tdSize = document.createElement("td");
        tdSize.textContent = it.size || "";
        tr.appendChild(tdSize);
        
        // Qty
        const qtyNum = parseFloat(it.qty) || 0;
        totalQty += qtyNum;
        const tdQty = document.createElement("td");
        tdQty.className = "center";
        tdQty.textContent = qtyNum > 0 ? qtyNum.toFixed(3) : "";
        tr.appendChild(tdQty);
        
        // Net Rate
        const tdRate = document.createElement("td");
        tdRate.className = "center";
        tdRate.textContent = it.rate || "";
        tr.appendChild(tdRate);
        
        // Break Down
        const tdBd = document.createElement("td");
        tdBd.style.fontSize = "11px"; // Smaller font for breakdown
        tdBd.textContent = it.bd || "";
        tr.appendChild(tdBd);
        
        tbody.appendChild(tr);
    });
    
    // Fill empty rows to make it look like a full page grid if needed
    const MIN_ROWS = 15;
    const currentRows = data.items.length;
    if(currentRows < MIN_ROWS) {
        for(let i=0; i<(MIN_ROWS - currentRows); i++){
            const tr = document.createElement("tr");
            tr.innerHTML = "<td>&nbsp;</td><td></td><td></td><td></td><td></td>";
            tbody.appendChild(tr);
        }
    }
    
    // 4. Footer Totals
    document.getElementById("p-totalQty").textContent = totalQty.toFixed(3);
    document.getElementById("p-finalQty").textContent = totalQty.toFixed(3);
    
    // 5. Notes & Signatures
    document.getElementById("p-note").textContent = data.note;
    document.getElementById("p-signedBy").textContent = data.signedBy;
    document.getElementById("p-approvedBy").textContent = data.approvedBy;
  }


  // =========================
  // Item rates
  // =========================
  function buildItemSelect(selectEl, current=""){
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "Select Item";
    selectEl.appendChild(opt0);

    for (const it of ITEM_LIST){
      const o = document.createElement("option");
      o.value = it; o.textContent = it;
      selectEl.appendChild(o);
    }
    selectEl.value = current || "";
  }

  function renumberItemRates(){
    Array.from(itemRatesBody.querySelectorAll("tr")).forEach((tr, i) => {
      tr.querySelector(".ir-sr").textContent = String(i + 1);
    });
  }

  function collectItemRates(){
    return Array.from(itemRatesBody.querySelectorAll("tr")).map(tr => ({
      item: tr.querySelector(".ir-item")?.value || "",
      billType: tr.querySelector(".ir-billtype")?.value || "BILL",
      sauda: tr.querySelector(".ir-sauda")?.value || "",
      ob: tr.querySelector(".ir-ob")?.value || ""
    }));
  }

  function getRateMetaForItem(item){
    const rates = collectItemRates();
    const hit = rates.find(r => (r.item||"").trim() === item);
    if (!hit) return null;

    const sauda = parseFloat(hit?.sauda);
    const ob = parseFloat(hit?.ob);
    return {
      billType: (hit?.billType || "BILL").toUpperCase(),
      sauda: Number.isFinite(sauda) ? sauda : null,
      ob: Number.isFinite(ob) ? ob : 0 // stored only (not used in formula)
    };
  }

  function addItemRateRow(prefill=null){
    const node = itemRateRowTpl.content.cloneNode(true);
    const tr = node.querySelector("tr");
    const sel = tr.querySelector(".ir-item");
    buildItemSelect(sel, prefill?.item || "");

    tr.querySelector(".ir-billtype").value = (prefill?.billType || "BILL").toUpperCase();
    tr.querySelector(".ir-sauda").value = prefill?.sauda || "";
    tr.querySelector(".ir-ob").value = prefill?.ob || "";

    itemRatesBody.appendChild(tr);
    renumberItemRates();
  }

  function syncLineItemSelects(){
    const allowed = collectItemRates()
      .map(r => (r.item||"").trim())
      .filter(Boolean);

    for (const tr of itemsBody.querySelectorAll("tr")){
      const sel = tr.querySelector(".rowItem");
      const current = sel?.value || "";

      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = ""; opt0.textContent = allowed.length ? "Select Item" : "Add Item above";
      sel.appendChild(opt0);

      for (const it of allowed){
        const o = document.createElement("option");
        o.value = it; o.textContent = it;
        sel.appendChild(o);
      }

      sel.value = allowed.includes(current) ? current : "";
      rebuildSizeFieldForRow(tr);
      recalcRow(tr);
    }
  }

  // =========================
  // Size: searchable input (datalist)
  // =========================
  function getSD(item, size){
    const m = SIZE_SD_MAP[item];
    if (!m) return 0;
    const key = String(size || "").trim();
    const v = m[key];
    return Number.isFinite(+v) ? +v : 0;
  }

  function makeSizeField(item, currentValue=""){
    const sizes = SIZE_KEYS[item] || null;

    const wrap = document.createElement("div");
    wrap.style.display = "grid";
    wrap.style.gap = "6px";

    const inp = document.createElement("input");
    inp.className = "size mini";
    inp.type = "text";
    inp.placeholder = sizes && sizes.length ? "Type to search size‚Ä¶" : "Enter size";
    inp.value = currentValue || "";

    if (sizes && sizes.length){
      const listId = "dl_" + Math.random().toString(36).slice(2);
      inp.setAttribute("list", listId);

      const dl = document.createElement("datalist");
      dl.id = listId;
      for (const s of sizes){
        const opt = document.createElement("option");
        opt.value = s;
        dl.appendChild(opt);
      }
      wrap.appendChild(inp);
      wrap.appendChild(dl);
      return wrap;
    }

    wrap.appendChild(inp);
    return wrap;
  }

  function rebuildSizeFieldForRow(tr){
    const item = (tr.querySelector(".rowItem")?.value || "").trim();
    const sizeCell = tr.querySelector(".sizeCell");
    const existing = tr.querySelector(".size");
    const current = existing?.value || "";
    sizeCell.textContent = "";
    sizeCell.appendChild(makeSizeField(item, current));
  }

  // FINAL FORMULA:
  // BILL: (Sauda + SD + 160 + Freight) √ó 1.18
  // NC  : (Sauda + SD + 160 - 3000 + Freight) √ó 1.18
  function calcNetRate(meta, item, size){
    const sauda = meta?.sauda;
    if (!Number.isFinite(sauda) || sauda <= 0) return { rate:"", bd:"Enter Sauda Rate for this Item" };

    const sd = getSD(item, size);
    const isNC = (meta?.billType === "NC");
    const freight = getFreightNumber();

    const base = sauda + sd + 160 - (isNC ? 3000 : 0) + freight;
    const finalRate = Math.round(base * 1.18);
    const bd = `${sauda} + ${sd} + 160${isNC ? " - 3000" : ""} + Freight ${freight} + 18%`;

    return { rate: finalRate, bd };
  }

  function recalcRow(tr){
    const item = (tr.querySelector(".rowItem")?.value || "").trim();
    const sizeVal = (tr.querySelector(".size")?.value || "").trim();
    const rateEl = tr.querySelector(".rate");
    const bdEl = tr.querySelector(".bd");
    if (!rateEl || !bdEl) return;

    if (!item || !sizeVal){
      rateEl.value = "";
      bdEl.value = "";
      return;
    }

    const meta = getRateMetaForItem(item);
    const out = calcNetRate(meta, item, sizeVal);
    rateEl.value = out.rate;
    bdEl.value = out.bd;
  }

  // =========================
  // Lines table
  // =========================
  function renumberLines(){
    Array.from(itemsBody.querySelectorAll("tr")).forEach((tr, i) => {
      tr.querySelector(".sr").textContent = String(i + 1);
    });
    sumItems.textContent = String(itemsBody.querySelectorAll("tr").length);
  }

  function recalcTotals(){
    let total = 0;
    for (const tr of itemsBody.querySelectorAll("tr")){
      const v = parseFloat(tr.querySelector(".qty")?.value || "");
      if (Number.isFinite(v)) total += v;
    }
    const shown = total > 0 ? total.toFixed(3) : "‚Äî";
    totalQtyText.textContent = shown;
    sumTotalQty.textContent = shown;
  }

  function addLine(prefill=null){
    const node = itemRowTpl.content.cloneNode(true);
    const tr = node.querySelector("tr");

    const sel = tr.querySelector(".rowItem");
    const allowed = collectItemRates().map(r => (r.item||"").trim()).filter(Boolean);
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = allowed.length ? "Select Item" : "Add Item above";
    sel.appendChild(opt0);
    for (const it of allowed){
      const o = document.createElement("option");
      o.value = it; o.textContent = it;
      sel.appendChild(o);
    }
    sel.value = prefill?.item || "";

    tr.querySelector(".sizeCell").appendChild(makeSizeField(sel.value || "", prefill?.size || ""));
    tr.querySelector(".qty").value = prefill?.qty || "";
    tr.querySelector(".rate").value = prefill?.rate || "";
    tr.querySelector(".bd").value = prefill?.bd || "";
    // REMOVED REMARKS

    itemsBody.appendChild(tr);
    renumberLines();
    recalcRow(tr);
    recalcTotals();
  }

  function duplicateLast(){
    const rows = Array.from(itemsBody.querySelectorAll("tr"));
    if (!rows.length) return addLine();
    const last = rows[rows.length - 1];
    addLine({
      item: last.querySelector(".rowItem")?.value || "",
      size: last.querySelector(".size")?.value || "",
      qty: "",
      rate: last.querySelector(".rate")?.value || "",
      bd: last.querySelector(".bd")?.value || "",
      // REMOVED REMARKS
    });
  }

  // =========================
  // Autosave / Resume
  // =========================
  function collectData(){
    return {
      dealerName: document.getElementById("dealerName").value || "",
      billingName: document.getElementById("billingName").value || "",
      billingAddress: document.getElementById("billingAddress").value || "",
      dispatchAddress: document.getElementById("dispatchAddress").value || "",
      orderDate: document.getElementById("orderDate").value || "",
      freight: document.getElementById("freight").value || "",
      lorryNo: document.getElementById("lorryNo").value || "",
      note: document.getElementById("note").value || "",
      signedBy: document.getElementById("signedBy").value || "",
      approvedBy: document.getElementById("approvedBy").value || "",
      itemRates: collectItemRates(),
      items: Array.from(itemsBody.querySelectorAll("tr")).map(tr => ({
        item: tr.querySelector(".rowItem")?.value || "",
        size: tr.querySelector(".size")?.value || "",
        qty: tr.querySelector(".qty")?.value || "",
        rate: tr.querySelector(".rate")?.value || "",
        bd: tr.querySelector(".bd")?.value || "",
        // REMOVED REMARKS
      }))
    };
  }

  function applyData(data){
    if (!data) return;

    document.getElementById("dealerName").value = data.dealerName || "";
    document.getElementById("billingName").value = data.billingName || "";
    document.getElementById("billingAddress").value = data.billingAddress || "";
    document.getElementById("dispatchAddress").value = data.dispatchAddress || "";

    const d = (data.orderDate || TODAY);
    orderDate.max = TODAY;
    orderDate.value = (d && d <= TODAY) ? d : TODAY;

    document.getElementById("freight").value = data.freight || "";
    document.getElementById("lorryNo").value = data.lorryNo || "";
    document.getElementById("note").value = data.note || "";
    document.getElementById("signedBy").value = data.signedBy || "";
    document.getElementById("approvedBy").value = data.approvedBy || "";

    itemRatesBody.innerHTML = "";
    const ir = Array.isArray(data.itemRates) ? data.itemRates : [];
    if (!ir.length) addItemRateRow(); else ir.forEach(r => addItemRateRow(r));
    renumberItemRates();

    itemsBody.innerHTML = "";
    const lines = Array.isArray(data.items) ? data.items : [];
    if (!lines.length) addLine(); else lines.forEach(l => addLine(l));
    renumberLines();

    syncLineItemSelects();
    recalcTotals();
  }

  function saveDraft(){
    if (suppressSave) return;
    const payload = { savedAt: Date.now(), data: collectData() };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    sumSavedAt.textContent = fmtTime(payload.savedAt);
    setStatus("ok", "Saved");
  }

  function clearDraft(){
    localStorage.removeItem(STORAGE_KEY);
    sumSavedAt.textContent = "‚Äî";
  }

  function showResume(payload){
    resumeMeta.textContent = `Last saved: ${fmtTime(payload.savedAt)}`;
    resumeBanner.classList.add("show");

    resumeYes.onclick = () => {
      resumeBanner.classList.remove("show");
      suppressSave = true;
      applyData(payload.data);
      suppressSave = false;
      setStatus("ok","Resumed");
      saveDraft();
    };

    resumeNo.onclick = () => {
      resumeBanner.classList.remove("show");
      clearDraft();
      setStatus("warn","Draft");
    };
  }

  function checkResume(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try{
      const payload = JSON.parse(raw);
      if (payload?.data) showResume(payload);
    }catch(_){}
  }

  // Debounced save
  let saveTimer = null;
  function saveSoon(){
    clearTimeout(saveTimer);
    setStatus("warn","Saving‚Ä¶");
    saveTimer = setTimeout(saveDraft, 650);
  }

  // =========================
  // Validation
  // =========================
  function validateForm({ forPrint=false } = {}){
    setErr("dealerName","");
    setErr("billingName","");
    setErr("billingAddress","");
    setErr("orderDate","");
    document.getElementById("err-itemRates").textContent = "";

    const data = collectData();
    let issues = [];

    if (!data.dealerName.trim()){ issues.push("Dealer Name is required."); setErr("dealerName","Required"); }
    if (!data.billingName.trim()){ issues.push("Billing Name is required."); setErr("billingName","Required"); }
    if (!data.billingAddress.trim()){ issues.push("Billing Address is required."); setErr("billingAddress","Required"); }
    if (!data.orderDate.trim()){ issues.push("Date is required."); setErr("orderDate","Required"); }

    if (data.orderDate && data.orderDate > TODAY){
      issues.push("Date cannot be in the future.");
      setErr("orderDate","Future date not allowed");
    }

    const hasAnyLine = data.items.some(it => (it.item||"").trim() || (it.size||"").trim() || (it.qty||"").trim());
    if (hasAnyLine){
      const hasAtLeastOneRate = data.itemRates.some(r =>
        (r.item||"").trim() &&
        Number.isFinite(parseFloat(r.sauda)) &&
        parseFloat(r.sauda) > 0
      );

      const validRates = data.itemRates
        .filter(r => (r.item||"").trim())
        .every(r => Number.isFinite(parseFloat(r.sauda)) && parseFloat(r.sauda) > 0);

      if (!hasAtLeastOneRate || !validRates){
        issues.push("Add Item & Sauda Rate (Sauda > 0) in Item & Sauda Rates section.");
        document.getElementById("err-itemRates").textContent = "Add at least 1 Item with Sauda Rate > 0";
      }
    }

    data.items.forEach((it, idx) => {
      const n = idx + 1;
      const item = (it.item||"").trim();
      const size = (it.size||"").trim();
      const qty = parseFloat(it.qty);
      const rate = parseFloat(it.rate);

      // Modified empty check (removed remarks)
      const looksEmpty = !item && !size && !it.qty;
      if (looksEmpty) return;

      if (!item) issues.push(`Line ${n}: Item is required.`);
      if (!size) issues.push(`Line ${n}: Sizes is required.`);
      if (!Number.isFinite(qty) || qty <= 0) issues.push(`Line ${n}: Qty must be > 0.`);
      if (!Number.isFinite(rate) || rate <= 0) issues.push(`Line ${n}: Net Rate missing (check Sauda for Item + enter Sizes).`);
    });

    if (issues.length === 0) setStatus("ok", forPrint ? "Ready to print" : "OK");
    else if (issues.length <= 3) setStatus("warn", `${issues.length} issue${issues.length>1?"s":""}`);
    else setStatus("danger", `${issues.length} issues`);

    return { ok: issues.length === 0, issues };
  }

  // =========================
  // Export / Copy / Print / Reset
  // =========================
  function exportCSV(){
    const data = collectData();
    const lines = [];
    lines.push(["Dealer Name", data.dealerName]);
    lines.push(["Billing Name", data.billingName]);
    lines.push(["Billing Address", data.billingAddress]);
    lines.push(["Dispatch Address", data.dispatchAddress]);
    lines.push(["Date", data.orderDate]);
    lines.push(["Freight", data.freight]);
    lines.push(["Lorry No", data.lorryNo]);
    lines.push([]);
    lines.push(["Item & Sauda Rates"]);
    lines.push(["Item","Bill Type","Sauda Rate","OB"]);
    data.itemRates.forEach(r => {
      const item = (r.item||"").trim();
      const billType = (r.billType||"BILL").trim();
      const sauda = (r.sauda||"").trim();
      const ob = (r.ob||"").trim();
      if (!item && !sauda && !ob) return;
      lines.push([item, billType, sauda, ob]);
    });
    lines.push([]);
    // Removed Remarks from CSV Header
    lines.push(["Sr","Item","Sizes","Qty (MT)","Net Rate","Breakdown"]);
    data.items.forEach((it, i) => {
      const looksEmpty = !(it.item||"").trim() && !(it.size||"").trim() && !(it.qty||"").trim();
      if (looksEmpty) return;
      // Removed remarks from CSV Row
      lines.push([String(i+1), it.item, it.size, it.qty, it.rate, it.bd]);
    });

    const csv = lines.map(row => row.map(cell => {
      const s = (cell ?? "").toString();
      if (s.includes('"') || s.includes(",") || s.includes("\n")) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }).join(",")).join("\n");

    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `SteelMart_DO_${(data.orderDate || "date")}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copySummary(){
    const text = buildWhatsAppText();
    try{
      await navigator.clipboard.writeText(text);
      showToast("Summary copied", null);
    }catch(_){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showToast("Summary copied", null);
    }
  }

  function handlePrint(){
    const v = validateForm({ forPrint:true });
    if (!v.ok){
      const preview = v.issues.slice(0, 8).map(s => "‚Ä¢ " + s).join("\n");
      const more = v.issues.length > 8 ? `\n‚Ä¶ and ${v.issues.length - 8} more.` : "";
      alert("Fix these before printing:\n\n" + preview + more);
      return;
    }
    for (const tr of itemsBody.querySelectorAll("tr")) recalcRow(tr);
    recalcTotals();

    // RENDER TABLE BEFORE PRINTING
    renderPrintTable();
    window.print();
  }

  function handleReset(){
    if (!confirm("Clear all data? (Draft autosave will be cleared)")) return;

    suppressSave = true;
    ["dealerName","billingName","billingAddress","dispatchAddress","freight","lorryNo","note","signedBy","approvedBy"]
      .forEach(id => document.getElementById(id).value = "");

    orderDate.max = TODAY;
    orderDate.value = TODAY;

    itemRatesBody.innerHTML = "";
    itemsBody.innerHTML = "";
    addItemRateRow();
    addLine();

    suppressSave = false;
    clearDraft();
    recalcTotals();
    validateForm();
    setStatus("warn","Draft");
  }

  // =========================
  // Events
  // =========================
  itemRatesBody.addEventListener("change", (e) => {
    if (e.target.classList.contains("ir-item") || e.target.classList.contains("ir-billtype")){
      const tr = e.target.closest("tr");
      const item = tr?.querySelector(".ir-item")?.value || "";

      for (const row of itemsBody.querySelectorAll("tr")){
        if ((row.querySelector(".rowItem")?.value || "") === item) recalcRow(row);
      }

      syncLineItemSelects();
      validateForm();
      saveSoon();
    }
  });

  itemRatesBody.addEventListener("input", (e) => {
    if (e.target.classList.contains("ir-sauda") || e.target.classList.contains("ir-ob")){
      const tr = e.target.closest("tr");
      const item = tr?.querySelector(".ir-item")?.value || "";

      if (e.target.classList.contains("ir-sauda")){
        for (const row of itemsBody.querySelectorAll("tr")){
          if ((row.querySelector(".rowItem")?.value || "") === item) recalcRow(row);
        }
      }

      validateForm();
      saveSoon();
    }
  });

  itemRatesBody.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;

    if (btn.dataset.action === "removeItemRate"){
      const tr = btn.closest("tr");
      if (!tr) return;

      const idx = Array.from(itemRatesBody.children).indexOf(tr);
      const snapshot = collectItemRates()[idx];

      tr.remove();
      renumberItemRates();
      syncLineItemSelects();
      validateForm();
      saveSoon();

      showToast("Item removed", () => {
        addItemRateRow(snapshot);
        renumberItemRates();
        syncLineItemSelects();
        validateForm();
        saveSoon();
      });
    }
  });

  itemsBody.addEventListener("change", (e) => {
    const tr = e.target.closest("tr");
    if (!tr) return;

    if (e.target.classList.contains("rowItem")){
      rebuildSizeFieldForRow(tr);
      recalcRow(tr);
      validateForm();
      saveSoon();
      return;
    }
    if (e.target.classList.contains("size")){
      recalcRow(tr);
      validateForm();
      saveSoon();
      return;
    }
  });

  itemsBody.addEventListener("input", (e) => {
    const tr = e.target.closest("tr");
    if (!tr) return;

    if (e.target.classList.contains("qty")){
      recalcTotals();
      validateForm();
      saveSoon();
      return;
    }
    if (e.target.classList.contains("size")){
      recalcRow(tr);
      validateForm();
      saveSoon();
      return;
    }
  });

  itemsBody.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action]");
    const tr = e.target.closest("tr");
    if (!btn || !tr) return;

    if (btn.dataset.action === "remove") {
      const idx = Array.from(itemsBody.children).indexOf(tr);
      const snapshot = collectData().items[idx];

      tr.remove();
      renumberLines();
      recalcTotals();
      validateForm();
      saveSoon();

      showToast("Line removed", () => {
        addLine(snapshot);
        renumberLines();
        validateForm();
        saveSoon();
      });
    }
  });

  // Freight/Date change -> recalc all rates
  form.addEventListener("input", (e) => {
    if (e.target && (e.target.id === "freight" || e.target.id === "orderDate")){
      for (const tr of itemsBody.querySelectorAll("tr")) recalcRow(tr);
    }
    validateForm();
    saveSoon();
  });

  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;

    const action = btn.dataset.action;
    if (action === "addItemRate"){ addItemRateRow(); renumberItemRates(); syncLineItemSelects(); validateForm(); saveSoon(); }
    if (action === "addLine"){ addLine(); validateForm(); saveSoon(); }
    if (action === "dupLast"){ duplicateLast(); validateForm(); saveSoon(); }
    if (action === "exportCsv"){ exportCSV(); }
    if (action === "copySummary"){ copySummary(); }
    if (action === "print"){ handlePrint(); }
    if (action === "reset"){ handleReset(); }
  });

  window.addEventListener("beforeunload", () => {
    try{ saveDraft(); }catch(_){}
  });

  // =========================
  // Init
  // =========================
  function init(){
    addItemRateRow();
    addLine();
    renumberItemRates();
    renumberLines();
    recalcTotals();
    validateForm();
    setStatus("warn","Draft");
    sumSavedAt.textContent = "‚Äî";
    checkResume();
  }
  init();

  function scrollToFirstError(){
    const err = document.querySelector(".error:not(:empty)");
    if (!err) return;
    const card = err.closest(".card");
    if (card) card.scrollIntoView({ behavior:"smooth", block:"start" });
  }

  const _handlePrint = handlePrint;
  handlePrint = function(){
    const v = validateForm({ forPrint:true });
    if (!v.ok){
      scrollToFirstError();
      const preview = v.issues.slice(0, 8).map(s => "‚Ä¢ " + s).join("\n");
      const more = v.issues.length > 8 ? `\n‚Ä¶ and ${v.issues.length - 8} more.` : "";
      alert("Fix these before printing:\n\n" + preview + more);
      return;
    }
    _handlePrint();
  };

  const savePill = document.getElementById("savePill");
  const _setStatus = setStatus;
  setStatus = function(kind, label){
    _setStatus(kind, label);
    if (!savePill) return;
    savePill.style.transform = (label.includes("Saving")) ? "scale(1.02)" : "scale(1)";
  };
  </script>
</body>
</html>
