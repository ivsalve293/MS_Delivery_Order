<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Steel Mart MS Delivery Order | Smart Dispatch Sheet</title>
  <meta name="theme-color" content="#dc2626" />

  <style>
    /* --- CORE VARIABLES & RESET --- */
    :root{ --bg:#fff5f5; --text:#111827; --muted:#6b7280; --brand:#dc2626; --brand2:#b91c1c; --brand3:#ef4444; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; --radius:16px; --radius2:22px; --shadow-sm: 0 8px 20px rgba(15,23,42,.07); --shadow: 0 16px 44px rgba(15,23,42,.11); --ring: 0 0 0 4px rgba(220,38,38,.22); --ease: cubic-bezier(.2,.8,.2,1); --ease2:cubic-bezier(.16,1,.3,1); --page-max:1320px; --fs-body: 14px; --fs-label: 12px; --fs-h2: 12px; --plx-x: 0px; --plx-y: 0px; }
    *{box-sizing:border-box} html,body{height:100%}
    
    /* --- BACKGROUND & ANIMATION --- */
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); font-size: var(--fs-body); line-height: 1.5; overflow-x:hidden; background: radial-gradient(900px 500px at 10% 0%, rgba(220,38,38,.14), transparent 60%), radial-gradient(700px 500px at 100% 10%, rgba(239,68,68,.10), transparent 55%), radial-gradient(900px 600px at 50% 110%, rgba(220,38,38,.08), transparent 60%), linear-gradient(180deg, #ffffff 0%, var(--bg) 55%, #ffffff 100%); 
    /* Padding bottom for fixed action bar */
    padding-bottom: 100px; }
    
    /* --- LAYOUT & FIXED HEADER --- */
    .wrap{max-width:var(--page-max); margin:0 auto; padding: 94px 14px 20px;}
    
    .topbar{ position: fixed; top: 0; left: 0; right: 0; height: 74px; z-index: 1000; background: rgba(255,255,255,.98); backdrop-filter: blur(14px); border-bottom: 1px solid rgba(220,38,38,.12); }
    .topbar-inner{ max-width:var(--page-max); margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:12px 14px; gap:12px; height: 100%; }
    
    .brand{display:flex;align-items:center;gap:12px;min-width:200px;}
    .logo{ width:44px;height:44px;border-radius:14px; background: linear-gradient(135deg, var(--brand), var(--brand3)); color:white;font-weight:950;display:grid;place-items:center; box-shadow: 0 16px 34px rgba(220,38,38,.24); letter-spacing:.03em; position:relative; overflow:hidden; user-select:none; }
    .brand h1{margin:0;font-size:15px;line-height:1.15;font-weight:950;} .brand p{margin:2px 0 0;font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;font-weight:800;}
    
    /* --- STATUS PILL --- */
    .pill{ display:inline-flex;align-items:center;gap:8px; padding:7px 10px;border-radius:999px; background: rgba(255,255,255,.92); border:1px solid rgba(220,38,38,.14); box-shadow: var(--shadow-sm); font-size:12px;color:var(--muted); white-space:nowrap; margin-left: auto; }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 4px rgba(22,163,74,.12);} .dot.warn{background:var(--warn);box-shadow:0 0 0 4px rgba(245,158,11,.14);} .dot.danger{background:var(--danger);box-shadow:0 0 0 4px rgba(239,68,68,.14);}

    /* --- FIXED BOTTOM ACTION BAR --- */
    .actions-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        border-top: 1px solid rgba(220,38,38,0.1);
        padding: 12px 16px;
        display: flex;
        justify-content: center;
        gap: 12px;
        z-index: 2000;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.06);
    }
    
    @media (max-width: 640px) {
        .actions-bar {
            justify-content: flex-start;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 12px 16px;
        }
        /* Hide scrollbar */
        .actions-bar::-webkit-scrollbar { display: none; }
        .btn { flex-shrink: 0; }
    }

    .btn{ border:1px solid rgba(220,38,38,.14); background:rgba(255,255,255,.92); color:var(--text); padding:10px 18px; border-radius:999px; font-weight:900; font-size:13px; cursor:pointer; transition: transform .16s var(--ease); box-shadow: var(--shadow-sm); display:inline-flex; align-items:center; gap:8px; min-height:42px; user-select:none; white-space: nowrap; position: relative; overflow: hidden; }
    .btn:hover{transform:translateY(-1px);box-shadow: var(--shadow);} .btn:active{transform:translateY(0px) scale(.99);}
    .btn.primary{ border-color:transparent; background: linear-gradient(90deg,var(--brand),var(--brand2)); color:white; box-shadow: 0 18px 44px rgba(220,38,38,.24); }
    .btn.secondary{background: rgba(255,255,255,.92);border-color: rgba(220,38,38,.20);}
    .btn.ghost{background:transparent;box-shadow:none;border-color:rgba(220,38,38,.12);color:#374151;} 
    
    /* RIPPLE ANIMATION STYLES */
    span.ripple { position: absolute; border-radius: 50%; transform: scale(0); animation: ripple 0.6s linear; background-color: rgba(220, 38, 38, 0.2); pointer-events: none; }
    @keyframes ripple { to { transform: scale(4); opacity: 0; } }
    
    /* --- LAYOUT GRID (DESKTOP) --- */
    .layout{ display:grid; grid-template-columns: 1fr 320px; gap:16px; align-items:start; margin-top:16px; } 

    /* --- SIDEBAR --- */
    .sidebar-wrapper { position: sticky; top: 90px; height: fit-content; display: flex; flex-direction: column; gap: 16px; z-index: 100; }
    
    /* --- RESPONSIVE MOBILE STYLES --- */
    @media (max-width: 980px) {
        .layout { display: flex; flex-direction: column; gap: 16px; }
        .sidebar-wrapper { display: contents; }
        #globalSettings { order: -1; width: 100%; margin-bottom: 4px; }
        main { order: 0; width: 100%; }
        .summary.card { order: 1; width: 100%; margin-top: 4px; }
        .pill span#statusText { display: none; }
        .pill { margin-right: 0; }
    }
    
    /* Stack grid fields on very small screens */
    @media (max-width: 600px) {
        .field, .field.span-3 { grid-column: span 12 !important; }
    }

    /* --- GRID & CARDS --- */
    .card{ position:relative; background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.88)); border:1px solid rgba(220,38,38,.14); border-radius: var(--radius2); box-shadow: var(--shadow); padding:16px; overflow: visible !important; transform: translateY(8px); opacity:0; animation: cardIn .45s var(--ease2) forwards; z-index: 1; } @keyframes cardIn{ to{ transform: translateY(0); opacity:1; } }
    .card h2{ margin:0 0 12px; font-size:var(--fs-h2); letter-spacing:.14em; text-transform:uppercase; color:#991b1b; display:flex;align-items:center;gap:10px; font-weight:950; position:relative; z-index:1; }
    .card h2::before{ content:""; width:18px;height:6px;border-radius:99px; background: linear-gradient(90deg,var(--brand), #ff9aa7); box-shadow: 0 10px 18px rgba(220,38,38,.14); flex:0 0 auto; }
    
    .grid{display:grid;grid-template-columns: repeat(12, 1fr);gap:12px;position:relative;z-index:1;}
    .field{grid-column: span 6;} .field.span-12{grid-column: span 12;} .field.span-3{grid-column: span 3;} 
    @media (max-width: 900px){ .field.span-3{grid-column:span 6;} }
    
    /* --- FORM ELEMENTS --- */
    label{ display:flex;align-items:baseline;justify-content:space-between; gap:10px; font-size:var(--fs-label); font-weight:950; color:#374151; margin:2px 0 6px; } label .req{color:var(--danger);font-weight:950;margin-left:8px;}
    input, textarea, select{ width:100%; border:1px solid rgba(220,38,38,.16); background: rgba(255,255,255,.94); border-radius:14px; padding:11px 12px; font-size:13px; transition: all .16s var(--ease); }
    input:focus, textarea:focus, select:focus{ outline:none; border-color:rgba(220,38,38,.46); box-shadow:var(--ring); background:#fff; transform: translateY(-1px); }
    input[readonly]{background:#fff1f2;color:#6b7280;}
    .net-rate-input { background-color: #f0fdf4 !important; border-color: rgba(22, 163, 74, 0.3); color: #166534; font-weight: 700; }
    .error{margin:6px 0 0;font-size:12px;color:var(--danger);min-height:16px}
    
    .global-settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 18px; background: #fff1f2; border: 1px dashed rgba(220,38,38,.28); border-radius: 18px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    #globalSettings .field { grid-column: span 2; }
    #globalSettings .field:nth-child(3), #globalSettings .field:nth-child(4) { grid-column: span 1; }

    .bill-switch-global{ display:flex; background:#fff; padding:3px; border-radius: 12px; border: 1px solid rgba(220,38,38,.16); width:100%; height:42px; overflow:hidden; }
    .bill-switch-global label{ flex:1; margin:0; text-align:center; font-size:13px; font-weight:800; color:#64748b; cursor:pointer; display:flex;align-items:center;justify-content:center; }
    .bill-switch-global input[type="radio"]{display:none;} .bill-switch-global span{ width:100%;height:100%; display:flex;align-items:center;justify-content:center; border-radius: 9px; transition: all .2s var(--ease); }
    .bill-switch-global input[type="radio"]:checked + span{ background: var(--brand); color:white; box-shadow: 0 2px 8px rgba(220,38,38,.25); }
    
    .summary{ border:1px solid rgba(220,38,38,.20); background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,245,245,.92)); } 
    .kv{ display:flex;align-items:center;justify-content:space-between; padding:12px 0; border-bottom:1px dashed rgba(220,38,38,.18); } .kv strong{ font-family: monospace; font-size:13px; color:#991b1b; padding:6px 10px; border-radius:12px; background: rgba(220,38,38,.06); border:1px solid rgba(220,38,38,.10); }
    
    .toast{ position:fixed;left:50%;bottom:90px; /* Above mobile bar */ transform:translateX(-50%) translateY(10px); background:rgba(17,24,39,.92);color:white; padding:10px 12px;border-radius:999px; display:none;gap:10px;align-items:center;z-index:3000; box-shadow:0 22px 70px rgba(15,23,42,.35); font-size:13px; opacity:0; transition: opacity .28s var(--ease2), transform .28s var(--ease2); } .toast.show{display:flex; opacity:1; transform:translateX(-50%) translateY(0)}

    /* --- ITEM BLOCKS --- */
    .item-block{ border: 1px solid rgba(220,38,38,.2); border-radius: 18px; background: white; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); overflow: hidden; animation: fadeIn 0.3s ease forwards; }
    .block-header{ background: linear-gradient(to right, #fff5f5, #fff); padding: 12px 16px; border-bottom: 1px solid rgba(220,38,38,.1); display:flex; gap: 14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .block-inputs{ display:flex; gap: 12px; flex: 1; min-width: 300px; align-items:flex-start; flex-wrap:wrap; }
    .item-select-wrap{flex: 2; min-width: 220px;} .rate-input-wrap{flex: 1; min-width: 150px; max-width: 190px;} .balance-input-wrap{flex: 1; min-width: 150px; max-width: 190px;}
    .block-summary{ font-size: 12px; color: var(--muted); font-weight: 700; padding-top: 28px; white-space: nowrap; margin-right: auto; }
    .block-error{ width:100%; margin-top:6px; font-size:12px; color: var(--danger); min-height:16px; }
    .block-body{padding:0;background:#fff;} .size-table{width:100%; border-collapse: collapse;}
    .size-table th{ font-size: 11px; text-transform: uppercase; color: #6b7280; text-align:left; padding: 8px 16px; border-bottom: 1px solid #eee; background: #fafafa; } .size-table td{padding: 8px 16px; vertical-align: top; border-bottom: 1px solid #f9fafb;}
    .row-actions{ display:flex; gap:8px; padding: 12px 16px; background:#fafafa; border-top: 1px solid #eee; justify-content:flex-start; }
    .icon-btn{ width: 32px; height: 32px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #ef4444; display:grid; place-items:center; cursor:pointer; flex: 0 0 auto; position: relative; overflow: hidden;} .icon-btn:hover{background:#fef2f2;}
    
    /* --- LOADER --- */
    #loaderOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .spinner { width: 50px; height: 50px; border: 4px solid rgba(220,38,38,0.2); border-left-color: var(--brand); border-radius: 50%; animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }

    /* --- PRINT STYLES --- */
    .print-only{display:none;} #printTableLayout{display:none;}
    @media print{ 
        @page { size: A4 portrait; margin: 5mm; } 
        /* FIX FOR BLANK PAGE 2: Set height to auto and hidden overflow */
        body { background:#fff !important; margin:0; padding:0; font-size: 11px; padding-bottom:0; height: auto !important; overflow: hidden !important; } 
        .topbar, .actions-bar, .summary, .toast, .no-print, .add-item-bar, #loaderOverlay, #globalSettings { display:none !important; } 
        .wrap { max-width:none; margin:0; padding:0; } 
        .layout { grid-template-columns:1fr; gap:0; display:block; } 
        main { display:none !important; } 
        .print-only { display:block !important; } 
        #printTableLayout { display:block; overflow: hidden; } 
    }
    .do-page{width:100%;--print-scale:1;transform:scale(var(--print-scale));transform-origin:top left;} .do-title{text-align:center;font-weight:700;font-size:20px;margin:2mm 0 3mm;}
    .do-table{width:100%;border-collapse:collapse;table-layout:fixed;} .do-table td,.do-table th{border:1px solid #000;padding:4px 5px;vertical-align:top;font-size:11px;}
    .sauda-table { table-layout: fixed; width: 100%; } .sauda-table td { overflow: hidden; }
    .do-label{width:22%;font-weight:700;white-space:nowrap;} .do-value{width:78%;word-wrap:break-word;} .do-subhead{font-weight:700;text-align:center;background:#eee;} .do-gray{background:#d9d9d9;font-weight:700;} .do-tight td,.do-tight th{padding:3px 5px;}
    .do-right-table{width:100%;border-collapse:collapse;table-layout:fixed;} .do-right-table td{border:1px solid #000;padding:4px 5px;font-size:11px;} .do-right-label{width:45%;font-weight:700;white-space:nowrap;} .do-right-val{width:55%;}
    .do-section-gap{height:3mm;} .do-note td{height:14mm;} .do-sign td{height:16mm;vertical-align:bottom;} .do-num{text-align:right;white-space:nowrap;} .do-center{text-align:center;}
  </style>
</head>

<body>
  <div id="loaderOverlay">
    <div class="spinner"></div>
    <p style="margin-top:16px; font-weight:700; color:#dc2626;">Loading Sheet Data...</p>
  </div>

  <div class="topbar no-print">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">SM</div>
        <div>
          <h1>MS Delivery Order</h1>
          <p>Smart Steel Dispatch</p>
        </div>
      </div>
      
      <div class="pill" id="savePill" title="Autosave status"><span class="dot" id="statusDot"></span><span id="statusText">Draft</span></div>
    </div>
  </div>

  <div class="wrap">
    <form id="doForm" novalidate>
      <div class="layout">
        
        <main>
            <section class="card">
              <h2>Party Details</h2>
              <div class="grid">
                <div class="field span-3"><label for="poNo">P O Order No.</label><input id="poNo" /></div>
                <div class="field span-3"><label for="poDate">P O Date</label><input type="date" id="poDate" style="background:#fff" /></div>
                <div class="field"><label for="dealerName">Dealer Name <span class="req">*</span></label><input id="dealerName" required /><p class="error" id="err-dealerName"></p></div>
                
                <div class="field"><label for="billingName">Billing Name <span class="req">*</span></label><input id="billingName" required /><p class="error" id="err-billingName"></p></div>
                <div class="field"><label for="billingAddress">Billing Address <span class="req">*</span></label><textarea id="billingAddress" rows="2" required></textarea><p class="error" id="err-billingAddress"></p></div>
                
                <div class="field"><label for="consigneeName">Consignee Name</label><input id="consigneeName" /></div>
                <div class="field"><label for="dispatchAddress">Shipping Address</label><textarea id="dispatchAddress" rows="2"></textarea></div>
              </div>
            </section>

            <div id="dynamicItemsRoot" style="margin-top:20px;"></div>
            <div class="add-item-bar no-print" style="margin-top:10px; display:flex; justify-content:center;">
              <button type="button" class="btn primary" data-action="addNewItemBlock" style="width:100%; justify-content:center;">‚ûï Add Another Item</button>
            </div>

            <section class="card" style="margin-top:20px">
              <h2>Notes &amp; Signatures</h2>
              <div class="grid">
                <div class="field span-12"><label for="note">Note</label><textarea id="note" rows="2" placeholder="Any dispatch notes..."></textarea></div>
                <div class="field"><label for="signedBy">Order Signed By</label><input id="signedBy" /></div>
                <div class="field"><label for="approvedBy">Approved By</label><input id="approvedBy" /></div>
              </div>
            </section>
        </main>

        <aside class="sidebar-wrapper">
          <div id="globalSettings" class="global-settings-grid">
              <div class="field"><label for="orderDate">Date <span class="req">*</span></label><input id="orderDate" type="date" required style="background:#fff" /><p class="error" id="err-orderDate"></p></div>
              <div class="field"><label>Bill Type <span class="req">*</span></label><div class="bill-switch-global" id="billSwitch"><label><input type="radio" name="globalBillType" value="BILL"><span>BILL</span></label><label><input type="radio" name="globalBillType" value="NC"><span>NC</span></label></div><p class="error" id="err-billType"></p></div>
              <div class="field"><label for="globalOB">OB</label><input id="globalOB" type="number" step="0.01" style="background:#fff"></div>
              <div class="field"><label for="freight">Freight</label><input id="freight" type="number" step="0.01" style="background:#fff"></div>
              <div class="field"><label for="lorryNo">Lorry No</label><input id="lorryNo" style="background:#fff"><p class="error" id="err-lorryNo"></p></div>
              <p class="error" id="err-globalSettings" aria-live="polite" style="grid-column: span 2; margin:0;"></p>
          </div>

          <div class="summary card">
            <h2>Summary</h2>
            <div class="kv"><span>Total Qty</span><strong id="sumTotalQty">‚Äî</strong></div>
            <div class="kv"><span>Status</span><strong id="sumStatus">Draft</strong></div>
            <div class="kv"><span>Last Save</span><strong id="sumSavedAt">‚Äî</strong></div>
          </div>
        </aside>

      </div>
    </form>
    
    <div id="printTableLayout" class="print-only do-page">
      <div class="do-title">Delivery Order</div>
      <div id="printDump"></div>
    </div>
  </div>

  <div class="actions-bar no-print">
    <button class="btn ghost" type="button" data-action="reset">üßπ Reset</button>
    <button class="btn secondary" type="button" data-action="exportCsv">‚¨áÔ∏è CSV</button>
    <button class="btn secondary" type="button" data-action="shareWhatsapp" style="background:#25D366; color:white; border:none;">üì± Share WA</button>
    <button class="btn secondary" type="button" data-action="copySummary">üìã Copy</button>
    <button class="btn primary" type="button" data-action="print">üñ®Ô∏è Print</button>
  </div>

  <div class="toast" id="toast"><span id="toastText">Action done</span></div>

  <template id="itemBlockTpl">
    <div class="item-block">
      <div class="block-header">
        <div class="block-inputs">
          <div class="item-select-wrap"><label style="margin:0 0 4px">Item <span class="req">*</span></label><select class="block-item-select"></select></div>
          <div class="rate-input-wrap"><label style="margin:0 0 4px">Sauda Rate <span class="req">*</span></label><input type="number" class="block-sauda-input" placeholder="e.g. 52000"></div>
          <div class="balance-input-wrap"><label style="margin:0 0 4px">Balance Qty (MT)</label><input type="number" class="block-balance-input" placeholder="e.g. 5.000" step="0.001" min="0" inputmode="decimal"></div>
        </div>
        <div class="block-summary"></div>
        <button type="button" class="icon-btn remove-block-btn" title="Remove Item Block">‚úï</button>
        <div class="block-error"></div>
      </div>
      <div class="block-body">
        <table class="size-table">
          <thead><tr><th style="width:35%">Size <span class="req">*</span></th><th style="width:15%">Qty (MT)</th><th style="width:15%">Net Rate</th><th style="width:30%">Breakdown</th><th style="width:40px"></th></tr></thead>
          <tbody class="size-rows-container"></tbody>
        </table>
        <div class="row-actions no-print"><button type="button" class="btn small secondary add-size-btn">‚ûï Add Size</button><button type="button" class="btn small ghost dup-size-btn">üß¨ Duplicate Last</button></div>
      </div>
    </div>
  </template>

  <template id="sizeRowTpl">
    <tr class="size-row">
      <td class="size-cell"></td>
      <td><input type="number" class="qty-input" placeholder="0.000" step="0.001" min="0" inputmode="decimal"></td>
      <td><input type="number" class="net-rate-input" placeholder="Auto" title="Edit to reverse calc Sauda Rate"></td>
      <td><input type="text" class="bd-input" placeholder="‚Äî" readonly style="font-size:11px; color:#666;"></td>
      <td><button type="button" class="icon-btn remove-row-btn" style="width:28px;height:28px;font-size:12px">üóë</button></td>
    </tr>
  </template>

  <script>
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbzcSBboPXwuH-whwxXe8IdaaTqnTgIPBVo_z1aMJNZuzX2KQq12AL-RjH1znoq3MCex/exec"; 

    // Variables for Data
    let ITEM_LIST = [];
    let SIZE_SD_LIST = {};
    let SIZE_SD_MAP = Object.create(null);
    let SIZE_KEYS = Object.create(null);

    // DOM Elements
    const form = document.getElementById("doForm");
    const root = document.getElementById("dynamicItemsRoot");
    const itemBlockTpl = document.getElementById("itemBlockTpl");
    const sizeRowTpl = document.getElementById("sizeRowTpl");
    const orderDate = document.getElementById("orderDate");
    const loaderOverlay = document.getElementById("loaderOverlay");

    function todayLocalISO(){ const d = new Date(); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    const TODAY = todayLocalISO();
    orderDate.max = TODAY; orderDate.value = TODAY;

    const statusText = document.getElementById("statusText");
    const statusDot = document.getElementById("statusDot");
    const savePill = document.getElementById("savePill");
    const sumTotalQty = document.getElementById("sumTotalQty");
    const sumStatus = document.getElementById("sumStatus");
    const sumSavedAt = document.getElementById("sumSavedAt");
    const toast = document.getElementById("toast");
    const toastText = document.getElementById("toastText");
    const globalSettingsDiv = document.getElementById("globalSettings");

    let suppressSave = false;
    const STORAGE_KEY = "steelMart.do.v3.nested.balanceQty";

    // --- DATA FETCHING ---
    async function fetchSheetData() {
        try {
            if(!SHEET_API_URL || SHEET_API_URL.includes("PASTE_YOUR")) throw new Error("API URL not configured.");
            const response = await fetch(SHEET_API_URL);
            if (!response.ok) throw new Error("Network response was not ok");
            const jsonResponse = await response.json();
            
            const rawItems = jsonResponse.items || [];
            const newSdList = {};
            const newItems = [];

            rawItems.forEach(group => {
                const itemName = group.name;
                if (!itemName) return;
                newItems.push(itemName);
                newSdList[itemName] = [];
                if (group.sizes && Array.isArray(group.sizes)) {
                    group.sizes.forEach(s => newSdList[itemName].push([ s.label, s.sd || 0 ]));
                }
            });

            SIZE_SD_LIST = newSdList;
            ITEM_LIST = newItems;
            
            SIZE_SD_MAP = Object.create(null);
            SIZE_KEYS = Object.create(null);
            for (const [item, list] of Object.entries(SIZE_SD_LIST)){
                const m = Object.create(null);
                const keys = [];
                for (const [size, sdRaw] of list){
                    const k = String(size || "").trim();
                    if (!k) continue;
                    m[k] = Number.isFinite(+sdRaw) ? +sdRaw : 0;
                    keys.push(k);
                }
                SIZE_SD_MAP[item] = m;
                SIZE_KEYS[item] = keys;
            }
            loaderOverlay.style.display = 'none';
            init();

        } catch (error) {
            console.error(error);
            loaderOverlay.innerHTML = `<p style='color:red; text-align:center'>Error loading data.<br>${error.message}</p>`;
        }
    }

    function fmtTime(ts){ try{ return new Date(ts).toLocaleString(undefined, {hour:"2-digit", minute:"2-digit"}); } catch(_){ return "‚Äî"; } }
    function setStatus(kind, label){
      statusText.textContent = label; sumStatus.textContent = label;
      statusDot.classList.remove("warn","danger");
      if (kind === "warn") statusDot.classList.add("warn");
      if (kind === "danger") statusDot.classList.add("danger");
      if(savePill) savePill.style.transform = label.toLowerCase().includes("saving") ? "scale(1.03)" : "scale(1)";
    }

    function showToast(msg){ toastText.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 2200); }
    function getGlobalBillType(){ const checked = document.querySelector('input[name="globalBillType"]:checked'); return checked ? checked.value : ""; }
    function getFreight(){ const v = parseFloat(document.getElementById("freight").value); return Number.isFinite(v) ? v : 0; }
    function getOB(){ const v = parseFloat(document.getElementById("globalOB").value); return Number.isFinite(v) ? v : 0; }
    function clampTo3(n){ if(!Number.isFinite(n)) return ""; return (Math.round(n * 1000) / 1000).toFixed(3); }
    function escHtml(s){ return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
    function isoToDDMMYYYY(iso){ const m = String(iso || "").match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) return escHtml(iso || ""); return `${m[3]}/${m[2]}/${m[1]}`; }

    function calcForward(saudaRate, sd, billType, freight, ob, item) {
      if (!Number.isFinite(saudaRate) || saudaRate <= 0) return { rate: "", bd: "Set Sauda Rate" };
      if (!billType) return { rate: "", bd: "Select Bill Type" };
      const isNC = (billType === "NC");
      const applyDeduction = isNC && (item !== "Binding Wire" && item !== "Nails");
      const base = saudaRate + sd + 255 - (applyDeduction ? 3000 : 0) + freight + ob;
      return { rate: Math.round(base * 1.18), bd: `${saudaRate} + ${sd}${applyDeduction ? " - 3000" : ""} + 255 + ${freight}${ob ? ` + ${ob}` : ""} + 18%` };
    }

    function calcReverse(netRate, sd, billType, freight, ob, item) {
      if (!Number.isFinite(netRate) || netRate <= 0) return 0;
      if (!billType) return 0;
      const isNC = (billType === "NC");
      const applyDeduction = isNC && (item !== "Binding Wire" && item !== "Nails");
      const base = netRate / 1.18;
      const sauda = base - sd - 255 + (applyDeduction ? 3000 : 0) - freight - ob;
      return Math.round(sauda);
    }

    function recalcRow(tr) {
      const block = tr.closest('.item-block');
      const item = block.querySelector('.block-item-select').value;
      const sauda = parseFloat(block.querySelector('.block-sauda-input').value);
      const sizeInput = tr.querySelector('.size-input');
      const size = sizeInput ? sizeInput.value.trim() : "";
      if (!item) return { rate: "", bd: "" };

      const sdMap = SIZE_SD_MAP[item];
      const sd = (sdMap && Number.isFinite(+sdMap[size])) ? +sdMap[size] : 0;
      const billType = getGlobalBillType();
      const freight = getFreight();
      const ob = getOB();

      const { rate, bd } = calcForward(sauda, sd, billType, freight, ob, item);
      const netInput = tr.querySelector('.net-rate-input');
      
      if (document.activeElement !== netInput) netInput.value = rate;
      tr.querySelector('.bd-input').value = bd;
      return { rate, bd };
    }

    function blockUsedQty(block){
      let total = 0;
      block.querySelectorAll('.qty-input').forEach(inp => { const v = parseFloat(inp.value); if(Number.isFinite(v)) total += v; });
      return total;
    }

    function enforceBalance(block, changedQtyInput){
      const balRaw = parseFloat(block.querySelector('.block-balance-input').value);
      if(!Number.isFinite(balRaw) || balRaw <= 0){ block.querySelector('.block-error').textContent = ""; return true; }
      const currentVal = parseFloat(changedQtyInput.value);
      const cur = Number.isFinite(currentVal) ? currentVal : 0;
      let usedWithout = 0;
      block.querySelectorAll('.qty-input').forEach(inp => { if(inp !== changedQtyInput) { const v = parseFloat(inp.value); if(Number.isFinite(v)) usedWithout += v; } });
      const maxForThis = Math.max(0, balRaw - usedWithout);
      if((usedWithout + cur) > balRaw + 1e-9){
        const newVal = maxForThis;
        changedQtyInput.value = clampTo3(newVal);
        changedQtyInput.classList.add("touched","is-invalid");
        block.querySelector('.block-error').textContent = `Qty exceeded Balance. Adjusted to ${clampTo3(newVal)} MT.`;
        showToast("Balance Qty limit reached");
        return false;
      }
      changedQtyInput.classList.remove("is-invalid");
      block.querySelector('.block-error').textContent = "";
      return true;
    }

    function updateBlockSummary(block) { block.querySelector('.block-summary').textContent = ""; }

    function recalcAll() {
      let grandTotal = 0;
      document.querySelectorAll('.item-block').forEach(block => {
        block.querySelectorAll('.size-row').forEach(tr => recalcRow(tr));
        grandTotal += blockUsedQty(block);
        updateBlockSummary(block);
      });
      sumTotalQty.textContent = grandTotal > 0 ? grandTotal.toFixed(3) : "‚Äî";
    }

    function createSizeInput(itemType, value) {
      const wrapper = document.createElement("div"); wrapper.style.position = "relative";
      const input = document.createElement("input"); input.className = "size-input"; input.type = "text"; input.value = value || ""; input.placeholder = "Select/Type Size";
      const sizes = SIZE_KEYS[itemType];
      if (sizes && sizes.length) {
        const listId = "dl_" + Math.random().toString(36).slice(2);
        input.setAttribute("list", listId);
        const dl = document.createElement("datalist"); dl.id = listId;
        sizes.forEach(s => { const opt = document.createElement("option"); opt.value = s; dl.appendChild(opt); });
        wrapper.appendChild(dl);
        input.placeholder = "Select/Type Size";
      }
      wrapper.appendChild(input);
      return { wrapper, input };
    }

    function addSizeRow(block, data = {}) {
      const tbody = block.querySelector('.size-rows-container');
      const clone = sizeRowTpl.content.cloneNode(true);
      const tr = clone.querySelector('tr');
      const itemType = block.querySelector('.block-item-select').value;
      const cell = tr.querySelector('.size-cell');
      const { wrapper } = createSizeInput(itemType, data.size || "");
      cell.appendChild(wrapper);
      tr.querySelector('.qty-input').value = data.qty || "";
      if(data.rate) tr.querySelector('.net-rate-input').value = data.rate;
      tbody.appendChild(tr);
      recalcRow(tr);
      return tr;
    }

    function addNewItemBlock(data = {}) {
      const clone = itemBlockTpl.content.cloneNode(true);
      const block = clone.querySelector('.item-block');
      const select = block.querySelector('.block-item-select');
      const saudaInput = block.querySelector('.block-sauda-input');
      const balanceInput = block.querySelector('.block-balance-input');
      select.innerHTML = `<option value="">Select Item</option>` + ITEM_LIST.map(i => `<option value="${i}">${i}</option>`).join('');
      select.value = data.item || "";
      saudaInput.value = data.saudaRate || "";
      balanceInput.value = data.balanceQty || "";
      const tbody = block.querySelector('.size-rows-container');
      tbody.innerHTML = "";
      if (data.sizes && data.sizes.length > 0) data.sizes.forEach(s => addSizeRow(block, s));
      else addSizeRow(block);
      
      root.appendChild(block);
      updateBlockSummary(block);
      recalcAll();
      return block;
    }

    root.addEventListener('click', (e) => {
        const target = e.target;
        const block = target.closest('.item-block');
        if (!block) return;
        if (target.closest('.remove-block-btn')) { if(confirm("Remove this item block?")) { block.remove(); recalcAll(); saveSoon(); } }
        else if (target.closest('.add-size-btn')) { addSizeRow(block); recalcAll(); saveSoon(); }
        else if (target.closest('.dup-size-btn')) { const rows = block.querySelectorAll('.size-row'); if (rows.length > 0) { const last = rows[rows.length-1]; addSizeRow(block, { size: last.querySelector('.size-input').value, qty: last.querySelector('.qty-input').value }); recalcAll(); saveSoon(); } }
        else if (target.closest('.remove-row-btn')) { e.target.closest('tr').remove(); if(block.querySelectorAll('.size-row').length === 0) addSizeRow(block); block.querySelector('.block-error').textContent = ""; recalcAll(); saveSoon(); }
    });

    root.addEventListener('focusin', (e) => { if(e.target.matches('.block-item-select')) e.target.dataset.prev = e.target.value; });

    root.addEventListener('change', (e) => {
        if(e.target.matches('.block-item-select')) {
            const select = e.target;
            const block = select.closest('.item-block');
            const hasData = Array.from(block.querySelectorAll('.size-input, .qty-input')).some(i => i.value);
            if (hasData) { if (!confirm("Changing item will reset sizes. Continue?")) { select.value = select.dataset.prev; return; } block.querySelector('.size-rows-container').innerHTML = ""; addSizeRow(block); }
            block.querySelectorAll('.size-row').forEach(tr => { const cell = tr.querySelector('.size-cell'); const currentSize = tr.querySelector('.size-input')?.value || ""; cell.innerHTML = ""; const { wrapper } = createSizeInput(select.value, currentSize); cell.appendChild(wrapper); });
            block.querySelector('.block-error').textContent = ""; recalcAll(); saveSoon();
        }
    });

    root.addEventListener('input', (e) => {
        const target = e.target;
        const block = target.closest('.item-block');
        if (!block) return;

        if (target.matches('.block-sauda-input')) { recalcAll(); saveSoon(); }
        if (target.matches('.net-rate-input')) {
           const tr = target.closest('tr');
           const netRate = parseFloat(target.value);
           const item = block.querySelector('.block-item-select').value;
           const size = tr.querySelector('.size-input').value;
           if(item && Number.isFinite(netRate)){
              const sdMap = SIZE_SD_MAP[item];
              const sd = (sdMap && Number.isFinite(+sdMap[size])) ? +sdMap[size] : 0;
              const newSauda = calcReverse(netRate, sd, getGlobalBillType(), getFreight(), getOB(), item);
              block.querySelector('.block-sauda-input').value = newSauda;
              block.querySelectorAll('.size-row').forEach(otherRow => { if(otherRow !== tr) recalcRow(otherRow); else { const applyDeduction = (getGlobalBillType() === "NC" && item !== "Binding Wire" && item !== "Nails"); tr.querySelector('.bd-input').value = `${newSauda} + ${sd}${applyDeduction ? " - 3000" : ""} + 255 + ${getFreight()}${getOB() ? ` + ${getOB()}` : ""} + 18%`; } });
           }
           saveSoon();
        }
        if (target.matches('.block-balance-input')) {
          const bal = parseFloat(target.value);
          if(Number.isFinite(bal) && bal > 0){
            if(blockUsedQty(block) > bal){
              const last = Array.from(block.querySelectorAll('.qty-input')).reverse().find(inp => (parseFloat(inp.value) || 0) > 0) || block.querySelector('.qty-input');
              if(last) enforceBalance(block, last);
            } else { block.querySelector('.block-error').textContent = ""; }
          } else { block.querySelector('.block-error').textContent = ""; }
          recalcAll(); saveSoon();
        }
        if (target.matches('.qty-input') || target.matches('.size-input')) {
          const tr = target.closest('tr'); if(tr) recalcRow(tr);
          if(target.matches('.qty-input')) enforceBalance(block, target); else block.querySelector('.block-error').textContent = "";
          updateBlockSummary(block); recalcAll(); saveSoon();
        }
    });

    function collectData() {
      const blocks = [];
      document.querySelectorAll('.item-block').forEach(b => {
        const sizes = [];
        b.querySelectorAll('.size-row').forEach(tr => sizes.push({ size: tr.querySelector('.size-input').value, qty: tr.querySelector('.qty-input').value, rate: tr.querySelector('.net-rate-input').value, bd: tr.querySelector('.bd-input').value }));
        blocks.push({ item: b.querySelector('.block-item-select').value, saudaRate: b.querySelector('.block-sauda-input').value, balanceQty: b.querySelector('.block-balance-input').value, sizes });
      });
      return {
        poNo: document.getElementById("poNo").value, poDate: document.getElementById("poDate").value, consigneeName: document.getElementById("consigneeName").value,
        dealerName: document.getElementById("dealerName").value, billingName: document.getElementById("billingName").value, billingAddress: document.getElementById("billingAddress").value, dispatchAddress: document.getElementById("dispatchAddress").value,
        orderDate: document.getElementById("orderDate").value, billType: getGlobalBillType(), ob: document.getElementById("globalOB").value, freight: document.getElementById("freight").value, lorryNo: document.getElementById("lorryNo").value,
        note: document.getElementById("note").value, signedBy: document.getElementById("signedBy").value, approvedBy: document.getElementById("approvedBy").value, items: blocks
      };
    }

    function applyData(data) {
      document.getElementById("poNo").value = data.poNo || ""; document.getElementById("poDate").value = data.poDate || ""; document.getElementById("consigneeName").value = data.consigneeName || "";
      document.getElementById("dealerName").value = data.dealerName || ""; document.getElementById("billingName").value = data.billingName || ""; document.getElementById("billingAddress").value = data.billingAddress || ""; document.getElementById("dispatchAddress").value = data.dispatchAddress || "";
      document.getElementById("orderDate").value = data.orderDate || TODAY;
      const checked = document.querySelector('input[name="globalBillType"]:checked'); if(checked) checked.checked = false;
      if (data.billType) { const r = document.querySelector(`input[name="globalBillType"][value="${data.billType}"]`); if(r) r.checked = true; }
      document.getElementById("globalOB").value = data.ob || ""; document.getElementById("freight").value = data.freight || ""; document.getElementById("lorryNo").value = data.lorryNo || "";
      document.getElementById("note").value = data.note || ""; document.getElementById("signedBy").value = data.signedBy || ""; document.getElementById("approvedBy").value = data.approvedBy || "";
      root.innerHTML = ""; if (data.items && data.items.length) data.items.forEach(blockData => addNewItemBlock(blockData)); else addNewItemBlock();
      recalcAll(); validateGlobalSettingsUI();
    }

    function saveDraft() { if(suppressSave) return; const payload = { savedAt: Date.now(), data: collectData() }; localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); setStatus("ok", "Saved"); sumSavedAt.textContent = fmtTime(payload.savedAt); }
    let saveTimer; function saveSoon() { setStatus("warn", "Saving..."); clearTimeout(saveTimer); saveTimer = setTimeout(saveDraft, 650); }

    function validateSingle(input){ if (input.checkValidity()) { input.classList.add('is-valid'); input.classList.remove('is-invalid'); } else { input.classList.add('is-invalid'); input.classList.remove('is-valid'); } }
    function setupRealtimeValidation(){
      ["dealerName","billingName","billingAddress","orderDate"].map(id => document.getElementById(id)).filter(Boolean).forEach(input => { input.addEventListener('blur', () => { input.classList.add('touched'); validateSingle(input); }); input.addEventListener('input', () => { if (input.classList.contains('touched')) validateSingle(input); }); });
    }
    function validateGlobalSettingsUI(){
      const bill = getGlobalBillType(); globalSettingsDiv.classList.remove("error-border","valid-border"); document.getElementById("err-billType").textContent = "";
      if(bill) globalSettingsDiv.classList.add("valid-border");
    }
    function clearValidationEffects(scope=document){
      scope.querySelectorAll('input, textarea, select').forEach(el => { el.classList.remove('touched','is-valid','is-invalid'); el.style.transform = ""; });
      scope.querySelectorAll('.block-error').forEach(el => el.textContent = "");
      globalSettingsDiv.classList.remove("error-border","valid-border"); document.getElementById("err-billType").textContent = ""; document.getElementById("err-globalSettings").textContent = "";
    }

    document.addEventListener("click", (e) => {
      const target = e.target.closest('.btn, .icon-btn');
      if(target){ const ripple = document.createElement('span'); ripple.className = 'ripple'; const rect = target.getBoundingClientRect(); const size = Math.max(rect.width, rect.height); const x = e.clientX - rect.left - size / 2; const y = e.clientY - rect.top - size / 2; ripple.style.width = ripple.style.height = `${size}px`; ripple.style.left = `${x}px`; ripple.style.top = `${y}px`; target.appendChild(ripple); ripple.addEventListener('animationend', () => ripple.remove()); }
      const btn = e.target.closest("[data-action]"); if(!btn) return; const action = btn.dataset.action;
      if(action === "addNewItemBlock"){ addNewItemBlock(); window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); saveSoon(); }
      if(action === "reset"){ if(!confirm("Clear all data?")) return; suppressSave = true; localStorage.removeItem(STORAGE_KEY); form.reset(); orderDate.max = TODAY; orderDate.value = TODAY; const checked = document.querySelector('input[name="globalBillType"]:checked'); if(checked) checked.checked = false; root.innerHTML = ""; addNewItemBlock(); clearValidationEffects(document); suppressSave = false; sumSavedAt.textContent = "‚Äî"; setStatus("warn", "Draft"); showToast("Reset done"); recalcAll(); }
      if(action === "copySummary"){ 
        const data = collectData(); 
        let txt = `*Steel Mart DO*\nDate: ${data.orderDate}\nDealer: ${data.dealerName}\nBill: ${data.billType}\n\n*Details*\n`;
        let idx = 1; let tQty = 0; 
        data.items.forEach(block => { (block.sizes || []).forEach(s => { const q = parseFloat(s.qty)||0; if(block.item && q > 0) { txt += `${idx++}. ${block.item} ${s.size} - ${q.toFixed(3)} MT\n`; tQty += q; } }); }); 
        txt += `\n*Total: ${tQty.toFixed(3)} MT*`; 
        navigator.clipboard.writeText(txt).then(() => showToast("Summary copied")); 
      }
      
      // --- NEW WHATSAPP SHARE FEATURE ---
      if(action === "shareWhatsapp"){
        const data = collectData();
        let txt = `*Steel Mart DO*\nDate: ${data.orderDate}\nDealer: ${data.dealerName}\n\n*Details*\n`;
        let idx = 1; let tQty = 0;
        data.items.forEach(block => { 
            (block.sizes || []).forEach(s => { 
                const q = parseFloat(s.qty)||0; 
                if(block.item && q > 0) { 
                    txt += `${idx++}. ${block.item} ${s.size} - ${q.toFixed(3)} MT\n`; 
                    tQty += q; 
                } 
            }); 
        });
        txt += `\n*Total: ${tQty.toFixed(3)} MT*`;
        
        // Open WhatsApp with the text
        const url = `https://wa.me/?text=${encodeURIComponent(txt)}`;
        window.open(url, '_blank');
      }

      if(action === "exportCsv"){
        const data = collectData(); const csvCell=v=>`"${String(v||"").replace(/"/g,'""')}"`;
        const lines = [csvCell("Delivery Order"),"",`Dealer Name,${csvCell(data.dealerName)}`,`Billing Name,${csvCell(data.billingName)}`,`Date,${csvCell(data.orderDate)}`,`Bill Type,${csvCell(data.billType)}`,`Lorry No,${csvCell(data.lorryNo)}`,"", "Item,Rate"];
        (data.items||[]).forEach(x=>lines.push(`${csvCell(x.item)},${csvCell(x.saudaRate)}`)); lines.push("","Sr,Item,Size,Qty(MT),Rate,Breakdown");
        let i=1,t=0; (data.items||[]).forEach(b=>{ (b.sizes||[]).forEach(s=>{ if(s.qty>0){ t+=parseFloat(s.qty); lines.push(`${i++},${csvCell(b.item)},${csvCell(s.size)},${s.qty},${s.rate},${csvCell(s.bd)}`); } }); });
        lines.push(`,Total,,${t.toFixed(3)},MT`);
        const a = document.createElement("a"); a.href = window.URL.createObjectURL(new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" })); a.download = `DO_${(data.dealerName||"").substring(0,10)}_${Date.now()}.csv`; a.click();
      }
      if(action === "print" || action === "sharePdf"){
        const data = collectData();
        if(!data.dealerName || !data.billingName || !data.billingAddress || !data.billType){ alert("Please fill Dealer Name, Billing Name, Billing Address and Bill Type."); return; }
        document.querySelectorAll('.item-block').forEach(block => { const last = Array.from(block.querySelectorAll('.qty-input')).reverse().find(inp => (parseFloat(inp.value)||0) > 0) || block.querySelector('.qty-input'); if(last) enforceBalance(block, last); });
        recalcAll(); 
        if(action === "sharePdf") showToast("Choose 'Save as PDF' to share");
        preparePrintAndScale(); window.print();
      }
    });

    form.addEventListener("input", (e) => { if(e.target && (e.target.id === "freight" || e.target.id === "globalOB" || e.target.name === "globalBillType" || e.target.id === "orderDate")){ recalcAll(); validateGlobalSettingsUI(); saveSoon(); } });
    (function setupParallax(){ let ticking = false; function update(e) { if (!ticking) { window.requestAnimationFrame(() => { const x = (e.clientX - window.innerWidth / 2) * 0.02; const y = (e.clientY - window.innerHeight / 2) * 0.02; document.documentElement.style.setProperty('--plx-x', `${x}px`); document.documentElement.style.setProperty('--plx-y', `${y}px`); ticking = false; }); ticking = true; } } if (window.matchMedia("(pointer: fine)").matches) { window.addEventListener('mousemove', update); } })();

    function buildSaudaTableHTML(data) {
        const itemTotalMap = {}; (data.items || []).forEach(b => { const name = (b.item||"").trim(); if(!name) return; let q = 0; (b.sizes||[]).forEach(s => q += parseFloat(s.qty)||0); itemTotalMap[name] = (itemTotalMap[name]||0) + q; });
        const uniquePairs = {}; (data.items || []).forEach(b => { const name = (b.item||"").trim(); const rate = (b.saudaRate||"").toString().trim(); if (name && rate && Number.isFinite(+rate) && (+rate > 0)) { const totalQty = itemTotalMap[name] || 0; if(totalQty > 0) { if(!uniquePairs[name]) uniquePairs[name] = { item: name, rate: rate, qty: totalQty }; } } });
        const pairs = Object.values(uniquePairs); const count = pairs.length; if (count === 0) return ""; 
        let pairsPerRow = count >= 2 ? 2 : 1; const totalCols = pairsPerRow * 3;
        let colgroup = '<colgroup>'; const wItem = pairsPerRow === 1 ? '50%' : '24%'; const wRate = pairsPerRow === 1 ? '25%' : '13%'; const wQty = pairsPerRow === 1 ? '25%' : '13%';
        for(let i=0; i<pairsPerRow; i++) colgroup += `<col style="width:${wItem}"><col style="width:${wRate}"><col style="width:${wQty}">`; colgroup += '</colgroup>';
        let subhead = '<tr class="do-gray">'; for(let i=0; i<pairsPerRow; i++) subhead += `<td>Item</td><td class="do-center">Rate</td><td class="do-center">Qty</td>`; subhead += '</tr>';
        let rowsHtml = ''; for (let i = 0; i < count; i += pairsPerRow) { rowsHtml += '<tr>'; for (let j = 0; j < pairsPerRow; j++) { const pair = pairs[i + j]; if (pair) { rowsHtml += `<td>${escHtml(pair.item)}</td><td class="do-num">${escHtml(pair.rate)}</td><td class="do-num" style="font-weight:700;">${pair.qty.toFixed(3)}</td>`; } else { rowsHtml += `<td style="border:none;">&nbsp;</td><td style="border:none;">&nbsp;</td><td style="border:none;">&nbsp;</td>`; } } rowsHtml += '</tr>'; }
        return `<table class="do-table do-tight sauda-table">${colgroup}<tr><td class="do-subhead" colspan="${totalCols}">Item &amp; Sauda Rates</td></tr>${subhead}${rowsHtml}</table>`;
    }

    function buildMainRows(data){
      let sr=1, total=0, rows=""; (data.items||[]).forEach(block=>{ const itemName=(block.item||"").trim(); (block.sizes||[]).forEach(s=>{ const size=(s.size||"").trim(); const qty=parseFloat(s.qty); if(!itemName || !size || !Number.isFinite(qty) || qty<=0) return; total+=qty; rows+=`<tr><td class="do-center">${sr++}</td><td>${escHtml(itemName)}</td><td>${escHtml(size)}</td><td class="do-num">${qty.toFixed(3)}</td><td class="do-wrap" style="font-size:10px;">${escHtml((s.bd||"").trim())}</td><td class="do-num">${escHtml(String(Math.round(parseFloat(s.rate)||0)))}</td></tr>`; }); });
      if(!rows) rows=`<tr><td class="do-center">1</td><td>&nbsp;</td><td>&nbsp;</td><td class="do-num">&nbsp;</td><td class="do-num">&nbsp;</td><td>&nbsp;</td></tr>`;
      return {rows, totalRow: `<tr style="font-weight:700; background:#f9f9f9;"><td colspan="3" class="do-center">Total</td><td class="do-num">${total>0?total.toFixed(3):"‚Äî"}</td><td class="do-center">MT</td><td>&nbsp;</td></tr>`};
    }

    function buildPrintLayout(data){
      const billType=escHtml(data.billType||""); const dateTxt=isoToDDMMYYYY(data.orderDate||""); const freight=escHtml((data.freight??"").toString()); const lorryNo=escHtml(data.lorryNo||""); const ob=escHtml((data.ob??"").toString());
      const dealerName=escHtml(data.dealerName||""); const billingName=escHtml(data.billingName||""); const billingAddress=escHtml(data.billingAddress||"").replaceAll("\n","<br>"); 
      const poNo=escHtml(data.poNo||""); const poDate=isoToDDMMYYYY(data.poDate||""); const consigneeName=escHtml(data.consigneeName||""); const shippingAddress=escHtml(data.dispatchAddress||"").replaceAll("\n","<br>");
      const note=(data.note||"").trim(); const signedBy=escHtml(data.signedBy||""); const approvedBy=escHtml(data.approvedBy||"");
      const saudaTableHTML = buildSaudaTableHTML(data); const {rows:mainRows, totalRow}=buildMainRows(data);
      
      /* --- UPDATED NOTE LOGIC: Show text if present, else show lines for writing --- */
      let noteContent = "";
      if (note) {
          noteContent = `<div style="padding:4px 0;">${escHtml(note).replaceAll("\n","<br>")}</div>`;
      } else {
          // Empty note? Show lines for manual writing
          noteContent = `
            <div style="height:24px; border-bottom:1px dashed #bbb; margin-bottom:4px;"></div>
            <div style="height:24px; border-bottom:1px dashed #bbb; margin-bottom:4px;"></div>
          `;
      }
      const noteSection = `
        <table class="do-table do-note" style="margin-top:3mm; width:100%;">
            <tr>
                <td style="width:10%; font-weight:700; vertical-align:top; border:none; padding-top:8px;">Note:</td>
                <td style="width:90%; border:none; vertical-align:top;">${noteContent}</td>
            </tr>
        </table>`;
      /* -------------------------------------------------------------------------- */

      const saudaRow = saudaTableHTML ? `<tr><td colspan="2" style="padding:0; border-top:1px solid #000;">${saudaTableHTML}</td></tr>` : "";

      return `
      <table class="do-table do-tight" style="width:100%;">
        <colgroup><col style="width:66%"><col style="width:34%"></colgroup>
        <tr>
            <td style="padding:0; border-bottom:none;">
                <table class="do-table do-tight" style="border:none; width:100%;">
                    <tr><td class="do-label" style="border:none; border-bottom:1px solid #000; border-right:1px solid #000;">P O Order No.</td><td class="do-value" style="border:none; border-bottom:1px solid #000;">${poNo||"&nbsp;"}</td></tr>
                    <tr><td class="do-label" style="border:none; border-bottom:1px solid #000; border-right:1px solid #000;">P O Date</td><td class="do-value" style="border:none; border-bottom:1px solid #000;">${poDate||"&nbsp;"}</td></tr>
                    <tr><td class="do-label" style="border:none; border-bottom:1px solid #000; border-right:1px solid #000;">Dealer Name</td><td class="do-value" style="border:none; border-bottom:1px solid #000;">${dealerName||"&nbsp;"}</td></tr>
                    <tr><td class="do-label" style="border:none; border-bottom:1px solid #000; border-right:1px solid #000;">Billing Name</td><td class="do-value" style="border:none; border-bottom:1px solid #000;">${billingName||"&nbsp;"}</td></tr>
                    <tr><td class="do-label" style="border:none; border-bottom:1px solid #000; border-right:1px solid #000;">Billing Address</td><td class="do-value" style="border:none; border-bottom:1px solid #000;">${billingAddress||"&nbsp;"}</td></tr>
                    <tr><td class="do-label" style="border:none; border-bottom:1px solid #000; border-right:1px solid #000;">Consignee Name</td><td class="do-value" style="border:none; border-bottom:1px solid #000;">${consigneeName||"&nbsp;"}</td></tr>
                    <tr><td class="do-label" style="border:none; border-bottom:1px solid #000; border-right:1px solid #000;">Shipping Address</td><td class="do-value" style="border:none; border-bottom:1px solid #000;">${shippingAddress||"&nbsp;"}</td></tr>
                    <tr><td class="do-label" style="border:none; border-right:1px solid #000;">Bill Type</td><td class="do-value" style="border:none;">${billType||"&nbsp;"}</td></tr>
                </table>
            </td>
            <td style="padding:0; vertical-align:top; border-bottom:none;">
                <table class="do-right-table do-tight" style="border:none; width:100%;">
                    <tr><td class="do-right-label" style="border:1px solid #000; border-top:0; border-left:0;">Date</td><td class="do-right-val" style="border:1px solid #000; border-top:0; border-left:0; border-right:0;">${dateTxt||"&nbsp;"}</td></tr>
                    <tr><td class="do-right-label" style="border:1px solid #000; border-top:0; border-left:0;">Freight</td><td class="do-right-val" style="border:1px solid #000; border-top:0; border-left:0; border-right:0;">${freight||"&nbsp;"}</td></tr>
                    <tr><td class="do-right-label" style="border:1px solid #000; border-top:0; border-left:0;">Lorry No</td><td class="do-right-val" style="border:1px solid #000; border-top:0; border-left:0; border-right:0;">${lorryNo||"&nbsp;"}</td></tr>
                    <tr><td class="do-right-label" style="border:1px solid #000; border-top:0; border-left:0; border-bottom:1px solid #000;">OB</td><td class="do-right-val" style="border:1px solid #000; border-top:0; border-left:0; border-right:0; border-bottom:1px solid #000;">${ob||"&nbsp;"}</td></tr>
                </table>
            </td>
        </tr>
        ${saudaRow}
      </table>
      <div class="do-section-gap"></div>
      <table class="do-table do-tight">
        <colgroup><col style="width:5%"><col style="width:20%"><col style="width:20%"><col style="width:10%"><col style="width:35%"><col style="width:10%"></colgroup>
        <tr class="do-gray"><td class="do-center">Sr</td><td>Item</td><td>Sizes</td><td class="do-center">Qty (MT)</td><td>Breakdown</td><td class="do-center">Net Rate</td></tr>
        ${mainRows} ${totalRow}
      </table>
      ${noteSection}<table class="do-table do-sign" style="margin-top:3mm;"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tr><td><div style="font-weight:700;">Order Signed</div><div style="margin-top:10mm;">${signedBy||"&nbsp;"}</div></td><td><div style="font-weight:700;">Approved By</div><div style="margin-top:10mm;">${approvedBy||"&nbsp;"}</div></td></tr></table>`;
    }

    // FIX FOR BLANK PAGE: Explicitly calculate height and set it on the element
    function applyPrintScale(){ 
        const page=document.getElementById("printTableLayout"); 
        if(!page) return; 
        page.style.setProperty("--print-scale","1"); 
        page.style.height = "auto"; // Reset height to recalculate
        
        const availablePx=1085; // A4 height roughly in pixels at 96dpi minus margins
        const h=page.getBoundingClientRect().height; 
        
        if(h>0){ 
            const s=Math.min(1, availablePx/h); 
            page.style.setProperty("--print-scale", String(s)); 
            
            // CRITICAL FIX: Set the container height to the scaled height
            // This prevents the browser from reserving the full unscaled space
            page.style.height = (h * s) + "px"; 
        } 
    }
    function preparePrintAndScale(){ recalcAll(); document.getElementById("printDump").innerHTML = buildPrintLayout(collectData()); requestAnimationFrame(applyPrintScale); }
    window.addEventListener("beforeprint", ()=>{ try{preparePrintAndScale();}catch(e){} });

    function init(){ setupRealtimeValidation(); fetchSheetData(); }
    const originalInit = init;
    init = function() {
        const raw = localStorage.getItem(STORAGE_KEY); 
        if(raw) { try { const p = JSON.parse(raw); suppressSave = true; applyData(p.data); suppressSave = false; sumSavedAt.textContent = fmtTime(p.savedAt); setStatus("ok", "Saved"); } catch(e) { addNewItemBlock(); setStatus("warn", "Draft"); } } 
        else { addNewItemBlock(); setStatus("warn", "Draft"); } 
        recalcAll(); validateGlobalSettingsUI(); 
    };
    originalInit();
  </script>
</body>
</html>