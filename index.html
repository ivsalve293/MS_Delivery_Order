<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Steel Mart MS Delivery Order | Smart Dispatch Sheet</title>
  <meta name="description" content="Create, validate, and print professional MS Delivery Orders." />
  <meta name="theme-color" content="#dc2626" />

  <style>
    :root{
      /* Theme */
      --bg:#fff5f5;
      --surface:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(220,38,38,.14);
      --border2:rgba(15,23,42,.08);

      --brand:#dc2626;
      --brand2:#b91c1c;
      --brand3:#ef4444;

      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;

      --radius:16px;
      --radius2:22px;

      --shadow-sm: 0 8px 20px rgba(15,23,42,.07);
      --shadow:    0 16px 44px rgba(15,23,42,.11);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans","Liberation Sans", sans-serif;

      --ring: 0 0 0 4px rgba(220,38,38,.22);

      --ease: cubic-bezier(.2,.8,.2,1);
      --ease2:cubic-bezier(.16,1,.3,1);
      --dur1: .16s;
      --dur2: .28s;

      /* ‚úÖ Wider desktop max */
      --page-max:1320px;

      /* Type scale */
      --fs-body: 14px;
      --fs-label: 12px;
      --fs-help: 12px;
      --fs-h2: 12px;
      --lh: 1.5;
      
      /* === Parallax Vars === */
      --plx-x: 0px;
      --plx-y: 0px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      line-height:var(--lh);
      text-rendering:optimizeLegibility;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;

      background:
        radial-gradient(900px 500px at 10% 0%, rgba(220,38,38,.14), transparent 60%),
        radial-gradient(700px 500px at 100% 10%, rgba(239,68,68,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(220,38,38,.08), transparent 60%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 55%, #ffffff 100%);
      overflow-x:hidden;
      font-size: var(--fs-body);
    }

    body::before{
      content:"";
      position:fixed; inset:-40% -30%;
      background:
        radial-gradient(closest-side, rgba(220,38,38,.06), transparent 65%),
        radial-gradient(closest-side, rgba(239,68,68,.05), transparent 70%);
      filter: blur(18px);
      /* Parallax Integration */
      transform: translate3d(var(--plx-x), var(--plx-y), 0);
      transition: transform 0.1s linear; 
      pointer-events:none;
      z-index:-1;
      opacity:.9;
    }
    
    @keyframes bgFloat{
      0%{ transform: translate(-2%, -1%) scale(1); }
      100%{ transform: translate(2%, 1%) scale(1.05); }
    }

    .wrap{max-width:var(--page-max);margin:0 auto;padding:18px 14px 50px;}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.80);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(220,38,38,.12);
    }
    .topbar-inner{
      max-width:var(--page-max);margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      gap:12px;
    }

    .brand{display:flex;align-items:center;gap:12px;min-width:240px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand3));
      color:white;font-weight:950;display:grid;place-items:center;
      box-shadow: 0 16px 34px rgba(220,38,38,.24);
      letter-spacing:.03em;
      position:relative; overflow:hidden;
      user-select:none;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-60% -40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.30), transparent);
      transform: rotate(25deg) translateX(-40%);
      animation: shimmer 3.2s var(--ease2) infinite;
    }
    @keyframes shimmer{
      0%{ transform: rotate(25deg) translateX(-55%); opacity:.30; }
      100%{ transform: rotate(25deg) translateX(55%); opacity:.22; }
    }

    .brand h1{
      margin:0;
      font-size:15px;
      line-height:1.15;
      letter-spacing:.01em;
      font-weight:950;
    }
    .brand p{
      margin:2px 0 0;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:800;
    }

    .actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(220,38,38,.14);
      box-shadow: var(--shadow-sm);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background:var(--ok);
      box-shadow:0 0 0 4px rgba(22,163,74,.12);
      flex:0 0 auto;
    }
    .dot.warn{background:var(--warn);box-shadow:0 0 0 4px rgba(245,158,11,.14);}
    .dot.danger{background:var(--danger);box-shadow:0 0 0 4px rgba(239,68,68,.14);}

    /* Buttons */
    .btn{
      border:1px solid rgba(220,38,38,.14);
      background:rgba(255,255,255,.92);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      transition: transform var(--dur1) var(--ease), box-shadow var(--dur1) var(--ease), border-color var(--dur1) var(--ease), background var(--dur1) var(--ease);
      box-shadow: var(--shadow-sm);
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-height:40px;
      user-select:none;
      position: relative; /* For Ripple */
      overflow: hidden;   /* For Ripple */
    }
    .btn:hover{transform:translateY(-1px);box-shadow: var(--shadow);}
    .btn:active{transform:translateY(0px) scale(.99);}
    .btn:focus{outline:none;box-shadow:var(--ring), var(--shadow);border-color:rgba(220,38,38,.35);}

    /* Ripple Effect CSS */
    span.ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple 600ms linear;
      background-color: rgba(220, 38, 38, 0.2); /* Brand color ripple */
      pointer-events: none;
    }
    @keyframes ripple {
      to { transform: scale(4); opacity: 0; }
    }

    .btn.primary{
      border-color:transparent;
      background: linear-gradient(90deg,var(--brand),var(--brand2));
      color:white;
      box-shadow: 0 18px 44px rgba(220,38,38,.24);
    }
    .btn.primary:hover{box-shadow: 0 22px 58px rgba(220,38,38,.28);}
    /* White ripple for primary buttons */
    .btn.primary span.ripple { background-color: rgba(255, 255, 255, 0.4); }

    .btn.secondary{
      background: rgba(255,255,255,.92);
      border-color: rgba(220,38,38,.20);
    }

    .btn.ghost{
      background:transparent;
      box-shadow:none;
      border-color:rgba(220,38,38,.12);
      color:#374151;
    }
    .btn.ghost:hover{background:rgba(220,38,38,.05);}

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
      align-items:start;
      margin-top:16px;
    }
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }

    /* Cards */
    .card{
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.88));
      border:1px solid rgba(220,38,38,.14);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
      transform: translateY(8px);
      opacity:0;
      animation: cardIn .50s var(--ease2) forwards;
    }
    @keyframes cardIn{ to{ transform: translateY(0); opacity:1; } }

    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(820px 160px at 18% 0%, rgba(220,38,38,.18), transparent 60%),
        radial-gradient(820px 160px at 82% 0%, rgba(239,68,68,.11), transparent 60%);
      opacity:.65;
      pointer-events:none;
    }
    .card::after{
      content:"";
      position:absolute; top:-90px; right:-90px;
      width:190px;height:190px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(220,38,38,.14), transparent 65%);
      pointer-events:none;
    }

    .card h2{
      margin:0 0 12px;
      font-size:var(--fs-h2);
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#991b1b;
      display:flex;align-items:center;gap:10px;
      font-weight:950;
    }
    .card h2::before{
      content:"";
      width:18px;height:6px;border-radius:99px;
      background: linear-gradient(90deg,var(--brand), #ff9aa7);
      box-shadow: 0 10px 18px rgba(220,38,38,.14);
      flex:0 0 auto;
    }

    /* Form grid */
    .grid{display:grid;grid-template-columns: repeat(12, 1fr);gap:12px;}
    .field{grid-column: span 6;}
    .field.span-12{grid-column: span 12;}
    .field.span-4{grid-column: span 4;}
    .field.span-3{grid-column: span 3;}
    @media (max-width: 720px){
      .field, .field.span-12, .field.span-4, .field.span-3{grid-column:span 12;}
    }

    label{
      display:flex;align-items:baseline;justify-content:space-between;
      gap:10px;
      font-size:var(--fs-label);
      font-weight:950;
      color:#374151;
      margin:2px 0 6px;
    }
    label .req{color:var(--danger);font-weight:950;margin-left:8px;}

    .freight-left-label label{ justify-content:flex-start; }

    input, textarea, select{
      width:100%;
      border:1px solid rgba(220,38,38,.16);
      background: rgba(255,255,255,.94);
      border-radius:14px;
      padding:11px 12px;
      font-size:13px;
      transition: border-color var(--dur1) var(--ease), box-shadow var(--dur1) var(--ease), transform var(--dur1) var(--ease), background var(--dur1) var(--ease);
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
    }
    textarea{min-height:82px;resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(55,65,81,.65)}
    input:focus, textarea:focus, select:focus{
      outline:none;
      border-color:rgba(220,38,38,.46);
      box-shadow:var(--ring);
      background:#fff;
      transform: translateY(-1px);
    }
    input[readonly]{background:#fff1f2;color:#6b7280;border-color:rgba(220,38,38,.10)}

    /* Inline Real-time Validation Styles */
    input.touched.is-valid, textarea.touched.is-valid, select.touched.is-valid {
      border-color: var(--ok);
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2316a34a' width='18px' height='18px'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px;
    }
    input.touched.is-invalid, textarea.touched.is-invalid, select.touched.is-invalid {
      border-color: var(--danger);
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
      animation: shake 0.3s var(--ease);
    }
    @keyframes shake {
      0%, 100% {transform: translateX(0);}
      25% {transform: translateX(-4px);}
      75% {transform: translateX(4px);}
    }

    .help{margin:8px 0 0;font-size:var(--fs-help);color:var(--muted)}
    .error{margin:6px 0 0;font-size:12px;color:var(--danger);min-height:16px}

    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:8px 0 6px;
    }
    .toolbar-left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toolbar-right{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}

    /* GLOBAL SETTINGS (Bill Type / OB) */
    .global-settings {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      padding: 12px 14px;
      background: #fef2f2;
      border: 1px dashed rgba(220,38,38,.20);
      border-radius: 16px;
      margin-bottom: 12px;
    }
    
    .bill-switch-global {
      display: flex;
      background: #fff;
      padding: 4px;
      border-radius: 12px;
      border: 1px solid rgba(220,38,38,.15);
      width: 140px;
    }
    .bill-switch-global label {
      flex: 1;
      margin: 0;
      text-align: center;
      padding: 8px 0;
      font-size: 13px;
      font-weight: 800;
      color: #64748b;
      cursor: pointer;
      border-radius: 9px;
      transition: all 0.2s ease;
      display: flex; align-items: center; justify-content: center;
    }
    .bill-switch-global input[type="radio"] { display: none; }
    .bill-switch-global input[type="radio"]:checked + span {
      background: var(--brand);
      color: white;
      box-shadow: 0 4px 12px rgba(220,38,38,.25);
    }
    .bill-switch-global span { width:100%; display:block; padding:2px 0; }
    
    .global-settings.error-border {
        border-color: var(--danger);
        background: #fff1f2;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }

    /* Tables */
    .table-wrap{
      width:100%;
      overflow:auto;
      border-radius:16px;
      -webkit-overflow-scrolling:touch;
      padding-bottom: 20px;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:visible; 
      border:1px solid rgba(220,38,38,.14);
      border-radius:16px;
      background:white;
      table-layout:auto; 
      box-shadow: 0 8px 22px rgba(15,23,42,.06);
    }

    table th, table td{ padding:10px 8px; }
    td input, td select{
      min-width:0; width:100%; max-width:100%;
      box-sizing:border-box; display:block;
    }

    thead th{
      font-size:10px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:#6b7280;
      background: linear-gradient(180deg, #fff, #fff5f5);
      border-bottom:1px solid rgba(220,38,38,.12);
      text-align:left;
      white-space:nowrap;
      position: sticky; top: 0; z-index: 2;
    }

    tbody td{ border-bottom:1px solid rgba(15,23,42,.06); vertical-align:top; }
    tbody tr:last-child td{border-bottom:none}
    .cell-center{text-align:center}
    .mini{padding:10px 10px;border-radius:12px;font-size:13px;}

    /* Swipe to Delete Styles */
    tbody tr {
      transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
      touch-action: pan-y;
      position: relative;
    }
    tbody tr.swiping {
      transition: none;
      background: #fef2f2;
    }

    .bd{
      background: #fff1f2;
      border:1px dashed rgba(220,38,38,.28);
      color:#9f1239;
      font-weight:900;
    }

    .icon{
      width:40px;height:40px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid rgba(220,38,38,.14);
      background: #fff;
      cursor:pointer;
      transition: transform var(--dur1) var(--ease), box-shadow var(--dur1) var(--ease), background var(--dur1) var(--ease);
      box-shadow: var(--shadow-sm);
      position: relative; overflow: hidden; /* For Ripple */
    }
    .icon:hover{transform: translateY(-1px);box-shadow: var(--shadow);background: #fff5f5;}

    .tfoot{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      margin-top:12px;flex-wrap:wrap;
    }
    .totalbox{
      display:flex;align-items:center;gap:10px;
      padding:11px 13px;border-radius:14px;
      border:1px solid rgba(220,38,38,.14);
      background: linear-gradient(180deg, #fff, #fff5f5);
      font-weight:950;
      box-shadow: var(--shadow-sm);
    }
    .totalbox span{
      color:var(--muted);font-weight:900;font-size:11px;
      letter-spacing:.14em;text-transform:uppercase
    }
    .totalbox strong{font-family:var(--mono);font-size:14px;color:#991b1b}

    /* Summary */
    .summary{
      position:sticky; top:74px;
      border:1px solid rgba(220,38,38,.20);
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,245,245,.92));
    }
    @media (max-width: 980px){ .summary{position:relative;top:auto} }

    .kv{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 0;
      border-bottom:1px dashed rgba(220,38,38,.18);
      gap:12px;
    }
    .kv:last-child{border-bottom:none}
    .kv span{
      color:var(--muted);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:950
    }
    .kv strong{
      font-family:var(--mono);
      font-size:13px;
      color:#991b1b;
      padding:6px 10px;
      border-radius:12px;
      background: rgba(220,38,38,.06);
      border:1px solid rgba(220,38,38,.10);
      min-width:120px;
      text-align:right;
    }

    .banner{
      display:none;
      margin:12px 0 0;
      padding:12px 14px;
      border:1px solid rgba(220,38,38,.18);
      background: linear-gradient(180deg, #fff, #fff5f5);
      color:#991b1b;
      border-radius:18px;
      box-shadow: var(--shadow-sm);
    }
    .banner.show{display:block}

    .toast{
      position:fixed;left:50%;bottom:18px;
      transform:translateX(-50%) translateY(10px);
      background:rgba(17,24,39,.92);color:white;
      padding:10px 12px;border-radius:999px;
      display:none;gap:10px;align-items:center;z-index:1000;
      box-shadow:0 22px 70px rgba(15,23,42,.35);
      font-size:13px;
      opacity:0;
      transition: opacity var(--dur2) var(--ease2), transform var(--dur2) var(--ease2);
    }
    .toast.show{display:flex; opacity:1; transform:translateX(-50%) translateY(0)}
    .toast button{
      border:1px solid rgba(255,255,255,.22);
      background:transparent;color:white;
      padding:6px 10px;border-radius:999px;
      cursor:pointer;font-weight:950;font-size:12px;
    }

    /* Floating Action Button (FAB) */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 28px;
      background: linear-gradient(135deg, var(--brand), var(--brand3));
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(220,38,38,.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 24px;
      cursor: pointer;
      z-index: 100;
      transition: transform 0.2s var(--ease), box-shadow 0.2s var(--ease);
      animation: fabEnter 0.6s var(--ease2) forwards;
      overflow: hidden; /* for ripple */
    }
    .fab:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 8px 24px rgba(220,38,38,.5);
    }
    .fab:active {
      transform: scale(0.95);
    }
    .fab-label {
      font-size: 0;
      width: 0;
      opacity: 0;
      transition: all 0.2s ease;
      overflow: hidden;
      white-space: nowrap;
    }
    /* Expand FAB on desktop hover (optional micro-interaction) */
    @media (min-width: 768px) {
      .fab:hover { width: auto; padding: 0 20px; border-radius: 99px; }
      .fab:hover .fab-label { font-size: 14px; width: auto; opacity: 1; margin-left: 8px; }
    }
    @keyframes fabEnter {
      from { transform: translateY(100px) scale(0.5); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    /* Print-only output */
    .print-only{display:none;}
    #printTableLayout{display:none;}

    @media print {
      @page {
        size: A4 portrait;
        margin: 5mm; /* Reduced margin to fit single page */
      }
      body {
        background:#fff; margin:0; padding:0;
        font-size: 11px; /* Smaller base font for print */
      }
      .topbar, .actions, .summary, .banner, .toast, .no-print, .fab { display:none !important; }
      .wrap { max-width:none; margin:0; padding:0; }
      .layout { grid-template-columns:1fr; gap:0; }
      main { display:none !important; }
      
      .print-only { display:block !important; }
      #printTableLayout { display:block; }
      .card { box-shadow:none; border:0; border-radius:0; padding:0; margin:0; opacity:1; transform:none; }
      .card::before, .card::after { display:none; }

      /* Print Table Styles */
      .print-main-title {
          text-align: center;
          font-size: 22px; /* Smaller Title */
          font-weight: bold;
          margin-bottom: 4px;
          font-family: "Calibri", sans-serif;
          color: #000;
      }
      .print-table {
          width: 100%;
          border-collapse: collapse;
          border: 2px solid #000;
          font-family: "Calibri", sans-serif;
          color: #000;
          font-size: 11px;
      }
      .print-table td, .print-table th {
          border: 1px solid #000;
          padding: 3px 4px; /* Tighter padding */
          vertical-align: middle;
      }
      .print-table .label { width: 110px; font-weight: normal; }
      .print-table .header-val { font-weight: normal; padding-left: 8px; }
      
      .print-bg-grey {
          background-color: #c0c0c0 !important;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
          font-weight: bold;
      }
      
      .print-table th { text-align: left; font-weight: normal; }
      .print-table .center { text-align: center; }
      .print-table .right { text-align: right; }
      
      .sub-table { width: 100%; border-collapse: collapse; border: none; }
      .sub-table td { border: 1px solid #000; padding: 2px 4px; }
    }
  </style>
</head>

<body>
  <div class="topbar no-print">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">SM</div>
        <div>
          <h1>MS Delivery Order</h1>
          <p>Smart Steel Dispatch Sheet</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="savePill" title="Autosave status">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">Draft</span>
        </div>

        <button class="btn ghost" type="button" data-action="reset">üßπ Reset</button>
        <button class="btn secondary" type="button" data-action="exportCsv">‚¨áÔ∏è Export CSV</button>
        <button class="btn secondary" type="button" data-action="copySummary">üìã Copy Summary</button>
        <button class="btn primary" type="button" data-action="print">üñ®Ô∏è Print</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="banner" id="resumeBanner">
      <strong>Resume draft?</strong>
      <span id="resumeMeta" style="margin-left:6px;"></span>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn secondary" type="button" id="resumeYes">‚Ü©Ô∏è Resume</button>
        <button class="btn ghost" type="button" id="resumeNo">üóëÔ∏è Discard</button>
      </div>
    </div>

    <div class="layout">
      <main>
        <form id="doForm" novalidate>
          <section class="card" aria-label="Party details">
            <h2>Party Details</h2>
            <div class="grid">
              <div class="field">
                <label for="dealerName">Dealer Name <span class="req">*</span></label>
                <input id="dealerName" name="dealerName" autocomplete="organization" required />
                <p class="error" id="err-dealerName" aria-live="polite"></p>
              </div>

              <div class="field">
                <label for="billingName">Billing Name <span class="req">*</span></label>
                <input id="billingName" name="billingName" required />
                <p class="error" id="err-billingName" aria-live="polite"></p>
              </div>

              <div class="field span-12">
                <label for="billingAddress">Billing Address <span class="req">*</span></label>
                <textarea id="billingAddress" name="billingAddress" rows="3" required></textarea>
                <p class="error" id="err-billingAddress" aria-live="polite"></p>
              </div>

              <div class="field span-12">
                <label for="dispatchAddress">Dispatch Address</label>
                <textarea id="dispatchAddress" name="dispatchAddress" rows="3"></textarea>
              </div>
            </div>
          </section>

          <section class="card" style="margin-top:14px" aria-label="Rates and Freight">
            <div class="toolbar">
              <div class="toolbar-left">
                <h2 style="margin:0">Item &amp; Sauda Rates</h2>
              </div>
              <div class="toolbar-right no-print">
                <button class="btn secondary" type="button" data-action="addItemRate">‚ûï Add Item</button>
              </div>
            </div>

            <!-- GLOBAL SETTINGS -->
            <div class="global-settings" id="globalSettings">
                <div style="flex:0 0 auto">
                    <label style="margin-bottom:4px; font-size:11px;">Bill Type <span class="req">*</span></label>
                    <div class="bill-switch-global">
                        <label>
                          <input type="radio" name="globalBillType" value="BILL">
                          <span>BILL</span>
                        </label>
                        <label>
                          <input type="radio" name="globalBillType" value="NC">
                          <span>NC</span>
                        </label>
                    </div>
                </div>
                
                <div style="flex:1">
                    <label for="globalOB" style="margin-bottom:4px; font-size:11px;">Order Block (OB)</label>
                    <input id="globalOB" type="number" step="0.01" placeholder="e.g. 500" style="background:#fff">
                </div>
            </div>
            <p class="error" id="err-globalSettings" style="margin-top:-8px; margin-bottom:12px;" aria-live="polite"></p>
            <!-- END GLOBAL SETTINGS -->

            <div class="table-wrap">
              <table aria-label="Item Sauda table">
                <thead>
                  <tr>
                    <th style="width:44px; text-align:center;">#</th>
                    <th style="width:250px;">ITEM</th>
                    <th style="width:140px;">SAUDA RATE</th>
                    <th style="width:64px;" class="cell-center no-print">REMOVE</th>
                  </tr>
                </thead>
                <tbody id="itemRatesBody"></tbody>
              </table>
            </div>

            <p class="error" id="err-itemRates" aria-live="polite"></p>

            <hr style="margin: 18px 0; border: 0; border-top: 1px dashed rgba(220,38,38,.18);">

            <div class="grid">
              <div class="field span-4">
                <label for="orderDate">Date <span class="req">*</span></label>
                <input id="orderDate" name="orderDate" type="date" required />
                <p class="error" id="err-orderDate" aria-live="polite"></p>
              </div>

              <div class="field span-4 freight-left-label">
                <label for="freight"><span style="color:var(--danger); font-weight:950; margin-right:4px;">*</span> Freight</label>
                <input id="freight" name="freight" type="text" placeholder="e.g. 1200 or Included" />
              </div>

              <div class="field span-4">
                <label for="lorryNo">Lorry No <span class="req">*</span></label>
                <input id="lorryNo" name="lorryNo" type="text" placeholder="e.g. MH12AB1234" required />
                <p class="error" id="err-lorryNo" aria-live="polite"></p>
              </div>
            </div>
          </section>

          <section class="card" style="margin-top:14px" aria-label="Items and rates">
            <div class="toolbar">
              <div class="toolbar-left">
                <h2 style="margin:0">Items</h2>
              </div>
              <div class="toolbar-right no-print">
                <button class="btn secondary" type="button" data-action="addLine">‚ûï Add line</button>
                <button class="btn" type="button" data-action="dupLast">üß¨ Duplicate last</button>
              </div>
            </div>

            <div class="table-wrap">
              <table aria-label="Items table">
                <thead>
                  <tr>
                    <th style="width:44px;">#</th>
                    <th style="width:200px;">Item</th>
                    <th style="width:260px;">Sizes</th>
                    <th style="width:120px;">Qty (MT)</th>
                    <th style="width:120px;">Net Rate</th>
                    <th style="width:auto;">Breakdown</th>
                    <th style="width:64px;" class="cell-center no-print">Remove</th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>

            <div class="tfoot">
              <div class="totalbox">
                <span>Total Qty</span>
                <strong id="totalQtyText">‚Äî</strong>
              </div>
            </div>
          </section>

          <section class="card" style="margin-top:14px" aria-label="Notes and signatures">
            <h2>Notes &amp; Signatures</h2>
            <div class="grid">
              <div class="field span-12">
                <label for="note">Note</label>
                <textarea id="note" name="note" rows="3" placeholder="Any dispatch notes..."></textarea>
              </div>
              <div class="field">
                <label for="signedBy">Order Signed By</label>
                <input id="signedBy" name="signedBy" type="text" />
              </div>
              <div class="field">
                <label for="approvedBy">Approved By</label>
                <input id="approvedBy" name="approvedBy" type="text" />
              </div>
            </div>
          </section>
        </form>
      </main>

      <aside class="summary card" aria-label="Summary">
        <h2>Summary</h2>
        <div class="kv"><span>Total Qty</span><strong id="sumTotalQty">‚Äî</strong></div>
        <div class="kv"><span>Lines</span><strong id="sumItems">0</strong></div>
        <div class="kv"><span>Status</span><strong id="sumStatus">Draft</strong></div>
        <div class="kv"><span>Last Save</span><strong id="sumSavedAt">‚Äî</strong></div>
      </aside>
    </div>

    <!-- PRINT LAYOUT START -->
    <div id="printTableLayout" class="print-only">
      <div class="print-main-title">Delivery Order</div>
      <table class="print-table">
        <!-- Dealer/Billing Info -->
        <tr>
          <td class="label">Dealer Name</td>
          <td colspan="4" class="header-val" id="p-dealerName"></td>
        </tr>
        <tr>
          <td class="label">Billing Name</td>
          <td colspan="4" class="header-val" id="p-billingName"></td>
        </tr>
        <tr>
          <td class="label">Billing Address</td>
          <td colspan="4" class="header-val" id="p-billingAddress"></td>
        </tr>
        <tr>
          <td class="label">Dispatch Address</td>
          <td colspan="4" class="header-val" id="p-dispatchAddress"></td>
        </tr>
        <tr>
          <td class="label">Bill Type</td>
          <td class="header-val" id="p-billType" style="width:300px"></td>
          <td class="label" style="width:50px">Date</td>
          <td colspan="2" class="header-val" id="p-date"></td>
        </tr>

        <!-- SPLIT SECTION: Item Rates (Left) vs Transport (Right) -->
        <tr>
            <!-- Left Side: Item & Sauda Rates Table -->
            <td colspan="2" style="padding:0; vertical-align:top; border-right:1px solid #000">
                <table class="sub-table">
                    <thead>
                        <tr>
                            <th colspan="2" class="center" style="font-weight:bold">Item &amp; Sauda Rates</th>
                        </tr>
                        <tr>
                            <td style="font-weight:normal">Item</td>
                            <td style="font-weight:normal">Sauda Rate</td>
                        </tr>
                    </thead>
                    <tbody id="p-ratesBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </td>

            <!-- Right Side: Transport Info -->
            <td colspan="3" style="padding:0; vertical-align:top;">
                 <table class="sub-table">
                    <tr>
                        <td class="label" style="border-top:0; border-left:0;">Freight</td>
                        <td class="header-val" id="p-freight" style="border-top:0; border-right:0;"></td>
                    </tr>
                    <tr>
                        <td class="label" style="border-left:0;">Lorry No</td>
                        <td class="header-val" id="p-lorry" style="border-right:0;"></td>
                    </tr>
                    <tr>
                        <td class="label" style="border-left:0; border-bottom:0">OB</td>
                        <td class="header-val" id="p-ob" style="border-right:0; border-bottom:0"></td>
                    </tr>
                 </table>
            </td>
        </tr>

        <!-- Spacer Row -->
        <tr style="height:6px; background:#999;">
            <td colspan="5" style="background:#999; border:1px solid #000;"></td>
        </tr>
      </table>
      
      <!-- MAIN ITEMS TABLE -->
      <table class="print-table" style="border-top:0; margin-top:-2px;">
         <thead>
             <tr class="print-bg-grey">
                 <th class="right" style="width:30px;">Sr</th>
                 <th style="width:140px;">Item</th>
                 <th>Sizes</th>
                 <th class="right" style="width:70px;">Qty (MT)</th>
                 <th class="right" style="width:80px;">Net Rate</th>
                 <th>Breakdown</th>
             </tr>
         </thead>
         <tbody id="p-itemsBody"></tbody>
         <!-- Total Row -->
         <tr>
             <td colspan="3" class="right" style="border-right:1px solid #000">Total</td>
             <td class="right" style="font-weight:bold" id="p-finalQty"></td>
             <td colspan="2" style="background:#e5e5e5"></td>
         </tr>
      </table>

      <!-- FOOTER TABLE -->
      <table class="print-table" style="border-top:0; margin-top:8px;">
        <tr>
          <td style="width:80px; vertical-align:middle; text-align:center;">Note:</td>
          <td id="p-note" style="height:40px; vertical-align:top; padding:4px;"></td>
        </tr>
      </table>
      
      <table class="print-table" style="border-top:0; margin-top:-2px;">
         <tr style="height:45px;">
             <td style="width:50%; vertical-align:bottom; padding-bottom:4px;">Order Signed</td>
             <td style="width:50%; vertical-align:bottom; padding-bottom:4px; border-left:1px solid #000;">By Approved By</td>
         </tr>
      </table>
    </div>
    <!-- PRINT LAYOUT END -->

  </div>

  <div class="toast" id="toast">
    <span id="toastText">Deleted line</span>
    <button type="button" id="toastUndo">UNDO</button>
  </div>
  
  <!-- Floating Action Button (FAB) -->
  <button class="fab no-print" id="fab" title="Add Line & Check">
    <span>+</span>
    <span class="fab-label">Add Line</span>
  </button>

  <!-- Templates -->
  <template id="itemRateRowTpl">
    <tr>
      <td class="cell-center" data-label="Sr"><strong class="ir-sr"></strong></td>
      <td data-label="Item" style="vertical-align: top;">
        <select class="ir-item mini"></select>
      </td>
      <td data-label="Sauda Rate" style="vertical-align: top;">
        <input class="ir-sauda mini" type="number" step="0.01" min="0" inputmode="decimal" placeholder="e.g. 52000" />
      </td>
      <td class="cell-center no-print" data-label="Remove" style="vertical-align: top;">
        <button type="button" class="icon" data-action="removeItemRate" title="Remove">üóëÔ∏è</button>
      </td>
    </tr>
  </template>

  <template id="itemRowTpl">
    <tr>
      <td class="cell-center" data-label="Sr"><strong class="sr"></strong></td>
      <td data-label="Item"><select class="rowItem mini"></select></td>
      <td data-label="Sizes" class="sizeCell"></td>
      <td data-label="Qty (MT)"><input class="qty mini" type="number" step="0.001" min="0" inputmode="decimal" placeholder="0.000" /></td>
      <td data-label="Net Rate"><input class="rate mini" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" readonly /></td>
      <td data-label="Breakdown"><input class="bd mini bd" type="text" readonly placeholder="‚Äî" /></td>
      <td class="cell-center no-print" data-label="Remove"><button type="button" class="icon" data-action="remove" title="Remove line">üóëÔ∏è</button></td>
    </tr>
  </template>

  <script>
  const ITEM_LIST = ["MS Pipe","MS Angle","MS Channel","Binding Wire","Nails","Sqr Bar","Round Bar","Flats","HR Pipe","MS Structure ISMC","Heavy Structure ISMB"];
  const SIZE_SD_LIST = {
    "MS Pipe": [["0.75\" 19x19(1.2) 4kg",7000],["0.75\" 19x19(1.6) 5kg",6500],["0.75\" 19x19(2.0) 6kg",6000],["1\" 25x25(1.2) 6kg",5000],["1\" 25x25(1.6) 7kg",4000],["1\" 25x25(2.0) 9kg",4000],["1\" 25x25(2.5) 11.5kg",4000],["1.25\" 32x32(1.2) 7kg",5000],["1.25\" 32x32(1.6) 9kg",3500],["1.25\" 32x32(2.0) 11kg",3500],["1.25\" 32x32(2.5) 15.5kg",3500],["1.25\" 32x32(2.9) 17.5kg",3500],["1.5\" 38x38(1.2) 8.5kg",4500],["1.5\" 38x38(1.6) 11kg",3000],["1.5\" 38x38(2.0) 13kg",3000],["1.5\" 38x38(2.5) 17kg",3000],["1.5\" 38x38(2.9) 19kg",3000],["47x47(1.6) 14kg",3000],["2\" 50x50(1.2) 11kg",4000],["2\" 50x50(1.6) 15kg",3000],["2\" 50x50(2.0) 18kg",3000],["2\" 50x50(2.5) 23kg",3000],["2\" 50x50(2.9) 26kg",3000],["2.5\" 60x60(1.6) 17kg",3800],["2.5\" 60x60(2.0) 22kg",3300],["2.5\" 60x60(2.5)28kg",3300],["3\" 72x72(1.6) 21kg",5000],["3\" 72x72(2.0) 27kg",4000],["3\" 72x72(2.5) 33kg",4000],["3\" 72x72(2.9) 39kg",4000],["1.5\"x 0.75\" 40x20 (1.2)7kg",4900],["1.5\"x 0.75\" 40x20 (1.6) 9kg",3900],["1.5\"x 0.75\" 40x20 (2.0) 11kg",3900],["1.5\"x 0.75\" 40x20 (2.5) 15kg",3900],["2\"x1\" 50x25 (1.2) 8.5kg",4000],["2\"x1\" 50x25 (1.6) 11kg",3000],["2\"x1\" 50x25 (2.0) 13kg",3000],["2\"x1\" 50x25 (2.5) 18kg",3000],["2\"x1\" 50x25 (2.9) 21kg",3000],["60x40 (1.2) 10kg",4000],["60x40 (1.6) 14kg",3000],["60x40 (2.0) 17kg",3000],["60x40 (2.5) 23kg",3000],["60x40 (2.9) 27kg",3000],["75x25 (1.2) 10kg",4000],["75x25 (1.6) 14kg",3000],["75x25 (2.0) 17kg",3000],["75x25 (2.5) 22kg",3000],["75x25 (1.2) 25kg",3000],["80x40 (1.6) 17kg",3800],["80x40 (2.0) 22kg",3300],["80x40 (2.5) 28kg",3300],["80x40 (2.9) 31kg",3300],["96x48 (1.6) 21kg",5000],["96x48 (2.0) 27kg",4000],["96x48 (2.5) 33kg",4000],["96x48 (2.9) 39kg",4000]],
    "MS Angle": [["25x3 (6.2 kg)",7800],["25x5 (10.5 kg)",7500],["32x3 (8 kg )",7500],["35x3 (10.6)",7800],["35x4 (12kg)",7500],["35x5 (14.5kg)",7200],["40x4 (14kg)",7500],["40x5 (18kg)",7000],["50x4 (17.5kg)",7500],["50x5 (21.5kg)",6400],["50x6 (26.6kg)",6100],["65x5(28.5 kg)",6400],["65x6(34.5)",6100],["75x5",6400]],
    "MS Channel": [["C 75*40 (3\"X1.5\") 36KG",6400],["C 70*35 (3\"X1.5\") 22KG",7200],["C 100*50 (4\"x 2\") 56KG",6100],["C 95x45 (4\"x2\") 36kg",7200]],
    "Binding Wire": [["BW 18G Random",0],["BW 18G 10Kg",2500],["BW 18G 25Kg",0],["BW 20G 10Kg",3500],["BW 20G 25Kg",0]],
    "Nails": [["Nails 2\"",0],["Nails 2.5\"",0],["Nails 3\"",0]],
    "Sqr Bar": [["8mm",1500],["10mm",0],["12mm",0]],
    "Round Bar": [["8mm",0],["10mm",0],["12mm",0],["16mm",0]],
    "Flats": [["F 20x5",0],["F 25x3",0],["F 25x5",0],["F 32x5",0],["F 40x3",0],["F 40x5",0],["F 40x6",0],["F 50x5",0],["F 50x6",0]],
    "HR Pipe": [["1.25\" 41 OD (2.0) 8.8kg", 500],["1.5\" 48.3 OD (2.0) 12.9kg", 500],["2.0\" 60.3OD (2.0) 17.5kg", 500],["4\" 114.3 OD (2.0) 33.8kg", 500],["0.75\"x0.75\" 19X19 (2.0) 6.91kg", 500],["1\" 25X25 (2.0) 8.9kg", 500],["1.25\" 32X32 (2.0) 11.48kg", 500],["1.5\" 38X38 (2.0) 13.8kg", 500],["2\" 50X50 (2.0) 18.4kg", 500],["2.5\" 60X60 (2.0) 22.3kg", 500],["3\" 72X72 (2.0) 26.8kg", 500],["4\" 100X100 (2.0) 37.5kg", 500],["2\"x1\" 50X25 (2.0) 13.98kg", 500],["2.5\"x1.5\" 60x40 (2.0) kg", 500],["4\"x2\" 96X48 (2.0) 22.2kg", 500],["1.25\" 41 OD (2.3) 10.38kg", 500],["1.5\" 48.3 OD (2.3) 15.91kg", 500],["2.0\" 60.3OD (2.3) 20.05kg", 500],["4\" 114.3 OD (2.3) 38.73kg", 500],["0.75\"x0.75\" 19X19 (2.3) 7.35kg", 500],["1\" 25X25 (2.3) 9.99kg", 500],["1.25\" 32X32 (2.3) 13.08kg", 500],["1.5\" 38X38 (2.3) 15.72kg", 500],["2\" 50X50 (2.3) 21kg", 500],["2.5\" 60X60 (2.3) 25.4kg", 500],["3\" 72X72 (2.3) 60.69kg", 500],["4\" 100X100 (2.3) 43kg", 500],["2\"x1\" 50X25 (2.3) 15.3kg", 500],["2.5\"x1.5\" 60x40 (2.3) kg", 500],["1\"x1.5\" 80X40 (2.3) 25.6kg", 500],["4\"x2\" 96X48 (2.3) 30.69kg", 500],["5\" 139.7 OD (2.0) 41.4kg", 1500],["6\" 165.1 OD (2.0) 48.2kg", 1500],["6\" 150X150 (2.0) 56.66kg", 1500],["5\"X2.5 122X62 (2.0) 34.5kg", 1500],["6\"X3\" 150X75 (2.0) 42.3kg", 1500],["6\"X4\" 145X82 (2.0) 42.68kg", 1500],["8\"X4\" 200X100 (2.0) 56.66kg", 1500],["5\" 139.7 OD (2.3) 47.51kg", 1500],["6\" 165.1 OD (2.3) 56.29kg", 1500],["6\" 150X150 (2.3) 85.03kg", 1500],["5\"X2.5 122X62 (2.3) 39.49kg", 1500],["6\"X3\" 150X75 (2.3) 48.52kg", 1500],["6\"X4\" 145X82 (2.3) 48.96kg", 1500],["8\"X4\" 200X100 (2.3) 85.03kg", 1500]]
  };
  const SIZE_SD_MAP = Object.create(null); const SIZE_KEYS = Object.create(null);
  for (const [item, list] of Object.entries(SIZE_SD_LIST)){ const m = Object.create(null); const keys = []; for (const [size, sdRaw] of list){ const sd = Number.isFinite(+sdRaw) ? +sdRaw : 0; const k = String(size || "").trim(); if (!k) continue; m[k] = sd; keys.push(k); } SIZE_SD_MAP[item] = m; SIZE_KEYS[item] = keys; }
  const orderDate = document.getElementById("orderDate"); const TODAY = new Date().toISOString().slice(0,10); orderDate.max = TODAY; orderDate.value = TODAY;
  const form = document.getElementById("doForm"); const itemRatesBody = document.getElementById("itemRatesBody"); const itemRateRowTpl = document.getElementById("itemRateRowTpl"); const itemsBody = document.getElementById("itemsBody"); const itemRowTpl = document.getElementById("itemRowTpl"); const totalQtyText = document.getElementById("totalQtyText"); const statusDot = document.getElementById("statusDot"); const statusText = document.getElementById("statusText"); const sumTotalQty = document.getElementById("sumTotalQty"); const sumItems = document.getElementById("sumItems"); const sumStatus = document.getElementById("sumStatus"); const sumSavedAt = document.getElementById("sumSavedAt"); const resumeBanner = document.getElementById("resumeBanner"); const resumeMeta = document.getElementById("resumeMeta"); const resumeYes = document.getElementById("resumeYes"); const resumeNo = document.getElementById("resumeNo"); const toast = document.getElementById("toast"); const toastText = document.getElementById("toastText"); const toastUndo = document.getElementById("toastUndo"); let lastDeleted = null; let toastTimer = null;
  const globalSettingsDiv = document.getElementById("globalSettings"); const globalOBInput = document.getElementById("globalOB"); const errGlobalSettings = document.getElementById("err-globalSettings");
  const STORAGE_KEY = "steelMart.deliveryOrder.v16_final_layout"; let suppressSave = false;
  function fmtTime(ts){ try{ const d = new Date(ts); return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" }); }catch(_){ return "‚Äî"; } }
  function setStatus(kind, label){ statusText.textContent = label; sumStatus.textContent = label; statusDot.classList.remove("warn","danger"); if (kind === "warn") statusDot.classList.add("warn"); if (kind === "danger") statusDot.classList.add("danger"); }
  function showToast(message, undoFn){ toastText.textContent = message; toast.classList.add("show"); lastDeleted = undoFn || null; clearTimeout(toastTimer); toastTimer = setTimeout(() => { toast.classList.remove("show"); lastDeleted = null; }, 4500); }
  toastUndo.addEventListener("click", () => { if (lastDeleted) lastDeleted(); toast.classList.remove("show"); lastDeleted = null; });
  function setErr(id, msg){ const p = document.getElementById("err-" + id); if (p) p.textContent = msg || ""; }
  function getFreightNumber(){ const raw = (document.getElementById("freight")?.value || "").trim(); const n = parseFloat(raw); return Number.isFinite(n) ? n : 0; }
  function getGlobalBillType() { const checked = document.querySelector('input[name="globalBillType"]:checked'); return checked ? checked.value : ""; }
  function getGlobalOB() { const val = parseFloat(globalOBInput.value); return Number.isFinite(val) ? val : 0; }
  function getGlobalOBString() { const val = globalOBInput.value.trim(); return val ? val : ""; }
  function buildWhatsAppText(){ const data = collectData(); const clean = v => { const s = String(v ?? "").trim(); return (!s || s === "-" || s === "‚Äî") ? "" : s; }; let out = [`${clean(data.dealerName)} ‚Äì MS Delivery Order`]; out.push(`Date: ${clean(data.orderDate)}`); out.push(`Bill Type: ${clean(data.billType)}`); if(data.ob) out.push(`OB: ${data.ob}`); out.push(""); data.items.forEach((it, idx) => { if(!it.item) return; out.push(`${idx+1}. ${it.item} - ${it.size} - ${it.qty}MT`); }); out.push(""); let totalQty = 0; data.items.forEach(it => totalQty += (parseFloat(it.qty)||0)); out.push(`Total Qty: ${totalQty.toFixed(3)} MT`); if(data.lorryNo) out.push(`Lorry: ${data.lorryNo}`); if(data.freight) out.push(`Freight: ${data.freight}`); return out.join("\n"); }
  function renderPrintTable() { const data = collectData(); document.getElementById("p-dealerName").textContent = data.dealerName; document.getElementById("p-billingName").textContent = data.billingName; document.getElementById("p-billingAddress").textContent = data.billingAddress; document.getElementById("p-dispatchAddress").textContent = data.dispatchAddress; document.getElementById("p-billType").textContent = data.billType; const dateStr = data.orderDate ? new Date(data.orderDate).toLocaleDateString("en-GB") : ""; document.getElementById("p-date").textContent = dateStr; document.getElementById("p-freight").textContent = data.freight; document.getElementById("p-lorry").textContent = data.lorryNo; document.getElementById("p-ob").textContent = data.ob; const ratesBody = document.getElementById("p-ratesBody"); ratesBody.innerHTML = ""; data.itemRates.forEach(r => { if(r.item && r.sauda) { const row = document.createElement("tr"); const cellItem = document.createElement("td"); cellItem.textContent = r.item; const cellRate = document.createElement("td"); cellRate.textContent = r.sauda; row.appendChild(cellItem); row.appendChild(cellRate); ratesBody.appendChild(row); } }); const tbody = document.getElementById("p-itemsBody"); tbody.innerHTML = ""; let totalQty = 0; data.items.forEach((it, idx) => { const tr = document.createElement("tr"); const tdSr = document.createElement("td"); tdSr.className = "right"; tdSr.textContent = idx + 1; tr.appendChild(tdSr); const tdItem = document.createElement("td"); tdItem.textContent = it.item || ""; tr.appendChild(tdItem); const tdSize = document.createElement("td"); tdSize.textContent = it.size || ""; tr.appendChild(tdSize); const qtyNum = parseFloat(it.qty) || 0; totalQty += qtyNum; const tdQty = document.createElement("td"); tdQty.className = "right"; tdQty.textContent = qtyNum > 0 ? qtyNum.toFixed(3) : ""; tr.appendChild(tdQty); const tdRate = document.createElement("td"); tdRate.className = "right"; tdRate.textContent = it.rate || ""; tr.appendChild(tdRate); const tdBd = document.createElement("td"); tdBd.style.fontSize = "11px"; tdBd.textContent = it.bd || ""; tr.appendChild(tdBd); tbody.appendChild(tr); }); document.getElementById("p-finalQty").textContent = totalQty.toFixed(3) + " MT"; document.getElementById("p-note").textContent = data.note; }
  function buildItemSelect(selectEl, current=""){ selectEl.innerHTML = ""; const opt0 = document.createElement("option"); opt0.value = ""; opt0.textContent = "Select Item"; selectEl.appendChild(opt0); for (const it of ITEM_LIST){ const o = document.createElement("option"); o.value = it; o.textContent = it; selectEl.appendChild(o); } selectEl.value = current || ""; }
  function renumberItemRates(){ Array.from(itemRatesBody.querySelectorAll("tr")).forEach((tr, i) => { tr.querySelector(".ir-sr").textContent = String(i + 1); }); }
  function collectItemRates(){ return Array.from(itemRatesBody.querySelectorAll("tr")).map(tr => { return { item: tr.querySelector(".ir-item")?.value || "", sauda: tr.querySelector(".ir-sauda")?.value || "" }; }); }
  function getRateMetaForItem(item){ const rates = collectItemRates(); const hit = rates.find(r => (r.item||"").trim() === item); if (!hit) return null; const sauda = parseFloat(hit?.sauda); return { sauda: Number.isFinite(sauda) ? sauda : null }; }
  function addItemRateRow(prefill=null){ const node = itemRateRowTpl.content.cloneNode(true); const tr = node.querySelector("tr"); const sel = tr.querySelector(".ir-item"); buildItemSelect(sel, prefill?.item || ""); tr.querySelector(".ir-sauda").value = prefill?.sauda || ""; itemRatesBody.appendChild(tr); renumberItemRates(); }
  function syncLineItemSelects(){ const allowed = collectItemRates().map(r => (r.item||"").trim()).filter(Boolean); for (const tr of itemsBody.querySelectorAll("tr")){ const sel = tr.querySelector(".rowItem"); const current = sel?.value || ""; sel.innerHTML = ""; const opt0 = document.createElement("option"); opt0.value = ""; opt0.textContent = allowed.length ? "Select Item" : "Add Item above"; sel.appendChild(opt0); for (const it of allowed){ const o = document.createElement("option"); o.value = it; o.textContent = it; sel.appendChild(o); } sel.value = allowed.includes(current) ? current : ""; rebuildSizeFieldForRow(tr); recalcRow(tr); } }
  function makeSizeField(item, currentValue=""){ const sizes = SIZE_KEYS[item] || null; const wrap = document.createElement("div"); wrap.style.display = "grid"; wrap.style.gap = "6px"; const inp = document.createElement("input"); inp.className = "size mini"; inp.type = "text"; inp.placeholder = sizes && sizes.length ? "Type to search size‚Ä¶" : "Enter size"; inp.value = currentValue || ""; if (sizes && sizes.length){ const listId = "dl_" + Math.random().toString(36).slice(2); inp.setAttribute("list", listId); const dl = document.createElement("datalist"); dl.id = listId; for (const s of sizes){ const opt = document.createElement("option"); opt.value = s; dl.appendChild(opt); } wrap.appendChild(inp); wrap.appendChild(dl); return wrap; } wrap.appendChild(inp); return wrap; }
  function rebuildSizeFieldForRow(tr){ const item = (tr.querySelector(".rowItem")?.value || "").trim(); const sizeCell = tr.querySelector(".sizeCell"); const existing = tr.querySelector(".size"); const current = existing?.value || ""; sizeCell.textContent = ""; sizeCell.appendChild(makeSizeField(item, current)); }
  
  // === MODIFIED: Breakdown shows value only, not "Freight" text ===
  function calcNetRate(meta, item, size){ 
    const sauda = meta?.sauda; 
    if (!Number.isFinite(sauda) || sauda <= 0) return { rate:"", bd:"Enter Sauda Rate for this Item" }; 
    const sd = getSD(item, size); 
    function getSD(item, size){ 
      const m = SIZE_SD_MAP[item]; 
      if (!m) return 0; 
      const key = String(size || "").trim(); 
      const v = m[key]; 
      return Number.isFinite(+v) ? +v : 0; 
    } 
    const globalBillType = getGlobalBillType(); 
    if (!globalBillType) return { rate: "", bd: "Select Bill Type (Bill/NC)" }; 
    const isNC = (globalBillType === "NC"); 
    const freight = getFreightNumber(); 
    const base = sauda + sd + 160 - (isNC ? 3000 : 0) + freight; 
    const finalRate = Math.round(base * 1.18); 
    // Removed "Freight" text here:
    const bd = `${sauda} + ${sd} + 160${isNC ? " - 3000" : ""} + ${freight} + 18%`; 
    return { rate: finalRate, bd }; 
  }

  function recalcRow(tr){ const item = (tr.querySelector(".rowItem")?.value || "").trim(); const sizeVal = (tr.querySelector(".size")?.value || "").trim(); const rateEl = tr.querySelector(".rate"); const bdEl = tr.querySelector(".bd"); if (!rateEl || !bdEl) return; if (!item || !sizeVal){ rateEl.value = ""; bdEl.value = ""; return; } const meta = getRateMetaForItem(item); const out = calcNetRate(meta, item, sizeVal); rateEl.value = out.rate; bdEl.value = out.bd; }
  function renumberLines(){ Array.from(itemsBody.querySelectorAll("tr")).forEach((tr, i) => { tr.querySelector(".sr").textContent = String(i + 1); }); sumItems.textContent = String(itemsBody.querySelectorAll("tr").length); }
  function recalcTotals(){ let total = 0; for (const tr of itemsBody.querySelectorAll("tr")){ const v = parseFloat(tr.querySelector(".qty")?.value || ""); if (Number.isFinite(v)) total += v; } const shown = total > 0 ? total.toFixed(3) : "‚Äî"; totalQtyText.textContent = shown; sumTotalQty.textContent = shown; }
  function addLine(prefill=null){ const node = itemRowTpl.content.cloneNode(true); const tr = node.querySelector("tr"); const sel = tr.querySelector(".rowItem"); const allowed = collectItemRates().map(r => (r.item||"").trim()).filter(Boolean); sel.innerHTML = ""; const opt0 = document.createElement("option"); opt0.value = ""; opt0.textContent = allowed.length ? "Select Item" : "Add Item above"; sel.appendChild(opt0); for (const it of allowed){ const o = document.createElement("option"); o.value = it; o.textContent = it; sel.appendChild(o); } sel.value = prefill?.item || ""; tr.querySelector(".sizeCell").appendChild(makeSizeField(sel.value || "", prefill?.size || "")); tr.querySelector(".qty").value = prefill?.qty || ""; tr.querySelector(".rate").value = prefill?.rate || ""; tr.querySelector(".bd").value = prefill?.bd || ""; itemsBody.appendChild(tr); renumberLines(); recalcRow(tr); recalcTotals(); }
  function duplicateLast(){ const rows = Array.from(itemsBody.querySelectorAll("tr")); if (!rows.length) return addLine(); const last = rows[rows.length - 1]; addLine({ item: last.querySelector(".rowItem")?.value || "", size: last.querySelector(".size")?.value || "", qty: "", rate: last.querySelector(".rate")?.value || "", bd: last.querySelector(".bd")?.value || "", }); }
  function collectData(){ return { dealerName: document.getElementById("dealerName").value || "", billingName: document.getElementById("billingName").value || "", billingAddress: document.getElementById("billingAddress").value || "", dispatchAddress: document.getElementById("dispatchAddress").value || "", orderDate: document.getElementById("orderDate").value || "", freight: document.getElementById("freight").value || "", lorryNo: document.getElementById("lorryNo").value || "", note: document.getElementById("note").value || "", signedBy: document.getElementById("signedBy").value || "", approvedBy: document.getElementById("approvedBy").value || "", billType: getGlobalBillType(), ob: getGlobalOBString(), itemRates: collectItemRates(), items: Array.from(itemsBody.querySelectorAll("tr")).map(tr => ({ item: tr.querySelector(".rowItem")?.value || "", size: tr.querySelector(".size")?.value || "", qty: tr.querySelector(".qty")?.value || "", rate: tr.querySelector(".rate")?.value || "", bd: tr.querySelector(".bd")?.value || "", })) }; }
  function applyData(data){ if (!data) return; document.getElementById("dealerName").value = data.dealerName || ""; document.getElementById("billingName").value = data.billingName || ""; document.getElementById("billingAddress").value = data.billingAddress || ""; document.getElementById("dispatchAddress").value = data.dispatchAddress || ""; const d = (data.orderDate || TODAY); orderDate.max = TODAY; orderDate.value = (d && d <= TODAY) ? d : TODAY; document.getElementById("freight").value = data.freight || ""; document.getElementById("lorryNo").value = data.lorryNo || ""; document.getElementById("note").value = data.note || ""; document.getElementById("signedBy").value = data.signedBy || ""; document.getElementById("approvedBy").value = data.approvedBy || ""; const billType = data.billType; if (billType) { const radio = document.querySelector(`input[name="globalBillType"][value="${billType}"]`); if(radio) radio.checked = true; } else { const checked = document.querySelector('input[name="globalBillType"]:checked'); if(checked) checked.checked = false; } document.getElementById("globalOB").value = data.ob || ""; itemRatesBody.innerHTML = ""; const ir = Array.isArray(data.itemRates) ? data.itemRates : []; if (!ir.length) addItemRateRow(); else ir.forEach(r => addItemRateRow(r)); renumberItemRates(); itemsBody.innerHTML = ""; const lines = Array.isArray(data.items) ? data.items : []; if (!lines.length) addLine(); else lines.forEach(l => addLine(l)); renumberLines(); syncLineItemSelects(); recalcTotals(); }
  function saveDraft(){ if (suppressSave) return; const payload = { savedAt: Date.now(), data: collectData() }; localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); sumSavedAt.textContent = fmtTime(payload.savedAt); setStatus("ok", "Saved"); }
  function clearDraft(){ localStorage.removeItem(STORAGE_KEY); sumSavedAt.textContent = "‚Äî"; }
  function showResume(payload){ resumeMeta.textContent = `Last saved: ${fmtTime(payload.savedAt)}`; resumeBanner.classList.add("show"); resumeYes.onclick = () => { resumeBanner.classList.remove("show"); suppressSave = true; applyData(payload.data); suppressSave = false; setStatus("ok","Resumed"); saveDraft(); }; resumeNo.onclick = () => { resumeBanner.classList.remove("show"); clearDraft(); setStatus("warn","Draft"); }; }
  function checkResume(){ const raw = localStorage.getItem(STORAGE_KEY); if (!raw) return; try{ const payload = JSON.parse(raw); if (payload?.data) showResume(payload); }catch(_){} }
  let saveTimer = null; function saveSoon(){ clearTimeout(saveTimer); setStatus("warn","Saving‚Ä¶"); saveTimer = setTimeout(saveDraft, 650); }
  
  // === MODIFIED: Added Lorry No Validation ===
  function validateForm({ forPrint=false } = {}){ 
    setErr("dealerName",""); setErr("billingName",""); setErr("billingAddress",""); setErr("orderDate",""); setErr("lorryNo", ""); // Reset lorry error
    errGlobalSettings.textContent = ""; globalSettingsDiv.classList.remove("error-border"); document.getElementById("err-itemRates").textContent = ""; 
    const data = collectData(); 
    let issues = []; 
    if (!data.dealerName.trim()){ issues.push("Dealer Name is required."); setErr("dealerName","Required"); } 
    if (!data.billingName.trim()){ issues.push("Billing Name is required."); setErr("billingName","Required"); } 
    if (!data.billingAddress.trim()){ issues.push("Billing Address is required."); setErr("billingAddress","Required"); } 
    if (!data.orderDate.trim()){ issues.push("Date is required."); setErr("orderDate","Required"); } 
    
    // Validate Lorry No
    if (!data.lorryNo.trim()){ issues.push("Lorry No is required."); setErr("lorryNo","Required"); }

    if (!data.billType) { issues.push("Bill Type (BILL/NC) must be selected."); errGlobalSettings.textContent = "Required: Select Bill Type"; globalSettingsDiv.classList.add("error-border"); } 
    if (data.orderDate && data.orderDate > TODAY){ issues.push("Date cannot be in the future."); setErr("orderDate","Future date not allowed"); } 
    const hasAnyLine = data.items.some(it => (it.item||"").trim() || (it.size||"").trim() || (it.qty||"").trim()); 
    if (hasAnyLine){ const validRates = data.itemRates.filter(r => (r.item||"").trim()).every(r => Number.isFinite(parseFloat(r.sauda)) && parseFloat(r.sauda) > 0); const hasAtLeastOneRate = data.itemRates.some(r => (r.item||"").trim() && Number.isFinite(parseFloat(r.sauda)) && parseFloat(r.sauda) > 0); if (!hasAtLeastOneRate || !validRates){ issues.push("Add Item & Sauda Rate (Sauda > 0)."); document.getElementById("err-itemRates").textContent = "Add at least 1 Item with Sauda Rate > 0"; } } 
    data.items.forEach((it, idx) => { const n = idx + 1; const item = (it.item||"").trim(); const size = (it.size||"").trim(); const qty = parseFloat(it.qty); const rate = parseFloat(it.rate); if (!item && !size && !it.qty) return; if (!item) issues.push(`Line ${n}: Item is required.`); if (!size) issues.push(`Line ${n}: Sizes is required.`); if (!Number.isFinite(qty) || qty <= 0) issues.push(`Line ${n}: Qty must be > 0.`); if (!data.billType) { issues.push(`Line ${n}: Net Rate missing (Select Bill Type).`); } else if (!Number.isFinite(rate) || rate <= 0) { issues.push(`Line ${n}: Net Rate missing (check Sauda/Size).`); } }); 
    if (issues.length === 0) setStatus("ok", forPrint ? "Ready to print" : "OK"); else if (issues.length <= 3) setStatus("warn", `${issues.length} issue${issues.length>1?"s":""}`); else setStatus("danger", `${issues.length} issues`); return { ok: issues.length === 0, issues }; 
  }

  function exportCSV(){ const data = collectData(); const lines = []; lines.push(["Dealer Name", data.dealerName]); lines.push(["Billing Name", data.billingName]); lines.push(["Billing Address", data.billingAddress]); lines.push(["Dispatch Address", data.dispatchAddress]); lines.push(["Date", data.orderDate]); lines.push(["Bill Type", data.billType]); lines.push(["OB", data.ob]); lines.push(["Freight", data.freight]); lines.push(["Lorry No", data.lorryNo]); lines.push([]); lines.push(["Item & Sauda Rates"]); lines.push(["Item","Sauda Rate"]); data.itemRates.forEach(r => { if(r.item && r.sauda) lines.push([r.item, r.sauda]); }); lines.push([]); lines.push(["Sr","Item","Sizes","Qty (MT)","Net Rate","Breakdown"]); data.items.forEach((it, i) => { if(it.item) lines.push([String(i+1), it.item, it.size, it.qty, it.rate, it.bd]); }); const csv = lines.map(row => row.map(cell => { const s = (cell ?? "").toString(); if (s.includes('"') || s.includes(",") || s.includes("\n")) return `"${s.replace(/"/g,'""')}"`; return s; }).join(",")).join("\n"); const blob = new Blob([csv], { type:"text/csv;charset=utf-8" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `SteelMart_DO_${(data.orderDate || "date")}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
  async function copySummary(){ const text = buildWhatsAppText(); try{ await navigator.clipboard.writeText(text); showToast("Summary copied", null); } catch(_){ const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove(); showToast("Summary copied", null); } }
  function handlePrint(){ const v = validateForm({ forPrint:true }); if (!v.ok){ const preview = v.issues.slice(0, 8).map(s => "‚Ä¢ " + s).join("\n"); const more = v.issues.length > 8 ? `\n‚Ä¶ and ${v.issues.length - 8} more.` : ""; alert("Fix these before printing:\n\n" + preview + more); return; } for (const tr of itemsBody.querySelectorAll("tr")) recalcRow(tr); recalcTotals(); renderPrintTable(); window.print(); }
  function handleReset(){ if (!confirm("Clear all data? (Draft autosave will be cleared)")) return; suppressSave = true; ["dealerName","billingName","billingAddress","dispatchAddress","freight","lorryNo","note","signedBy","approvedBy"].forEach(id => document.getElementById(id).value = ""); const checked = document.querySelector('input[name="globalBillType"]:checked'); if(checked) checked.checked = false; document.getElementById("globalOB").value = ""; orderDate.max = TODAY; orderDate.value = TODAY; itemRatesBody.innerHTML = ""; itemsBody.innerHTML = ""; addItemRateRow(); addLine(); suppressSave = false; clearDraft(); recalcTotals(); validateForm(); setStatus("warn","Draft"); }
  globalSettingsDiv.addEventListener("input", (e) => { for (const row of itemsBody.querySelectorAll("tr")){ recalcRow(row); } validateForm(); saveSoon(); }); itemRatesBody.addEventListener("change", (e) => { if (e.target.classList.contains("ir-item")) { const tr = e.target.closest("tr"); const item = tr?.querySelector(".ir-item")?.value || ""; for (const row of itemsBody.querySelectorAll("tr")){ if ((row.querySelector(".rowItem")?.value || "") === item) recalcRow(row); } syncLineItemSelects(); validateForm(); saveSoon(); }}); itemRatesBody.addEventListener("input", (e) => { if (e.target.classList.contains("ir-sauda")){ const tr = e.target.closest("tr"); const item = tr?.querySelector(".ir-item")?.value || ""; for (const row of itemsBody.querySelectorAll("tr")){ if ((row.querySelector(".rowItem")?.value || "") === item) recalcRow(row); } validateForm(); saveSoon(); }}); itemRatesBody.addEventListener("click", (e) => { const btn = e.target.closest("[data-action]"); if (!btn) return; if (btn.dataset.action === "removeItemRate"){ const tr = btn.closest("tr"); const idx = Array.from(itemRatesBody.children).indexOf(tr); const snapshot = collectItemRates()[idx]; tr.remove(); renumberItemRates(); syncLineItemSelects(); validateForm(); saveSoon(); showToast("Item removed", () => { addItemRateRow(snapshot); renumberItemRates(); syncLineItemSelects(); validateForm(); saveSoon(); }); } }); itemsBody.addEventListener("change", (e) => { const tr = e.target.closest("tr"); if (!tr) return; if (e.target.classList.contains("rowItem")){ rebuildSizeFieldForRow(tr); recalcRow(tr); validateForm(); saveSoon(); } if (e.target.classList.contains("size")){ recalcRow(tr); validateForm(); saveSoon(); }}); itemsBody.addEventListener("input", (e) => { const tr = e.target.closest("tr"); if (!tr) return; if (e.target.classList.contains("qty")){ recalcTotals(); validateForm(); saveSoon(); } if (e.target.classList.contains("size")){ recalcRow(tr); validateForm(); saveSoon(); }}); itemsBody.addEventListener("click", (e) => { const btn = e.target.closest("[data-action]"); const tr = e.target.closest("tr"); if (!btn || !tr) return; if (btn.dataset.action === "remove") { const idx = Array.from(itemsBody.children).indexOf(tr); const snapshot = collectData().items[idx]; tr.remove(); renumberLines(); recalcTotals(); validateForm(); saveSoon(); showToast("Line removed", () => { addLine(snapshot); renumberLines(); validateForm(); saveSoon(); }); } }); form.addEventListener("input", (e) => { if (e.target && (e.target.id === "freight" || e.target.id === "orderDate")){ for (const tr of itemsBody.querySelectorAll("tr")) recalcRow(tr); } validateForm(); saveSoon(); }); document.addEventListener("click", (e) => { const btn = e.target.closest("[data-action]"); if (!btn) return; const action = btn.dataset.action; if (action === "addItemRate"){ addItemRateRow(); renumberItemRates(); syncLineItemSelects(); validateForm(); saveSoon(); } if (action === "addLine"){ addLine(); validateForm(); saveSoon(); } if (action === "dupLast"){ duplicateLast(); validateForm(); saveSoon(); } if (action === "exportCsv"){ exportCSV(); } if (action === "copySummary"){ copySummary(); } if (action === "print"){ handlePrint(); } if (action === "reset"){ handleReset(); } }); window.addEventListener("beforeunload", () => { try{ saveDraft(); }catch(_){} }); function init(){ addItemRateRow(); addLine(); renumberItemRates(); renumberLines(); recalcTotals(); validateForm(); setStatus("warn","Draft"); sumSavedAt.textContent = "‚Äî"; checkResume(); setupRealtimeValidation(); setupParallax(); setupRipple(); setupSwipeToDelete(); } init();
  function scrollToFirstError(){ const err = document.querySelector(".error:not(:empty)"); if (!err) return; const card = err.closest(".card"); if (card) card.scrollIntoView({ behavior:"smooth", block:"start" }); }
  const _handlePrint = handlePrint; handlePrint = function(){ const v = validateForm({ forPrint:true }); if (!v.ok){ scrollToFirstError(); const preview = v.issues.slice(0, 8).map(s => "‚Ä¢ " + s).join("\n"); const more = v.issues.length > 8 ? `\n‚Ä¶ and ${v.issues.length - 8} more.` : ""; alert("Fix these before printing:\n\n" + preview + more); return; } _handlePrint(); };
  const savePill = document.getElementById("savePill"); const _setStatus = setStatus; setStatus = function(kind, label){ _setStatus(kind, label); if (!savePill) return; savePill.style.transform = (label.includes("Saving")) ? "scale(1.02)" : "scale(1)"; };

  // FAB Logic
  document.getElementById('fab').addEventListener('click', () => {
    addLine();
    validateForm();
    saveSoon();
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  });

  // Ripple Effect
  function setupRipple() {
    document.addEventListener('click', (e) => {
      const target = e.target.closest('.btn, .icon, .fab');
      if (!target) return;
      const ripple = document.createElement('span');
      ripple.className = 'ripple';
      const rect = target.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      const x = e.clientX - rect.left - size / 2;
      const y = e.clientY - rect.top - size / 2;
      ripple.style.width = ripple.style.height = `${size}px`;
      ripple.style.left = `${x}px`;
      ripple.style.top = `${y}px`;
      target.appendChild(ripple);
      ripple.addEventListener('animationend', () => ripple.remove());
    });
  }

  // Parallax Depth
  function setupParallax() {
    let ticking = false;
    function update(e) {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const x = (e.clientX - window.innerWidth / 2) * 0.02; // sensitivity
          const y = (e.clientY - window.innerHeight / 2) * 0.02;
          document.documentElement.style.setProperty('--plx-x', `${x}px`);
          document.documentElement.style.setProperty('--plx-y', `${y}px`);
          ticking = false;
        });
        ticking = true;
      }
    }
    if (window.matchMedia("(pointer: fine)").matches) {
      window.addEventListener('mousemove', update);
    }
  }

  // Real-time Validation
  function setupRealtimeValidation() {
    // === MODIFIED: Added lorryNo to this list ===
    const requiredIds = ["dealerName", "billingName", "billingAddress", "orderDate", "lorryNo"];
    const inputs = requiredIds.map(id => document.getElementById(id));
    
    inputs.forEach(input => {
      input.addEventListener('blur', () => {
        input.classList.add('touched');
        validateSingle(input);
      });
      input.addEventListener('input', () => {
        if (input.classList.contains('touched')) {
          validateSingle(input);
        }
      });
    });

    function validateSingle(input) {
      if (input.checkValidity()) {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
      } else {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
      }
    }
  }

  // Swipe to Delete (Mobile)
  function setupSwipeToDelete() {
    let startX = 0;
    let currentX = 0;
    let activeRow = null;
    const threshold = 90; 

    itemsBody.addEventListener('touchstart', (e) => {
      const row = e.target.closest('tr');
      if (!row || e.target.closest('.no-print')) return; 
      activeRow = row;
      startX = e.touches[0].clientX;
      activeRow.classList.add('swiping');
    }, {passive: true});

    itemsBody.addEventListener('touchmove', (e) => {
      if (!activeRow) return;
      currentX = e.touches[0].clientX;
      const diff = currentX - startX;
      if (diff < 0) {
        const translateX = Math.max(diff, -150); 
        activeRow.style.transform = `translateX(${translateX}px)`;
      }
    }, {passive: true});

    itemsBody.addEventListener('touchend', () => {
      if (!activeRow) return;
      const diff = currentX - startX;
      activeRow.classList.remove('swiping');
      if (diff < -threshold) {
        activeRow.style.transform = `translateX(-100%)`;
        const btn = activeRow.querySelector('[data-action="remove"]');
        if (btn) btn.click();
      } else {
        activeRow.style.transform = '';
      }
      activeRow = null;
    });
  }
  </script>
</body>
</html>