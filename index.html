<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steel Mart MS Delivery Order | Smart Dispatch Sheet</title>
  <meta name="theme-color" content="#dc2626" />

  <style>
    :root{
      --bg:#fff5f5;
      --text:#111827;
      --muted:#6b7280;
      --brand:#dc2626;
      --brand2:#b91c1c;
      --brand3:#ef4444;
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;

      --radius:16px;
      --radius2:22px;

      --shadow-sm: 0 8px 20px rgba(15,23,42,.07);
      --shadow:    0 16px 44px rgba(15,23,42,.11);

      --ring: 0 0 0 4px rgba(220,38,38,.22);

      --ease: cubic-bezier(.2,.8,.2,1);
      --ease2:cubic-bezier(.16,1,.3,1);

      --page-max:1320px;

      --fs-body: 14px;
      --fs-label: 12px;
      --fs-h2: 12px;

      --plx-x: 0px;
      --plx-y: 0px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      font-size: var(--fs-body);
      line-height: 1.5;
      overflow-x:hidden;

      background:
        radial-gradient(900px 500px at 10% 0%, rgba(220,38,38,.14), transparent 60%),
        radial-gradient(700px 500px at 100% 10%, rgba(239,68,68,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(220,38,38,.08), transparent 60%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 55%, #ffffff 100%);
    }

    body::before{
      content:"";
      position:fixed; inset:-40% -30%;
      background:
        radial-gradient(closest-side, rgba(220,38,38,.06), transparent 65%),
        radial-gradient(closest-side, rgba(239,68,68,.05), transparent 70%);
      filter: blur(18px);
      transform: translate3d(var(--plx-x), var(--plx-y), 0);
      transition: transform 0.1s linear;
      pointer-events:none;
      z-index:-1;
      opacity:.9;
    }

    .wrap{max-width:var(--page-max);margin:0 auto;padding:18px 14px 50px;}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.80);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(220,38,38,.12);
    }
    .topbar-inner{
      max-width:var(--page-max);margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      gap:12px;
    }

    .brand{display:flex;align-items:center;gap:12px;min-width:240px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand3));
      color:white;font-weight:950;display:grid;place-items:center;
      box-shadow: 0 16px 34px rgba(220,38,38,.24);
      letter-spacing:.03em;
      position:relative; overflow:hidden;
      user-select:none;
    }
    .brand h1{margin:0;font-size:15px;line-height:1.15;font-weight:950;}
    .brand p{margin:2px 0 0;font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;font-weight:800;}

    .actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(220,38,38,.14);
      box-shadow: var(--shadow-sm);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
      transition: transform .16s var(--ease);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 4px rgba(22,163,74,.12);}
    .dot.warn{background:var(--warn);box-shadow:0 0 0 4px rgba(245,158,11,.14);}
    .dot.danger{background:var(--danger);box-shadow:0 0 0 4px rgba(239,68,68,.14);}

    /* Buttons + ripple */
    .btn{
      border:1px solid rgba(220,38,38,.14);
      background:rgba(255,255,255,.92);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      transition: transform .16s var(--ease), box-shadow .16s var(--ease), background .16s var(--ease), border-color .16s var(--ease);
      box-shadow: var(--shadow-sm);
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-height:40px;
      user-select:none;
      position: relative;
      overflow: hidden;
    }
    .btn:hover{transform:translateY(-1px);box-shadow: var(--shadow);}
    .btn:active{transform:translateY(0px) scale(.99);}
    .btn:focus{outline:none;box-shadow:var(--ring), var(--shadow);border-color:rgba(220,38,38,.35);}
    .btn.primary{
      border-color:transparent;
      background: linear-gradient(90deg,var(--brand),var(--brand2));
      color:white;
      box-shadow: 0 18px 44px rgba(220,38,38,.24);
    }
    .btn.secondary{background: rgba(255,255,255,.92);border-color: rgba(220,38,38,.20);}
    .btn.ghost{background:transparent;box-shadow:none;border-color:rgba(220,38,38,.12);color:#374151;}
    .btn.ghost:hover{background:rgba(220,38,38,.05);}
    .btn.small{padding:7px 12px;font-size:12px;min-height:34px;}

    span.ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple 600ms linear;
      background-color: rgba(220, 38, 38, 0.18);
      pointer-events: none;
    }
    .btn.primary span.ripple { background-color: rgba(255,255,255,0.35); }
    @keyframes ripple { to { transform: scale(4); opacity: 0; } }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
      align-items:start;
      margin-top:16px;
    }
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }

    /* Cards */
    .card{
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.88));
      border:1px solid rgba(220,38,38,.14);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
      transform: translateY(8px);
      opacity:0;
      animation: cardIn .45s var(--ease2) forwards;
    }
    @keyframes cardIn{ to{ transform: translateY(0); opacity:1; } }

    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(820px 160px at 18% 0%, rgba(220,38,38,.18), transparent 60%),
        radial-gradient(820px 160px at 82% 0%, rgba(239,68,68,.11), transparent 60%);
      opacity:.65;
      pointer-events:none;
    }

    .card h2{
      margin:0 0 12px;
      font-size:var(--fs-h2);
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#991b1b;
      display:flex;align-items:center;gap:10px;
      font-weight:950;
      position:relative;
      z-index:1;
    }
    .card h2::before{
      content:"";
      width:18px;height:6px;border-radius:99px;
      background: linear-gradient(90deg,var(--brand), #ff9aa7);
      box-shadow: 0 10px 18px rgba(220,38,38,.14);
      flex:0 0 auto;
    }

    /* Form grid */
    .grid{display:grid;grid-template-columns: repeat(12, 1fr);gap:12px;position:relative;z-index:1;}
    .field{grid-column: span 6;}
    .field.span-12{grid-column: span 12;}
    .field.span-4{grid-column: span 4;}
    .field.span-3{grid-column: span 3;}
    .field.span-2{grid-column: span 2;}
    @media (max-width: 900px){
      .field.span-2, .field.span-3{grid-column:span 4;}
    }
    @media (max-width: 720px){
      .field, .field.span-12, .field.span-4, .field.span-3, .field.span-2{grid-column:span 12;}
    }

    label{
      display:flex;align-items:baseline;justify-content:space-between;
      gap:10px;
      font-size:var(--fs-label);
      font-weight:950;
      color:#374151;
      margin:2px 0 6px;
    }
    label .req{color:var(--danger);font-weight:950;margin-left:8px;}

    input, textarea, select{
      width:100%;
      border:1px solid rgba(220,38,38,.16);
      background: rgba(255,255,255,.94);
      border-radius:14px;
      padding:11px 12px;
      font-size:13px;
      transition: border-color .16s var(--ease), box-shadow .16s var(--ease), transform .16s var(--ease), background .16s var(--ease);
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
    }
    textarea{min-height:82px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      outline:none;
      border-color:rgba(220,38,38,.46);
      box-shadow:var(--ring);
      background:#fff;
      transform: translateY(-1px);
    }
    input[readonly]{background:#fff1f2;color:#6b7280;border-color:rgba(220,38,38,.10)}

    /* Real-time Valid/Invalid Effects */
    input.touched.is-valid, textarea.touched.is-valid, select.touched.is-valid {
      border-color: var(--ok);
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2316a34a' width='18px' height='18px'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 32px;
    }
    input.touched.is-invalid, textarea.touched.is-invalid, select.touched.is-invalid {
      border-color: var(--danger);
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
      animation: shake 0.3s var(--ease);
      background-image: none;
    }
    @keyframes shake {
      0%, 100% {transform: translateX(0);}
      25% {transform: translateX(-4px);}
      75% {transform: translateX(4px);}
    }

    .error{margin:6px 0 0;font-size:12px;color:var(--danger);min-height:16px}

    /* Global settings grid */
    .global-settings-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      padding: 18px;
      background: #fff1f2;
      border: 1px dashed rgba(220,38,38,.28);
      border-radius: 18px;
      margin-bottom: 8px;
    }
    .global-settings-grid.error-border{
      border-color: var(--danger);
      background: #ffe4e6;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }
    .global-settings-grid.valid-border{
      border-color: rgba(22,163,74,.55);
      box-shadow: 0 0 0 2px rgba(22,163,74,.16);
      background: #f0fdf4;
    }

    /* Bill type switch */
    .bill-switch-global{
      display:flex;
      background:#fff;
      padding:3px;
      border-radius: 12px;
      border: 1px solid rgba(220,38,38,.16);
      width:100%;
      height:42px;
      overflow:hidden;
    }
    .bill-switch-global label{
      flex:1;
      margin:0;
      text-align:center;
      font-size:13px;
      font-weight:800;
      color:#64748b;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .bill-switch-global input[type="radio"]{display:none;}
    .bill-switch-global span{
      width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      border-radius: 9px;
      transition: all .2s var(--ease);
    }
    .bill-switch-global input[type="radio"]:checked + span{
      background: var(--brand);
      color:white;
      box-shadow: 0 2px 8px rgba(220,38,38,.25);
    }

    /* Summary */
    .summary{
      position:sticky; top:74px;
      border:1px solid rgba(220,38,38,.20);
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,245,245,.92));
    }
    @media (max-width: 980px){ .summary{position:relative;top:auto} }
    .kv{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 0;
      border-bottom:1px dashed rgba(220,38,38,.18);
      gap:12px;
      position:relative;z-index:1;
    }
    .kv:last-child{border-bottom:none}
    .kv span{color:var(--muted);font-size:11px;letter-spacing:.14em;text-transform:uppercase;font-weight:950}
    .kv strong{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:13px;
      color:#991b1b;
      padding:6px 10px;
      border-radius:12px;
      background: rgba(220,38,38,.06);
      border:1px solid rgba(220,38,38,.10);
      min-width:120px;
      text-align:right;
    }

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:18px;
      transform:translateX(-50%) translateY(10px);
      background:rgba(17,24,39,.92);color:white;
      padding:10px 12px;border-radius:999px;
      display:none;gap:10px;align-items:center;z-index:1000;
      box-shadow:0 22px 70px rgba(15,23,42,.35);
      font-size:13px;
      opacity:0;
      transition: opacity .28s var(--ease2), transform .28s var(--ease2);
    }
    .toast.show{display:flex; opacity:1; transform:translateX(-50%) translateY(0)}

    /* === Item Block styles === */
    .item-block{
      border: 1px solid rgba(220,38,38,.2);
      border-radius: 18px;
      background: white;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
      overflow: hidden;
      animation: fadeIn 0.3s ease forwards;
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    .block-header{
      background: linear-gradient(to right, #fff5f5, #fff);
      padding: 12px 16px;
      border-bottom: 1px solid rgba(220,38,38,.1);
      display:flex;
      gap: 14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .block-inputs{
      display:flex;
      gap: 12px;
      flex: 1;
      min-width: 300px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .item-select-wrap{flex: 2; min-width: 220px;}
    .rate-input-wrap{flex: 1; min-width: 150px; max-width: 190px;}
    .balance-input-wrap{flex: 1; min-width: 150px; max-width: 190px;}

    .block-summary{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      padding-top: 28px;
      white-space: nowrap;
      margin-right: auto;
    }

    .block-error{
      width:100%;
      margin-top:6px;
      font-size:12px;
      color: var(--danger);
      min-height:16px;
    }

    .block-body{padding:0;background:#fff;}
    .size-table{width:100%; border-collapse: collapse;}
    .size-table th{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      text-align:left;
      padding: 8px 16px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }
    .size-table td{padding: 8px 16px; vertical-align: top; border-bottom: 1px solid #f9fafb;}
    .size-table tr:last-child td{border-bottom:none}

    .row-actions{
      display:flex; gap:8px;
      padding: 12px 16px;
      background:#fafafa;
      border-top: 1px solid #eee;
      justify-content:flex-start;
    }

    .icon-btn{
      width: 32px; height: 32px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: white;
      color: #ef4444;
      display:grid; place-items:center;
      cursor:pointer;
      transition: all .2s var(--ease);
      position:relative;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .icon-btn:hover{background:#fef2f2;border-color:#fca5a5;transform:translateY(-1px)}
    .icon-btn:active{transform:translateY(0) scale(.98)}

    /* === PRINT CSS === */
    .print-only{display:none;}
    #printTableLayout{display:none;}

    @media print{
      @page { size: A4 portrait; margin: 5mm; }
      body { background:#fff !important; margin:0; padding:0; font-size: 11px; }
      .topbar, .actions, .summary, .toast, .no-print, .add-item-bar { display:none !important; }
      .wrap { max-width:none; margin:0; padding:0; }
      .layout { grid-template-columns:1fr; gap:0; }
      main { display:none !important; }
      .print-only { display:block !important; }
      #printTableLayout { display:block; }
      
      /* Force wrap for breakdown */
      .do-wrap { white-space: normal !important; word-wrap: break-word !important; }
    }

    .do-page{width:100%;--print-scale:1;transform:scale(var(--print-scale));transform-origin:top left;}
    .do-title{text-align:center;font-weight:700;font-size:20px;margin:2mm 0 3mm;}
    .do-table{width:100%;border-collapse:collapse;table-layout:fixed;}
    .do-table td,.do-table th{border:1px solid #000;padding:4px 5px;vertical-align:top;font-size:11px;}
    
    /* Dynamic sauda table */
    .sauda-table { table-layout: fixed; width: 100%; }
    .sauda-table td { overflow: hidden; }

    .do-label{width:22%;font-weight:700;white-space:nowrap;}
    .do-value{width:78%;word-wrap:break-word;overflow-wrap:break-word;}
    .do-subhead{font-weight:700;text-align:center;background:#eee;}
    .do-gray{background:#d9d9d9;font-weight:700;}
    .do-tight td,.do-tight th{padding:3px 5px;}
    .do-right-table{width:100%;border-collapse:collapse;table-layout:fixed;}
    .do-right-table td{border:1px solid #000;padding:4px 5px;font-size:11px;}
    .do-right-label{width:45%;font-weight:700;white-space:nowrap;}
    .do-right-val{width:55%;}
    .do-section-gap{height:3mm;}
    .do-note td{height:14mm;}
    .do-sign td{height:16mm;vertical-align:bottom;}
    .do-num{text-align:right;white-space:nowrap;}
    .do-center{text-align:center;}
 
  </style>
</head>

<body>
  <div class="topbar no-print">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">SM</div>
        <div>
          <h1>MS Delivery Order</h1>
          <p>Smart Steel Dispatch Sheet</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="savePill" title="Autosave status">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">Draft</span>
        </div>
        <button class="btn ghost" type="button" data-action="reset">üßπ Reset</button>
        <button class="btn secondary" type="button" data-action="exportCsv">‚¨áÔ∏è CSV</button>
        <button class="btn secondary" type="button" data-action="copySummary">üìã Copy</button>
        <button class="btn primary" type="button" data-action="print">üñ®Ô∏è Print</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="layout">
      <main>
        <form id="doForm" novalidate>

          <!-- PARTY DETAILS + GLOBAL SETTINGS -->
          <section class="card">
            <h2>Party Details</h2>

            <div class="grid">
              <div class="field">
                <label for="dealerName">Dealer Name <span class="req">*</span></label>
                <input id="dealerName" required />
                <p class="error" id="err-dealerName"></p>
              </div>

              <div class="field">
                <label for="billingName">Billing Name <span class="req">*</span></label>
                <input id="billingName" required />
                <p class="error" id="err-billingName"></p>
              </div>

              <div class="field span-12">
                <label for="billingAddress">Billing Address <span class="req">*</span></label>
                <textarea id="billingAddress" rows="3" required></textarea>
                <p class="error" id="err-billingAddress"></p>
              </div>

              <div class="field span-12">
                <label for="dispatchAddress">Dispatch Address</label>
                <textarea id="dispatchAddress" rows="3"></textarea>
              </div>

              <div class="field span-12">
                <div id="globalSettings" class="global-settings-grid">
                  <div class="field span-3">
                    <label for="orderDate">Date <span class="req">*</span></label>
                    <input id="orderDate" type="date" required style="background:#fff" />
                    <p class="error" id="err-orderDate"></p>
                  </div>

                  <div class="field span-3">
                    <label>Bill Type <span class="req">*</span></label>
                    <div class="bill-switch-global" id="billSwitch">
                      <label><input type="radio" name="globalBillType" value="BILL"><span>BILL</span></label>
                      <label><input type="radio" name="globalBillType" value="NC"><span>NC</span></label>
                    </div>
                    <p class="error" id="err-billType"></p>
                  </div>

                  <div class="field span-2">
                    <label for="globalOB">OB</label>
                    <input id="globalOB" type="number" step="0.01" style="background:#fff">
                  </div>

                  <div class="field span-2">
                    <label for="freight">Freight</label>
                    <input id="freight" type="number" step="0.01" style="background:#fff">
                  </div>

                  <div class="field span-2">
                    <label for="lorryNo">Lorry No <span class="req">*</span></label>
                    <input id="lorryNo" required style="background:#fff">
                    <p class="error" id="err-lorryNo"></p>
                  </div>
                </div>

                <p class="error" id="err-globalSettings" aria-live="polite"></p>
              </div>
            </div>
          </section>

          <!-- DYNAMIC ITEMS CONTAINER -->
          <div id="dynamicItemsRoot" style="margin-top:20px;"></div>

          <div class="add-item-bar no-print" style="margin-top:10px; display:flex; justify-content:center;">
            <button type="button" class="btn primary" data-action="addNewItemBlock" style="width:100%; justify-content:center;">
              ‚ûï Add Another Item
            </button>
          </div>

          <!-- NOTES -->
          <section class="card" style="margin-top:20px">
            <h2>Notes &amp; Signatures</h2>
            <div class="grid">
              <div class="field span-12">
                <label for="note">Note</label>
                <textarea id="note" rows="2" placeholder="Any dispatch notes..."></textarea>
              </div>
              <div class="field">
                <label for="signedBy">Order Signed By</label>
                <input id="signedBy" />
              </div>
              <div class="field">
                <label for="approvedBy">Approved By</label>
                <input id="approvedBy" />
              </div>
            </div>
          </section>
        </form>
      </main>

      <aside class="summary card">
        <h2>Summary</h2>
        <div class="kv"><span>Total Qty</span><strong id="sumTotalQty">‚Äî</strong></div>
        <div class="kv"><span>Status</span><strong id="sumStatus">Draft</strong></div>
        <div class="kv"><span>Last Save</span><strong id="sumSavedAt">‚Äî</strong></div>
      </aside>
    </div>

    <!-- PRINT LAYOUT -->
    <div id="printTableLayout" class="print-only do-page">
  <div class="do-title">Delivery Order</div>
  <div id="printDump"></div>
</div>


  <div class="toast" id="toast"><span id="toastText">Action done</span></div>

  <!-- TEMPLATE: PARENT ITEM BLOCK -->
  <template id="itemBlockTpl">
    <div class="item-block">
      <div class="block-header">
        <div class="block-inputs">
          <div class="item-select-wrap">
            <label style="margin:0 0 4px">Item <span class="req">*</span></label>
            <select class="block-item-select"></select>
          </div>

          <div class="rate-input-wrap">
            <label style="margin:0 0 4px">Sauda Rate <span class="req">*</span></label>
            <input type="number" class="block-sauda-input" placeholder="e.g. 52000">
          </div>

          <!-- ‚úÖ NEW: Balance Qty -->
          <div class="balance-input-wrap">
            <label style="margin:0 0 4px">Balance Qty (MT)</label>
            <input type="number" class="block-balance-input" placeholder="e.g. 5.000" step="0.001" min="0" inputmode="decimal">
          </div>
        </div>

        <div class="block-summary"></div>

        <button type="button" class="icon-btn remove-block-btn" title="Remove Item Block">‚úï</button>

        <!-- ‚úÖ per-block error line -->
        <div class="block-error"></div>
      </div>

      <div class="block-body">
        <table class="size-table">
          <thead>
            <tr>
              <th style="width:35%">Size <span class="req">*</span></th>
              <th style="width:15%">Qty (MT)</th>
              <th style="width:15%">Net Rate</th>
              <th style="width:30%">Breakdown</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody class="size-rows-container"></tbody>
        </table>

        <div class="row-actions no-print">
          <button type="button" class="btn small secondary add-size-btn">‚ûï Add Size</button>
          <button type="button" class="btn small ghost dup-size-btn">üß¨ Duplicate Last</button>
        </div>
      </div>
    </div>
  </template>

  <!-- TEMPLATE: CHILD SIZE ROW -->
  <template id="sizeRowTpl">
    <tr class="size-row">
      <td class="size-cell"></td>
      <td><input type="number" class="qty-input" placeholder="0.000" step="0.001" min="0" inputmode="decimal"></td>
      <td><input type="number" class="net-rate-input" placeholder="0.00" readonly></td>
      <td><input type="text" class="bd-input" placeholder="‚Äî" readonly style="font-size:11px; color:#666;"></td>
      <td><button type="button" class="icon-btn remove-row-btn" style="width:28px;height:28px;font-size:12px">üóë</button></td>
    </tr>
  </template>

  <script>
    /* ===========================
       DATA
    ============================ */
        const ITEM_LIST = ["MS Pipe", "MS Angle", "MS Channel", "Binding Wire", "Nails", "Sqr Bar", "Round Bar", "Flats", "HR Pipe", "MS Structure ISMC", "Heavy Structure ISMB"];

const SIZE_SD_LIST = {
  "MS Pipe": [
    [
      "0.75\" 19x19(1.2) 4kg",
      7000
    ],
    [
      "0.75\" 19x19(1.6) 5kg",
      6500
    ],
    [
      "0.75\" 19x19(2.0) 6kg",
      6000
    ],
    [
      "1\" 25x25(1.2) 6kg",
      5000
    ],
    [
      "1\" 25x25(1.6) 7kg",
      4000
    ],
    [
      "1\" 25x25(2.0) 9kg",
      4000
    ],
    [
      "1\" 25x25(2.5) 11.5kg",
      4000
    ],
    [
      "1.25\" 32x32(1.2) 7kg",
      5000
    ],
    [
      "1.25\" 32x32(1.6) 9kg",
      3500
    ],
    [
      "1.25\" 32x32(2.0) 11kg",
      3500
    ],
    [
      "1.25\" 32x32(2.5) 15.5kg",
      3500
    ],
    [
      "1.25\" 32x32(2.9) 17.5kg",
      3500
    ],
    [
      "1.5\" 38x38(1.2) 8.5kg",
      4500
    ],
    [
      "1.5\" 38x38(1.6) 11kg",
      3000
    ],
    [
      "1.5\" 38x38(2.0) 13kg",
      3000
    ],
    [
      "1.5\" 38x38(2.5) 17kg",
      3000
    ],
    [
      "1.5\" 38x38(2.9) 19kg",
      3000
    ],
    [
      "47x47(1.6) 14kg",
      3000
    ],
    [
      "2\" 50x50(1.2) 11kg",
      4000
    ],
    [
      "2\" 50x50(1.6) 15kg",
      3000
    ],
    [
      "2\" 50x50(2.0) 18kg",
      3000
    ],
    [
      "2\" 50x50(2.5) 23kg",
      3000
    ],
    [
      "2\" 50x50(2.9) 26kg",
      3000
    ],
    [
      "2.5\" 60x60(1.6) 17kg",
      3800
    ],
    [
      "2.5\" 60x60(2.0) 22kg",
      3300
    ],
    [
      "2.5\" 60x60(2.5)28kg",
      3300
    ],
    [
      "3\" 72x72(1.6) 21kg",
      5000
    ],
    [
      "3\" 72x72(2.0) 27kg",
      4000
    ],
    [
      "3\" 72x72(2.5) 33kg",
      4000
    ],
    [
      "3\" 72x72(2.9) 39kg",
      4000
    ],
    [
      "1.5\"x 0.75\" 40x20 (1.2)7kg",
      4900
    ],
    [
      "1.5\"x 0.75\" 40x20 (1.6) 9kg",
      3900
    ],
    [
      "1.5\"x 0.75\" 40x20 (2.0) 11kg",
      3900
    ],
    [
      "1.5\"x 0.75\" 40x20 (2.5) 15kg",
      3900
    ],
    [
      "2\"x1\" 50x25 (1.2) 8.5kg",
      4000
    ],
    [
      "2\"x1\" 50x25 (1.6) 11kg",
      3000
    ],
    [
      "2\"x1\" 50x25 (2.0) 13kg",
      3000
    ],
    [
      "2\"x1\" 50x25 (2.5) 18kg",
      3000
    ],
    [
      "2\"x1\" 50x25 (2.9) 21kg",
      3000
    ],
    [
      "60x40 (1.2) 10kg",
      4000
    ],
    [
      "60x40 (1.6) 14kg",
      3000
    ],
    [
      "60x40 (2.0) 17kg",
      3000
    ],
    [
      "60x40 (2.5) 23kg",
      3000
    ],
    [
      "60x40 (2.9) 27kg",
      3000
    ],
    [
      "75x25 (1.2) 10kg",
      4000
    ],
    [
      "75x25 (1.6) 14kg",
      3000
    ],
    [
      "75x25 (2.0) 17kg",
      3000
    ],
    [
      "75x25 (2.5) 22kg",
      3000
    ],
    [
      "75x25 (1.2) 25kg",
      3000
    ],
    [
      "80x40 (1.6) 17kg",
      3800
    ],
    [
      "80x40 (2.0) 22kg",
      3300
    ],
    [
      "80x40 (2.5) 28kg",
      3300
    ],
    [
      "80x40 (2.9) 31kg",
      3300
    ],
    [
      "96x48 (1.6) 21kg",
      5000
    ],
    [
      "96x48 (2.0) 27kg",
      4000
    ],
    [
      "96x48 (2.5) 33kg",
      4000
    ],
    [
      "96x48 (2.9) 39kg",
      4000
    ],
    [
      "0.75\" 25OD (1.2) 4kg",
      7000
    ],
    [
      "0.75\" 25OD (1.6) 5kg",
      6000
    ],
    [
      "0.75\" 25OD (2.0) 6kg",
      6000
    ],
    [
      "1\" 33.4OD (1.2) 6kg",
      5000
    ],
    [
      "1\" 33.4OD (1.6) 7kg",
      4000
    ],
    [
      "1\" 33.4OD (2.0) 9kg",
      4000
    ],
    [
      "1\" 33.4OD (2.5) 11.5kg",
      4000
    ],
    [
      "1.25\" 41OD (1.2) 7kg",
      4500
    ],
    [
      "1.25\" 41OD (1.6) 9kg",
      4500
    ],
    [
      "1.25\" 41OD (2.0) 11kg",
      4000
    ],
    [
      "1.25\" 41OD (2.5) 15.5kg",
      3500
    ],
    [
      "1.25\" 41OD (2.9) 17.5kg",
      3500
    ],
    [
      "1.5\" 48.3OD (1.2) 8.5kg",
      4000
    ],
    [
      "1.5\" 48.3OD (1.6) 11kg",
      3000
    ],
    [
      "1.5\" 48.3OD (2.0) 13kg",
      3000
    ],
    [
      "1.5\" 48.3OD (2.5) 17kg",
      3000
    ],
    [
      "1.5\" 48.3OD (2.9) 20kg",
      3000
    ],
    [
      "2\" 60.3OD (1.2) 10Kg",
      4000
    ],
    [
      "2\" 60.3OD (1.6) 14Kg",
      3000
    ],
    [
      "2\" 60.3OD (2.0) 17Kg",
      3000
    ],
    [
      "2\" 60.3OD (2.5) 22Kg",
      3000
    ],
    [
      "2\" 60.3OD (2.9) 24Kg",
      3000
    ],
    [
      "2.5\" 76.2OD (1.6) 17kg",
      3800
    ],
    [
      "2.5\" 76.2OD (2.0) 22KG",
      3300
    ],
    [
      "2.5\" 76.2OD (2.5) 28KG",
      3300
    ],
    [
      "3\" 88OD (1.6) 21KG",
      5000
    ],
    [
      "3\" 88OD (2.0) 27KG",
      4000
    ],
    [
      "3\" 88OD (2.5) 33KG",
      4000
    ],
    [
      "3\" 88OD (2.9) 39KG",
      4000
    ]
  ],
  "MS Angle": [
    [
      "25x3 (6.2 kg)",
      7800
    ],
    [
      "25x5 (10.5 kg)",
      7500
    ],
    [
      "32x3 (8 kg )",
      7500
    ],
    [
      "35x3 (10.6)",
      7800
    ],
    [
      "35x4 (12kg)",
      7500
    ],
    [
      "35x5 (14.5kg)",
      7200
    ],
    [
      "40x4 (14kg)",
      7500
    ],
    [
      "40x5 (18kg)",
      7000
    ],
    [
      "50x4 (17.5kg)",
      7500
    ],
    [
      "50x5 (21.5kg)",
      6400
    ],
    [
      "50x6 (26.6kg)",
      6100
    ],
    [
      "65x5(28.5 kg)",
      6400
    ],
    [
      "65x6(34.5)",
      6100
    ],
    [
      "75x5",
      6400
    ]
  ],
  "MS Channel": [
    [
      "C 75*40 (3\"X1.5\") 36KG",
      6400
    ],
    [
      "C 70*35 (3\"X1.5\") 22KG",
      7200
    ],
    [
      "C 100*50 (4\"x 2\") 56KG",
      6100
    ],
    [
      "C 95x45 (4\"x2\") 36kg",
      7200
    ]
  ],
  "Binding Wire": [
    [
      "BW 18G Random",
      0
    ],
    [
      "BW 18G 10Kg",
      2500
    ],
    [
      "BW 18G 25Kg",
      0
    ],
    [
      "BW 20G 10Kg",
      3500
    ],
    [
      "BW 20G 25Kg",
      0
    ]
  ],
  "Nails": [
    [
      "Nails 2\"",
      0
    ],
    [
      "Nails 2.5\"",
      0
    ],
    [
      "Nails 3\"",
      0
    ]
  ],
  "Sqr Bar": [
    [
      "8mm",
      1500
    ],
    [
      "10mm",
      0
    ],
    [
      "12mm",
      0
    ]
  ],
  "Round Bar": [
    [
      "8mm",
      0
    ],
    [
      "10mm",
      0
    ],
    [
      "12mm",
      0
    ],
    [
      "16mm",
      0
    ]
  ],
  "Flats": [
    [
      "F 20x5",
      0
    ],
    [
      "F 25x3",
      0
    ],
    [
      "F 25x5",
      0
    ],
    [
      "F 32x5",
      0
    ],
    [
      "F 40x3",
      0
    ],
    [
      "F 40x5",
      0
    ],
    [
      "F 40x6",
      0
    ],
    [
      "F 50x5",
      0
    ],
    [
      "F 50x6",
      0
    ]
  ],
  "HR Pipe": [
    [
      "1.25\" 41 OD (2.0) 8.8kg",
      500
    ],
    [
      "1.5\" 48.3 OD (2.0) 13.9kg",
      500
    ],
    [
      "2.0\" 60.3OD (2.0) 17.5kg",
      500
    ],
    [
      "4\" 114.3 OD (2.0) 33.8kg",
      500
    ],
    [
      "0.75\"X0.75\" 19X19 (2.0) 6.91kg",
      500
    ],
    [
      "1\" 25X25 (2.0) 8.8kg",
      500
    ],
    [
      "1.25\" 32X32 (2.0) 11.48kg",
      500
    ],
    [
      "1.5\" 38X38 (2.0) 13.8kg",
      500
    ],
    [
      "2\" 50X50 (2.0) 18.4kg",
      500
    ],
    [
      "2.5\" 60X60 (2.0) 22.3kg",
      500
    ],
    [
      "3\" 72X72 (2.0) 26.8kg",
      500
    ],
    [
      "4\" 100X100 (2.0) 37.5kg",
      500
    ],
    [
      "2\"x1\" 50x25 (2.0) 13.59kg",
      500
    ],
    [
      "2.5\"x1.5\" 60x40 (2.0) kg",
      500
    ],
    [
      "3\"x1.5\" 80X40 (2.0) 22.2kg",
      500
    ],
    [
      "4\"x2\" 96X48 (2.0) 25.6kg",
      500
    ],
    [
      "1.25\" 41 OD (2.3) 10.38kg",
      500
    ],
    [
      "1.5\" 48.3 OD (2.3) 15.91kg",
      500
    ],
    [
      "2.0\" 60.3OD (2.3) 20.05kg",
      500
    ],
    [
      "4\" 114.3 OD (2.3) 38.73kg",
      500
    ],
    [
      "0.75\"X0.75\" 19X19 (2.3) 7.93kg",
      500
    ],
    [
      "1\" 25X25 (2.3) 9.99kg",
      500
    ],
    [
      "1.25\" 32X32 (2.3) 13.08kg",
      500
    ],
    [
      "1.5\" 38X38 (2.3) 15.72kg",
      500
    ],
    [
      "2\" 50X50 (2.3) 21kg",
      500
    ],
    [
      "2.5\" 60X60 (2.3) 25.4kg",
      500
    ],
    [
      "3\" 72X72 (2.3) 60.69kg",
      500
    ],
    [
      "4\" 100X100 (2.3) 43kg",
      500
    ],
    [
      "2\"x1\" 50x25 (2.3) 15.5kg",
      500
    ],
    [
      "2.5\"x1.5\" 60x40 (2.3) kg",
      500
    ],
    [
      "3\"x1.5\" 80X40 (2.3) 25.4kg",
      500
    ],
    [
      "4\"x2\" 96X48 (2.3) 30.69kg",
      500
    ],
    [
      "5\" 139.7 OD (2.0) 41.4kg",
      1500
    ],
    [
      "6\" 165.1 OD (2.0) 48.2kg",
      1500
    ],
    [
      "6\" 150X150 (2.0) 56.66kg",
      1500
    ],
    [
      "5\"X2.5 122X62 (2.0) 34.5kg",
      1500
    ],
    [
      "6\"X3\" 150X75 (2.0) 42.3kg",
      1500
    ],
    [
      "6\"X4\" 145X82 (2.0) 42.68kg",
      1500
    ],
    [
      "8\"X4\" 200X100 (2.0) 56.66kg",
      1500
    ],
    [
      "5\" 139.7 OD (2.3) 47.51kg",
      1500
    ],
    [
      "6\" 165.1 OD (2.3) 56.29kg",
      1500
    ],
    [
      "6\" 150X150 (2.3) 65.03kg",
      1500
    ],
    [
      "5\"X2.5 122X62 (2.3) 39.49kg",
      1500
    ],
    [
      "6\"X3\" 150X75 (2.3) 48.52kg",
      1500
    ],
    [
      "6\"X4\" 145X82 (2.3) 48.96kg",
      1500
    ],
    [
      "8\"X4\" 200X100 (2.3) 65.03kg",
      1500
    ],
    [
      "1.25\" 41 OD (2.5) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (2.5) 17.2kg",
      0
    ],
    [
      "2.0\" 60.3OD (2.5) 21.7kg",
      0
    ],
    [
      "4\" 114.3 OD (2.5) 42kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (2.5) 7.9kg",
      0
    ],
    [
      "1\" 25X25 (2.5) 10.8kg",
      0
    ],
    [
      "1.25\" 32X32 (2.5) 14.1kg",
      0
    ],
    [
      "1.5\" 38X38 (2.5) 17kg",
      0
    ],
    [
      "2\" 50X50 (2.5) kg",
      0
    ],
    [
      "2.5\" 60X60 (2.5) kg",
      0
    ],
    [
      "3\" 72X72 (2.5) kg",
      0
    ],
    [
      "4\" 100X100 (2.5) kg",
      0
    ],
    [
      "2\"x1\" 50x25 (2.5) kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (2.5) kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (2.5) kg",
      0
    ],
    [
      "4\"x2\" 96X48 (2.5) kg",
      0
    ],
    [
      "1.25\" 41 OD (2.8) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (2.8) kg",
      0
    ],
    [
      "2.0\" 60.3OD (2.8) kg",
      0
    ],
    [
      "4\" 114.3 OD (2.8) kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (2.8) kg",
      0
    ],
    [
      "1\" 25X25 (2.8) kg",
      0
    ],
    [
      "1.25\" 32X32 (2.8) kg",
      0
    ],
    [
      "1.5\" 38X38 (2.8) kg",
      0
    ],
    [
      "2\" 50X50 (2.8) kg",
      0
    ],
    [
      "2.5\" 60X60 (2.8) kg",
      0
    ],
    [
      "3\" 72X72 (2.8) kg",
      0
    ],
    [
      "4\" 100X100 (2.8) kg",
      0
    ],
    [
      "2\"x1\" 50x25 (2.8) kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (2.8) kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (2.8) kg",
      0
    ],
    [
      "4\"x2\" 96X48 (2.8) kg",
      0
    ],
    [
      "1.25\" 41 OD (3.0) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (3.0) kg",
      0
    ],
    [
      "2.0\" 60.3OD (3.0) 25kg",
      0
    ],
    [
      "4\" 114.3 OD (3.0) 51.23kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (3.0) 9.11kg",
      0
    ],
    [
      "1\" 25X25 (3.0) 12.76kg",
      0
    ],
    [
      "1.25\" 32X32 (3.0) 16.8kg",
      0
    ],
    [
      "1.5\" 38X38 (3.0) 20.45kg",
      0
    ],
    [
      "2\" 50X50 (3.0) 28.08kg",
      0
    ],
    [
      "2.5\" 60X60 (3.0) 34.44kg",
      0
    ],
    [
      "3\" 72X72 (3.0) 42.07kg",
      0
    ],
    [
      "4\" 100X100 (3.0) 59.87kg",
      0
    ],
    [
      "2\"x1\" 50x25 (3.0) 19.95kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (3.0) 34.44kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (3.0) 34.44kg",
      0
    ],
    [
      "4\"x2\" 96X48 (3.0) 42.07kg",
      0
    ],
    [
      "1.25\" 41 OD (3.2) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (3.2) kg",
      0
    ],
    [
      "2.0\" 60.3OD (3.2) 26.4kg",
      0
    ],
    [
      "4\" 114.3 OD (3.2) 54.76kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (3.2) 9.67kg",
      0
    ],
    [
      "1\" 25X25 (3.2) 13.58kg",
      0
    ],
    [
      "1.25\" 32X32 (3.2) 17.88kg",
      0
    ],
    [
      "1.5\" 38X38 (3.2) 21.77kg",
      0
    ],
    [
      "2\" 50X50 (3.2) 29.92kg",
      0
    ],
    [
      "2.5\" 60X60 (3.2) 36.68kg",
      0
    ],
    [
      "3\" 72X72 (3.2) 44.79kg",
      0
    ],
    [
      "4\" 100X100 (3.2) 63.72kg",
      0
    ],
    [
      "2\"x1\" 50x25 (3.2) 21.26kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (3.2) 36.68kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (3.2) 36.68kg",
      0
    ],
    [
      "4\"x2\" 96X48 (3.2) 44.79kg",
      0
    ],
    [
      "1.25\" 41 OD (3.5) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (3.5) kg",
      0
    ],
    [
      "2.0\" 60.3OD (3.5) 29kg",
      0
    ],
    [
      "4\" 114.3 OD (3.5) 61.88kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (3.5) 10.52kg",
      0
    ],
    [
      "1\" 25X25 (3.5) 14.79kg",
      0
    ],
    [
      "1.25\" 32X32 (3.5) 19.46kg",
      0
    ],
    [
      "1.5\" 38X38 (3.5) 23.62kg",
      0
    ],
    [
      "2\" 50X50 (3.5) 32.44kg",
      0
    ],
    [
      "2.5\" 60X60 (3.5) 39.73kg",
      0
    ],
    [
      "3\" 72X72 (3.5) 48.47kg",
      0
    ],
    [
      "4\" 100X100 (3.5) 68.84kg",
      0
    ],
    [
      "2\"x1\" 50x25 (3.5) 23.07kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (3.5) 39.73kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (3.5) 39.73kg",
      0
    ],
    [
      "4\"x2\" 96X48 (3.5) 48.47kg",
      0
    ],
    [
      "1.25\" 41 OD (4.0) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (4.0) 26.3kg",
      0
    ],
    [
      "2.0\" 60.3OD (4.0) 33.1kg",
      0
    ],
    [
      "4\" 114.3 OD (4.0) 67.31kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (4.0) 11.46kg",
      0
    ],
    [
      "1\" 25X25 (4.0) 16.16kg",
      0
    ],
    [
      "1.25\" 32X32 (4.0) 21.26kg",
      0
    ],
    [
      "1.5\" 38X38 (4.0) 25.97kg",
      0
    ],
    [
      "2\" 50X50 (4.0) 35.72kg",
      0
    ],
    [
      "2.5\" 60X60 (4.0) 43.77kg",
      0
    ],
    [
      "3\" 72X72 (4.0) 53.42kg",
      0
    ],
    [
      "4\" 100X100 (4.0) 75.9kg",
      0
    ],
    [
      "2\"x1\" 50x25 (4.0) 25.46kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (4.0) 43.77kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (4.0) 43.77kg",
      0
    ],
    [
      "4\"x2\" 96X48 (4.0) 53.42kg",
      0
    ],
    [
      "1.25\" 41 OD (4.2) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (4.2) 27.6kg",
      0
    ],
    [
      "2.0\" 60.3OD (4.2) 35kg",
      0
    ],
    [
      "4\" 114.3 OD (4.2) 70.55kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (4.2) 11.86kg",
      0
    ],
    [
      "1\" 25X25 (4.2) 16.74kg",
      0
    ],
    [
      "1.25\" 32X32 (4.2) 22.01kg",
      0
    ],
    [
      "1.5\" 38X38 (4.2) 26.86kg",
      0
    ],
    [
      "2\" 50X50 (4.2) 36.95kg",
      0
    ],
    [
      "2.5\" 60X60 (4.2) 45.31kg",
      0
    ],
    [
      "3\" 72X72 (4.2) 55.32kg",
      0
    ],
    [
      "4\" 100X100 (4.2) 78.7kg",
      0
    ],
    [
      "2\"x1\" 50x25 (4.2) 26.52kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (4.2) 45.31kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (4.2) 45.31kg",
      0
    ],
    [
      "4\"x2\" 96X48 (4.2) 55.32kg",
      0
    ],
    [
      "1.25\" 41 OD (4.3) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (4.3) 28.28kg",
      0
    ],
    [
      "2.0\" 60.3OD (4.3) 36.2kg",
      0
    ],
    [
      "4\" 114.3 OD (4.3) 71.11kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (4.3) 12.1kg",
      0
    ],
    [
      "1\" 25X25 (4.3) 17.04kg",
      0
    ],
    [
      "1.25\" 32X32 (4.3) 22.8kg",
      0
    ],
    [
      "1.5\" 38X38 (4.3) 27.74kg",
      0
    ],
    [
      "2\" 50X50 (4.3) 37.61kg",
      0
    ],
    [
      "2.5\" 60X60 (4.3) 45.85kg",
      0
    ],
    [
      "3\" 72X72 (4.3) 55.72kg",
      0
    ],
    [
      "4\" 100X100 (4.3) kg",
      0
    ],
    [
      "2\"x1\" 50x25 (4.3) 27.33kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (4.3) 45.85kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (4.3) 45.85kg",
      0
    ],
    [
      "4\"x2\" 96X48 (4.3) 55.72kg",
      0
    ],
    [
      "1.25\" 41 OD (4.5) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (4.5) kg",
      0
    ],
    [
      "2.0\" 60.3OD (4.5) kg",
      0
    ],
    [
      "4\" 114.3 OD (4.5) kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (4.5) kg",
      0
    ],
    [
      "1\" 25X25 (4.5) kg",
      0
    ],
    [
      "1.25\" 32X32 (4.5) kg",
      0
    ],
    [
      "1.5\" 38X38 (4.5) kg",
      0
    ],
    [
      "2\" 50X50 (4.5) kg",
      0
    ],
    [
      "2.5\" 60X60 (4.5) kg",
      0
    ],
    [
      "3\" 72X72 (4.5) kg",
      0
    ],
    [
      "4\" 100X100 (4.5) kg",
      0
    ],
    [
      "2\"x1\" 50x25 (4.5) kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (4.5) kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (4.5) kg",
      0
    ],
    [
      "4\"x2\" 96X48 (4.5) 58.14kg",
      0
    ],
    [
      "1.25\" 41 OD (4.8) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (4.8) kg",
      0
    ],
    [
      "2.0\" 60.3OD (4.8) kg",
      0
    ],
    [
      "4\" 114.3 OD (4.8) kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (4.8) kg",
      0
    ],
    [
      "1\" 25X25 (4.8) kg",
      0
    ],
    [
      "1.25\" 32X32 (4.8) kg",
      0
    ],
    [
      "1.5\" 38X38 (4.8) kg",
      0
    ],
    [
      "2\" 50X50 (4.8) kg",
      0
    ],
    [
      "2.5\" 60X60 (4.8) kg",
      0
    ],
    [
      "3\" 72X72 (4.8) kg",
      0
    ],
    [
      "4\" 100X100 (4.8) 87.47kg",
      0
    ],
    [
      "2\"x1\" 50x25 (4.8) kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (4.8) kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (4.8) kg",
      0
    ],
    [
      "4\"x2\" 96X48 (4.8) kg",
      0
    ],
    [
      "1.25\" 41 OD (5.5) 25.3kg",
      0
    ],
    [
      "1.5\" 48.3 OD (5.5) 35.99kg",
      0
    ],
    [
      "2.0\" 60.3OD (5.5) 45.31kg",
      0
    ],
    [
      "4\" 114.3 OD (5.5) 89.96kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (5.5) 14.21kg",
      0
    ],
    [
      "1\" 25X25 (5.5) 20.53kg",
      0
    ],
    [
      "1.25\" 32X32 (5.5) 27.9kg",
      0
    ],
    [
      "1.5\" 38X38 (5.5) 34.22kg",
      0
    ],
    [
      "2\" 50X50 (5.5) 46.85kg",
      0
    ],
    [
      "2.5\" 60X60 (5.5) 57.38kg",
      0
    ],
    [
      "3\" 72X72 (5.5) 70.01kg",
      0
    ],
    [
      "4\" 100X100 (5.5) 99.49kg",
      0
    ],
    [
      "2\"x1\" 50x25 (5.5) 33.69kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (5.5) 57.38kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (5.5) 57.38kg",
      0
    ],
    [
      "4\"x2\" 96X48 (5.5) 70.01kg",
      0
    ],
    [
      "1.25\" 41 OD (6.0) kg",
      0
    ],
    [
      "1.5\" 48.3 OD (6.0) 38.16kg",
      0
    ],
    [
      "2.0\" 60.3OD (6.0) 48.98kg",
      0
    ],
    [
      "4\" 114.3 OD (6.0) 97.69kg",
      0
    ],
    [
      "0.75\"X0.75\" 19X19 (6.0) 14.93kg",
      0
    ],
    [
      "1\" 25X25 (6.0) 21.82kg",
      0
    ],
    [
      "1.25\" 32X32 (6.0) 29.86kg",
      0
    ],
    [
      "1.5\" 38X38 (6.0) 36.75kg",
      0
    ],
    [
      "2\" 50X50 (6.0) 50.52kg",
      0
    ],
    [
      "2.5\" 60X60 (6.0) 62.02kg",
      0
    ],
    [
      "3\" 72X72 (6.0) 75.8kg",
      0
    ],
    [
      "4\" 100X100 (6.0) 107.06kg",
      0
    ],
    [
      "2\"x1\" 50x25 (6.0) 36.18kg",
      0
    ],
    [
      "2.5\"x1.5\" 60x40 (6.0) 62.02kg",
      0
    ],
    [
      "3\"x1.5\" 80X40 (6.0) 62.02kg",
      0
    ],
    [
      "4\"x2\" 96X48 (6.0) 75.8kg",
      0
    ],
    [
      "5\" 139.7 OD (2.5) 51.6kg",
      1000
    ],
    [
      "6\" 165.1 OD (2.5) 60.1kg",
      1000
    ],
    [
      "6\" 150X150 (2.5) 70.6kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (2.5) 43.6kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (2.5) 52.6kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (2.5) 53.1kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (2.5) 70.58kg",
      1000
    ],
    [
      "5\" 139.7 OD (2.8) 57.6kg",
      1000
    ],
    [
      "6\" 165.1 OD (2.8) 68.32kg",
      1000
    ],
    [
      "6\" 150X150 (2.8) 78.9kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (2.8) 46.8kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (2.8) 58.8kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (2.8) 59.3kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (2.8) 78.89kg",
      1000
    ],
    [
      "5\" 139.7 OD (3.0) 57.6kg",
      1000
    ],
    [
      "6\" 165.1 OD (3.0) 68.32kg",
      1000
    ],
    [
      "6\" 150X150 (3.0) 78.9kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (3.0) 46.8kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (3.0) 58.8kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (3.0) 59.3kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (3.0) 78.89kg",
      1000
    ],
    [
      "5\" 139.7 OD (3.2) 65.7kg",
      1000
    ],
    [
      "6\" 165.1 OD (3.2) 75.7kg",
      1000
    ],
    [
      "6\" 150X150 (3.2) 89.9kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (3.2) 55.3kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (3.2) 67kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (3.2) 67.6kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (3.2) 89.92kg",
      1000
    ],
    [
      "5\" 139.7 OD (3.5) 71.7kg",
      1000
    ],
    [
      "6\" 165.1 OD (3.5) 83.6kg",
      1000
    ],
    [
      "6\" 150X150 (3.5) 98.2kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (3.5) 60.9kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (3.5) 73kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (3.5) 73.7kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (3.5) 98.15kg",
      1000
    ],
    [
      "5\" 139.7 OD (4.0) 81.6kg",
      1000
    ],
    [
      "6\" 165.1 OD (4.0) 95.3kg",
      1000
    ],
    [
      "6\" 150X150 (4.0) 111.8kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (4.0) 68.5kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (4.0) 83.1kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (4.0) 83.8kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (4.0) 111.79kg",
      1000
    ],
    [
      "5\" 139.7 OD (4.2) 85.6kg",
      1000
    ],
    [
      "6\" 165.1 OD (4.2) 101.6kg",
      1000
    ],
    [
      "6\" 150X150 (4.2) 117.2kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (4.2) 71.8kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (4.2) 87.1kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (4.2) kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (4.2) 117.21kg",
      1000
    ],
    [
      "5\" 139.7 OD (4.3) 87.93kg",
      1000
    ],
    [
      "6\" 165.1 OD (4.3) 103.93kg",
      1000
    ],
    [
      "6\" 150X150 (4.3) 119.92kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (4.3) 72.18kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (4.3) 89.06kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (4.3) 89.88kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (4.3) 120kg",
      1000
    ],
    [
      "5\" 139.7 OD (4.5) kg",
      1000
    ],
    [
      "6\" 165.1 OD (4.5) kg",
      1000
    ],
    [
      "6\" 150X150 (4.5) 125.41kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (4.5) kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (4.5) kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (4.5) 91.89kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (4.5) 128kg",
      1000
    ],
    [
      "5\" 139.7 OD (4.8) kg",
      1000
    ],
    [
      "6\" 165.1 OD (4.8) kg",
      1000
    ],
    [
      "6\" 150X150 (4.8) 133.4kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (4.8) kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (4.8) kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (4.8) kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (4.8) kg",
      1000
    ],
    [
      "5\" 139.7 OD (5.5) 110.96kg",
      1000
    ],
    [
      "6\" 165.1 OD (5.5) 131.97kg",
      1000
    ],
    [
      "6\" 150X150 (5.5) 152.13kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (5.5) 91.07kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (5.5) 112.83kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (5.5) 113.17kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (5.5) 152.13kg",
      1000
    ],
    [
      "5\" 139.7 OD (6.0) 120.6kg",
      1000
    ],
    [
      "6\" 165.1 OD (6.0) 143.51kg",
      1000
    ],
    [
      "6\" 150X150 (6.0) 165.58kg",
      1000
    ],
    [
      "5\"X2.5 122X62 (6.0) 98.77kg",
      1000
    ],
    [
      "6\"X3\" 150X75 (6.0) 122.81kg",
      1000
    ],
    [
      "6\"X4\" 145X82 (6.0) 123.46kg",
      1000
    ],
    [
      "8\"X4\" 200X100 (6.0) 165.58kg",
      1000
    ]
  ],
  "MS Structure ISMC": [
    [
      "MS Channel 125x65 -13.1kg/mtr",
      0
    ],
    [
      "MS Channel 150x75 -26.8kg/mtr",
      0
    ],
    [
      "MS Channel 200x75 -22.3kg/mtr",
      1100
    ],
    [
      "MS Channel 250x82 -34kg/mtr",
      2000
    ],
    [
      "MS Channel 300x90 -36kg/mtr",
      3500
    ]
  ],
  "Heavy Structure ISMB": [
    [
      "Beam 125x70 13.3kg/mtr",
      0
    ],
    [
      "Beam 150x75 -15kg/mtr",
      0
    ],
    [
      "Beam 175x85 -19.5kg/mtr",
      0
    ],
    [
      "Beam 200x100 -24.2kg/mtr",
      500
    ],
    [
      "Beam 250x125 -37.3kg/mtr",
      1300
    ]
  ]
};


    // Efficient maps
    const SIZE_SD_MAP = Object.create(null);
    const SIZE_KEYS = Object.create(null);
    for (const [item, list] of Object.entries(SIZE_SD_LIST)){
      const m = Object.create(null);
      const keys = [];
      for (const [size, sdRaw] of list){
        const sd = Number.isFinite(+sdRaw) ? +sdRaw : 0;
        const k = String(size || "").trim();
        if (!k) continue;
        m[k] = sd;
        keys.push(k);
      }
      SIZE_SD_MAP[item] = m;
      SIZE_KEYS[item] = keys;
    }

    /* ===========================
       DOM
    ============================ */
    const form = document.getElementById("doForm");
    const root = document.getElementById("dynamicItemsRoot");
    const itemBlockTpl = document.getElementById("itemBlockTpl");
    const sizeRowTpl = document.getElementById("sizeRowTpl");

    const orderDate = document.getElementById("orderDate");
    function todayLocalISO(){
  const d = new Date();
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); // convert to local date
  return d.toISOString().slice(0,10);
}

const TODAY = todayLocalISO();
orderDate.max = TODAY;
orderDate.value = TODAY;


    const statusText = document.getElementById("statusText");
    const statusDot = document.getElementById("statusDot");
    const savePill = document.getElementById("savePill");

    const sumTotalQty = document.getElementById("sumTotalQty");
    const sumStatus = document.getElementById("sumStatus");
    const sumSavedAt = document.getElementById("sumSavedAt");

    const toast = document.getElementById("toast");
    const toastText = document.getElementById("toastText");

    const globalSettingsDiv = document.getElementById("globalSettings");

    let billTouched = false;
    let suppressSave = false;
    const STORAGE_KEY = "steelMart.do.v3.nested.balanceQty";

    /* ===========================
       UTILS
    ============================ */
    function fmtTime(ts){
      try{ return new Date(ts).toLocaleString(undefined, {hour:"2-digit", minute:"2-digit"}); }
      catch(_){ return "‚Äî"; }
    }

    function setStatus(kind, label){
      statusText.textContent = label;
      sumStatus.textContent = label;

      statusDot.classList.remove("warn","danger");
      if (kind === "warn") statusDot.classList.add("warn");
      if (kind === "danger") statusDot.classList.add("danger");

      if(savePill) savePill.style.transform = label.toLowerCase().includes("saving") ? "scale(1.03)" : "scale(1)";
    }

    function showToast(msg){
      toastText.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 2200);
    }

    function getGlobalBillType(){
      const checked = document.querySelector('input[name="globalBillType"]:checked');
      return checked ? checked.value : "";
    }

    function getFreight(){
      const v = parseFloat(document.getElementById("freight").value);
      return Number.isFinite(v) ? v : 0;
    }

    function clampTo3(n){
      if(!Number.isFinite(n)) return "";
      return (Math.round(n * 1000) / 1000).toFixed(3);
    }
    
    function toDDMMYYYY(iso){
  const m = String(iso || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return String(iso || "");
  return `${m[3]}/${m[2]}/${m[1]}`;
}

function replaceNewlines(s){
  return String(s ?? "").replace(/\r?\n/g, " | ").trim();
}

function csvEscape(v){
  // Return raw cell content (without surrounding quotes decision)
  return String(v ?? "");
}

function csvCell(v){
  // Empty cell
  if (v === null || v === undefined || v === "") return "";
  // Always quote non-empty cells, and escape quotes
  const s = csvEscape(v).replace(/"/g, '""');
  return `"${s}"`;
}

function fmtQty3(q){
  const n = parseFloat(q);
  return Number.isFinite(n) ? n.toFixed(3) : "";
}

function fmtInt(n){
  const x = parseFloat(n);
  return Number.isFinite(x) ? String(Math.round(x)) : "";
}

function buildDeliveryOrderCSV(data){
  const lines = [];

  // A) Title
  lines.push(csvCell("Delivery Order"));
  lines.push(""); // blank row

  // B) Header key/value rows (Field, Value)
  const headerPairs = [
    ["Dealer Name", data.dealerName || ""],
    ["Billing Name", data.billingName || ""],
    ["Billing Address", replaceNewlines(data.billingAddress || "")],
    ["Dispatch Address", replaceNewlines(data.dispatchAddress || "")],
    ["Bill Type", data.billType || ""],
    ["Date", toDDMMYYYY(data.orderDate || "")],
    ["Freight", data.freight ?? ""],
    ["Lorry No", data.lorryNo || ""],
    ["OB", data.ob ?? ""],
  ];

  headerPairs.forEach(([k, v]) => {
    lines.push([csvCell(k), csvCell(v)].join(","));
  });

  lines.push(""); // C) Blank row

  // D) Item & Sauda Rates section
  lines.push(csvCell("Item & Sauda Rates"));
  lines.push([csvCell("Item"), csvCell("Rate")].join(","));

  const saudaPairs = (data.items || [])
    .map(b => ({
      item: String(b.item || "").trim(),
      rate: parseFloat(b.saudaRate)
    }))
    .filter(x => x.item && Number.isFinite(x.rate) && x.rate > 0);

  if (saudaPairs.length === 0){
    // keep table shape
    lines.push([csvCell(""), csvCell("")].join(","));
  } else {
    saudaPairs.forEach(x => {
      lines.push([csvCell(x.item), csvCell(String(Math.round(x.rate)))].join(","));
    });
  }

  lines.push(""); // E) Blank row

  // F) Main items table
  lines.push(csvCell("Items"));
  lines.push([
    csvCell("Sr"),
    csvCell("Item"),
    csvCell("Sizes"),
    csvCell("Qty (MT)"),
    csvCell("Net Rate"),
    csvCell("Breakdown"),
  ].join(","));

  let sr = 1;
  let totalQty = 0;

  (data.items || []).forEach(block => {
    const itemName = String(block.item || "").trim();
    (block.sizes || []).forEach(s => {
      const size = String(s.size || "").trim();
      const qty = parseFloat(s.qty);

      // Rule: skip invalid
      if (!itemName || !size || !Number.isFinite(qty) || qty <= 0) return;

      totalQty += qty;

      lines.push([
        csvCell(String(sr++)),
        csvCell(itemName),
        csvCell(size),
        csvCell(qty.toFixed(3)),
        csvCell(fmtInt(s.rate)),
        csvCell(replaceNewlines(String(s.bd || "").trim())),
      ].join(","));
    });
  });

  if (sr === 1){
    // No rows -> add an empty placeholder row to keep structure
    lines.push([csvCell("1"), csvCell(""), csvCell(""), csvCell(""), csvCell(""), csvCell("")].join(","));
  }

  // G) Total row aligned to columns:
  // "","Total","","<TOTAL_QTY>","MT",""
  lines.push([
    "",                 // Sr
    csvCell("Total"),   // Item
    "",                 // Sizes
    csvCell(totalQty > 0 ? totalQty.toFixed(3) : "‚Äî"), // Qty (MT)
    csvCell("MT"),      // Net Rate column
    ""                  // Breakdown
  ].join(","));

  lines.push(""); // H) Blank row

  // I) Note (only if present)
  const note = String(data.note || "").trim();
  if (note){
    lines.push([csvCell("Note"), csvCell(replaceNewlines(note))].join(","));
    lines.push(""); // optional spacing
  }

  // J) Signatures (2 cols)
  lines.push([csvCell("Order Signed"), csvCell(data.signedBy || "")].join(","));
  lines.push([csvCell("Approved By"), csvCell(data.approvedBy || "")].join(","));

  return lines.join("\n");
}


    /* ===========================
       SIZE INPUT (datalist)
    ============================ */
    function createSizeInput(itemType, value) {
      const wrapper = document.createElement("div");
      wrapper.style.position = "relative";

      const input = document.createElement("input");
      input.className = "size-input";
      input.type = "text";
      input.value = value || "";
      input.placeholder = "Enter Size";

      const sizes = SIZE_KEYS[itemType];
      if (sizes && sizes.length) {
        const listId = "dl_" + Math.random().toString(36).slice(2);
        input.setAttribute("list", listId);
        const dl = document.createElement("datalist");
        dl.id = listId;
        sizes.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          dl.appendChild(opt);
        });
        wrapper.appendChild(dl);
        input.placeholder = "Select/Type Size";
      }

      wrapper.appendChild(input);
      return { wrapper, input };
    }

    /* ===========================
       CALC
    ============================ */
    function calcRowData(tr) {
      const block = tr.closest('.item-block');
      const item = block.querySelector('.block-item-select').value;
      const sauda = parseFloat(block.querySelector('.block-sauda-input').value);
      const size = tr.querySelector('.size-input').value.trim();

      if (!item) return { rate: "", bd: "" };
      if (!Number.isFinite(sauda) || sauda <= 0) return { rate: "", bd: "Set Sauda Rate" };

      const billType = getGlobalBillType();
      if (!billType) return { rate: "", bd: "Select Bill Type" };

      const freight = getFreight();
      const sdMap = SIZE_SD_MAP[item];
      const sd = (sdMap && Number.isFinite(+sdMap[size])) ? +sdMap[size] : 0;

      const isNC = (billType === "NC");
      // Calc logic (UPDATED CONSTANT TO 255)
      const base = sauda + sd + 255 - (isNC ? 3000 : 0) + freight;
      const finalRate = Math.round(base * 1.18);
      
      // Breakdown Text (UPDATED CONSTANT TO 255)
      const bd = `${sauda} + ${sd}${isNC ? " - 3000" : ""} + 255 + ${freight} + 18%`;

      return { rate: finalRate, bd };
    }

    function recalcRow(tr) {
      const { rate, bd } = calcRowData(tr);
      tr.querySelector('.net-rate-input').value = rate;
      tr.querySelector('.bd-input').value = bd;
    }

    /* ===========================
       ‚úÖ Balance Qty Enforcement
    ============================ */
    function blockUsedQty(block){
      let total = 0;
      block.querySelectorAll('.qty-input').forEach(inp => {
        const v = parseFloat(inp.value);
        if(Number.isFinite(v)) total += v;
      });
      return total;
    }

    function setBlockError(block, msg){
      const el = block.querySelector('.block-error');
      if(el) el.textContent = msg || "";
    }

    function enforceBalance(block, changedQtyInput){
      const balRaw = parseFloat(block.querySelector('.block-balance-input').value);
      if(!Number.isFinite(balRaw) || balRaw <= 0){
        setBlockError(block, "");
        return true;
      }

      const currentVal = parseFloat(changedQtyInput.value);
      const cur = Number.isFinite(currentVal) ? currentVal : 0;

      // compute used WITHOUT current input
      let usedWithout = 0;
      block.querySelectorAll('.qty-input').forEach(inp => {
        if(inp === changedQtyInput) return;
        const v = parseFloat(inp.value);
        if(Number.isFinite(v)) usedWithout += v;
      });

      const maxForThis = Math.max(0, balRaw - usedWithout);
      const total = usedWithout + cur;

      if(total <= balRaw + 1e-9){
        setBlockError(block, "");
        changedQtyInput.classList.remove("is-invalid");
        return true;
      }

      // clamp current value
      const newVal = maxForThis;
      changedQtyInput.value = clampTo3(newVal);

      // mark invalid + message
      changedQtyInput.classList.add("touched","is-invalid");
      setBlockError(block, `Qty exceeded Balance. Adjusted to ${clampTo3(newVal)} MT (Max allowed).`);
      showToast("Balance Qty limit reached");

      return false;
    }

   function updateBlockSummary(block) {
      // Keep logic calculated (used/balance is still enforced elsewhere),
      // but do NOT show any summary text in the header UI.
      block.querySelector('.block-summary').textContent = "";
    }

    function recalcAll() {
      let grandTotal = 0;
      document.querySelectorAll('.item-block').forEach(block => {
        block.querySelectorAll('.size-row').forEach(tr => {
          recalcRow(tr);
        });
        const used = blockUsedQty(block);
        grandTotal += used;
        updateBlockSummary(block);
      });
      const txt = grandTotal > 0 ? grandTotal.toFixed(3) : "‚Äî";
      sumTotalQty.textContent = txt;
    }

    /* ===========================
       BLOCKS
    ============================ */
    function addSizeRow(block, data = {}) {
      const tbody = block.querySelector('.size-rows-container');
      const clone = sizeRowTpl.content.cloneNode(true);
      const tr = clone.querySelector('tr');

      const itemType = block.querySelector('.block-item-select').value;

      // size input
      const cell = tr.querySelector('.size-cell');
      const { wrapper } = createSizeInput(itemType, data.size || "");
      cell.appendChild(wrapper);

      // qty
      const qtyInp = tr.querySelector('.qty-input');
      qtyInp.value = data.qty || "";

      tbody.appendChild(tr);
      recalcRow(tr);
      return tr;
    }

    function addNewItemBlock(data = {}) {
      const clone = itemBlockTpl.content.cloneNode(true);
      const block = clone.querySelector('.item-block');

      const select = block.querySelector('.block-item-select');
      const saudaInput = block.querySelector('.block-sauda-input');
      const balanceInput = block.querySelector('.block-balance-input');

      // Populate dropdown
      select.innerHTML = `<option value="">Select Item</option>` + ITEM_LIST.map(i => `<option value="${i}">${i}</option>`).join('');
      select.value = data.item || "";
      saudaInput.value = data.saudaRate || "";
      balanceInput.value = data.balanceQty || "";

      // Add sizes
      const tbody = block.querySelector('.size-rows-container');
      tbody.innerHTML = "";
      if (data.sizes && data.sizes.length > 0) data.sizes.forEach(s => addSizeRow(block, s));
      else addSizeRow(block);

      attachBlockEvents(block);

      root.appendChild(block);
      updateBlockSummary(block);
      recalcAll();
      return block;
    }

    function attachBlockEvents(block) {
      const select = block.querySelector('.block-item-select');
      let prevVal = select.value;

      // Parent item change
      select.addEventListener('focus', () => { prevVal = select.value; });
      select.addEventListener('change', () => {
        const hasData = Array.from(block.querySelectorAll('.size-input, .qty-input')).some(i => i.value);
        if (hasData) {
          if (!confirm("Changing item will reset sizes. Continue?")) {
            select.value = prevVal;
            return;
          }
          block.querySelector('.size-rows-container').innerHTML = "";
          addSizeRow(block);
        }

        // refresh datalists
        block.querySelectorAll('.size-row').forEach(tr => {
          const cell = tr.querySelector('.size-cell');
          const currentSize = tr.querySelector('.size-input')?.value || "";
          cell.innerHTML = "";
          const { wrapper } = createSizeInput(select.value, currentSize);
          cell.appendChild(wrapper);
        });

        prevVal = select.value;
        setBlockError(block, "");
        recalcAll();
        saveSoon();
      });

      // Click actions inside block
      block.addEventListener('click', (e) => {
        if (e.target.closest('.remove-block-btn')) {
          if(confirm("Remove this entire item block?")) {
            block.remove();
            recalcAll();
            saveSoon();
          }
        }
        if (e.target.closest('.add-size-btn')) {
          addSizeRow(block);
          recalcAll();
          saveSoon();
        }
        if (e.target.closest('.dup-size-btn')) {
          const rows = block.querySelectorAll('.size-row');
          if (rows.length > 0) {
            const last = rows[rows.length-1];
            addSizeRow(block, {
              size: last.querySelector('.size-input').value,
              qty: last.querySelector('.qty-input').value
            });
            recalcAll();
            saveSoon();
          }
        }
        if (e.target.closest('.remove-row-btn')) {
          const tr = e.target.closest('tr');
          tr.remove();
          if(block.querySelectorAll('.size-row').length === 0) addSizeRow(block);
          setBlockError(block, "");
          recalcAll();
          saveSoon();
        }
      });

      // Input events inside block
      block.addEventListener('input', (e) => {
        // Sauda change => recalc all rows
        if (e.target.matches('.block-sauda-input')) {
          recalcAll();
          saveSoon();
        }

        // Balance change => re-check totals
        if (e.target.matches('.block-balance-input')) {
          // If used already > new balance, clamp the last non-empty qty to fit:
          const bal = parseFloat(e.target.value);
          if(Number.isFinite(bal) && bal > 0){
            // Try to clamp last filled qty field if needed
            const used = blockUsedQty(block);
            if(used > bal){
              const qtyInputs = Array.from(block.querySelectorAll('.qty-input'));
              // pick last input with value
              const last = qtyInputs.reverse().find(inp => (parseFloat(inp.value) || 0) > 0) || block.querySelector('.qty-input');
              if(last) enforceBalance(block, last);
            } else {
              setBlockError(block, "");
            }
          } else {
            setBlockError(block, "");
          }
          recalcAll();
          saveSoon();
        }

        // Child qty/size change
        if (e.target.matches('.qty-input') || e.target.matches('.size-input')) {
          const tr = e.target.closest('tr');
          if(tr) recalcRow(tr);

          // ‚úÖ enforce balance only on qty change
          if(e.target.matches('.qty-input')){
            enforceBalance(block, e.target);
          } else {
            setBlockError(block, "");
          }

          updateBlockSummary(block);
          recalcAll();
          saveSoon();
        }
      });
    }

    /* ===========================
       SAVE / LOAD
    ============================ */
    function collectData() {
      const blocks = [];
      document.querySelectorAll('.item-block').forEach(b => {
        const sizes = [];
        b.querySelectorAll('.size-row').forEach(tr => {
          sizes.push({
            size: tr.querySelector('.size-input').value,
            qty: tr.querySelector('.qty-input').value,
            rate: tr.querySelector('.net-rate-input').value,
            bd: tr.querySelector('.bd-input').value
          });
        });
        blocks.push({
          item: b.querySelector('.block-item-select').value,
          saudaRate: b.querySelector('.block-sauda-input').value,
          balanceQty: b.querySelector('.block-balance-input').value,
          sizes
        });
      });

      return {
        dealerName: document.getElementById("dealerName").value,
        billingName: document.getElementById("billingName").value,
        billingAddress: document.getElementById("billingAddress").value,
        dispatchAddress: document.getElementById("dispatchAddress").value,
        orderDate: document.getElementById("orderDate").value,
        billType: getGlobalBillType(),
        ob: document.getElementById("globalOB").value,
        freight: document.getElementById("freight").value,
        lorryNo: document.getElementById("lorryNo").value,
        note: document.getElementById("note").value,
        signedBy: document.getElementById("signedBy").value,
        approvedBy: document.getElementById("approvedBy").value,
        items: blocks
      };
    }

    function applyData(data) {
      document.getElementById("dealerName").value = data.dealerName || "";
      document.getElementById("billingName").value = data.billingName || "";
      document.getElementById("billingAddress").value = data.billingAddress || "";
      document.getElementById("dispatchAddress").value = data.dispatchAddress || "";
      document.getElementById("orderDate").value = data.orderDate || TODAY;

      // Bill type
      const checked = document.querySelector('input[name="globalBillType"]:checked');
      if(checked) checked.checked = false;
      if (data.billType) {
        const r = document.querySelector(`input[name="globalBillType"][value="${data.billType}"]`);
        if(r) r.checked = true;
      }

      document.getElementById("globalOB").value = data.ob || "";
      document.getElementById("freight").value = data.freight || "";
      document.getElementById("lorryNo").value = data.lorryNo || "";
      document.getElementById("note").value = data.note || "";
      document.getElementById("signedBy").value = data.signedBy || "";
      document.getElementById("approvedBy").value = data.approvedBy || "";

      root.innerHTML = "";
      if (data.items && data.items.length) data.items.forEach(blockData => addNewItemBlock(blockData));
      else addNewItemBlock();

      recalcAll();
      validateGlobalSettingsUI();
    }

    function saveDraft() {
      if(suppressSave) return;
      const payload = { savedAt: Date.now(), data: collectData() };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      setStatus("ok", "Saved");
      sumSavedAt.textContent = fmtTime(payload.savedAt);
    }

    let saveTimer;
    function saveSoon() {
      setStatus("warn", "Saving...");
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveDraft, 650);
    }

    /* ===========================
       VALIDATION UI + RESET FIX
    ============================ */
    function validateSingle(input){
      if (input.checkValidity()) {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
      } else {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
      }
    }

    function setupRealtimeValidation(){
      const requiredIds = ["dealerName","billingName","billingAddress","orderDate","lorryNo"];
      const inputs = requiredIds.map(id => document.getElementById(id)).filter(Boolean);

      inputs.forEach(input => {
        input.addEventListener('blur', () => {
          input.classList.add('touched');
          validateSingle(input);
        });
        input.addEventListener('input', () => {
          if (input.classList.contains('touched')) validateSingle(input);
        });
      });
    }

    function validateGlobalSettingsUI(){
      const bill = getGlobalBillType();
      globalSettingsDiv.classList.remove("error-border","valid-border");
      document.getElementById("err-billType").textContent = "";

      // mark global settings green when bill type selected
      if(bill){
        globalSettingsDiv.classList.add("valid-border");
      }
    }

    function clearValidationEffects(scope=document){
      scope.querySelectorAll('input, textarea, select').forEach(el => {
        el.classList.remove('touched','is-valid','is-invalid');
        // remove any inline transforms left by animations
        el.style.transform = "";
      });
      // remove per-block errors
      scope.querySelectorAll('.block-error').forEach(el => el.textContent = "");
      // ensure global settings border state is clean
      globalSettingsDiv.classList.remove("error-border","valid-border");
      document.getElementById("err-billType").textContent = "";
      document.getElementById("err-globalSettings").textContent = "";
    }

    /* ===========================
       ACTIONS
    ============================ */
    document.addEventListener("click", (e) => {
      // Ripple
      const target = e.target.closest('.btn, .icon-btn');
      if(target){
        const ripple = document.createElement('span');
        ripple.className = 'ripple';
        const rect = target.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        target.appendChild(ripple);
        ripple.addEventListener('animationend', () => ripple.remove());
      }

      const btn = e.target.closest("[data-action]");
      if(!btn) return;

      const action = btn.dataset.action;

      if(action === "addNewItemBlock"){
        addNewItemBlock();
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        saveSoon();
      }

      if(action === "reset"){
        if(!confirm("Clear all data?")) return;

        suppressSave = true;
        localStorage.removeItem(STORAGE_KEY);

        // reset form
        form.reset();
        orderDate.max = TODAY;
        orderDate.value = TODAY;

        // clear bill type radios explicitly
        const checked = document.querySelector('input[name="globalBillType"]:checked');
        if(checked) checked.checked = false;

        // rebuild blocks
        root.innerHTML = "";
        addNewItemBlock();

        // ‚úÖ IMPORTANT: clear effects after reset
        clearValidationEffects(document);

        suppressSave = false;
        sumSavedAt.textContent = "‚Äî";
        setStatus("warn", "Draft");
        showToast("Reset done");
        recalcAll();
      }

      if(action === "copySummary"){
        const data = collectData();
        let txt = `*Steel Mart DO*\nDate: ${data.orderDate}\nDealer: ${data.dealerName}\nBill: ${data.billType}\n\n`;
        let idx = 1;
        let tQty = 0;
        data.items.forEach(block => {
          (block.sizes || []).forEach(s => {
            const q = parseFloat(s.qty)||0;
            if(block.item && q > 0) {
              txt += `${idx++}. ${block.item} ${s.size} - ${q.toFixed(3)} MT\n`;
              tQty += q;
            }
          });
        });
        txt += `\n*Total: ${tQty.toFixed(3)} MT*`;

        navigator.clipboard.writeText(txt).then(() => showToast("Summary copied"));
      }

      if(action === "exportCsv"){
      const data = collectData();
      const csv = buildDeliveryOrderCSV(data);

      const safeDate = (data.orderDate || "DO").replaceAll("-", "");
      const safeLorry = (data.lorryNo || "Lorry").replace(/[^\w-]+/g, "_");
      const filename = `DeliveryOrder_${safeDate}_${safeLorry}.csv`;

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();

  URL.revokeObjectURL(url);
  showToast("CSV exported");
}


      if(action === "print"){
        // basic validation
        const data = collectData();
        if(!data.dealerName || !data.billingName || !data.billingAddress || !data.billType || !data.lorryNo){
          alert("Please fill Dealer Name, Billing Name, Billing Address, Bill Type and Lorry No.");
          return;
        }
        // Also enforce balance for all blocks before print
        document.querySelectorAll('.item-block').forEach(block => {
          // if exceeded, clamp last qty input
          const bal = parseFloat(block.querySelector('.block-balance-input').value);
          if(Number.isFinite(bal) && bal > 0){
            const used = blockUsedQty(block);
            if(used > bal){
              const qtyInputs = Array.from(block.querySelectorAll('.qty-input'));
              const last = qtyInputs.reverse().find(inp => (parseFloat(inp.value) || 0) > 0) || block.querySelector('.qty-input');
              if(last) enforceBalance(block, last);
            }
          }
        });
        recalcAll();
	preparePrintAndScale();
        window.print();
      }
    });

    // Inputs that affect all rows
    form.addEventListener("input", (e) => {
      if(e.target && (e.target.id === "freight" || e.target.name === "globalBillType" || e.target.id === "orderDate")){
        recalcAll();
        validateGlobalSettingsUI();
        saveSoon();
      }
    });

    /* ===========================
       Parallax
    ============================ */
    (function setupParallax(){
      let ticking = false;
      function update(e) {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            const x = (e.clientX - window.innerWidth / 2) * 0.02;
            const y = (e.clientY - window.innerHeight / 2) * 0.02;
            document.documentElement.style.setProperty('--plx-x', `${x}px`);
            document.documentElement.style.setProperty('--plx-y', `${y}px`);
            ticking = false;
          });
          ticking = true;
        }
      }
      if (window.matchMedia("(pointer: fine)").matches) {
        window.addEventListener('mousemove', update);
      }
    })();

    /* ===========================
       INIT
    ============================ */
    
      function escHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function isoToDDMMYYYY(iso){
  const m = String(iso || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return escHtml(iso || "");
  return `${m[3]}/${m[2]}/${m[1]}`;
}

// ‚úÖ NEW: Dynamic Sauda Table Builder
function buildSaudaTableHTML(data) {
    const pairs = (data.items || [])
      .map(b => ({ item: (b.item||"").trim(), rate: (b.saudaRate||"").toString().trim() }))
      .filter(x => x.item && x.rate && Number.isFinite(+x.rate) && (+x.rate > 0));

    const count = pairs.length;
    
    // Determine number of pairs per row (1, 2, or 3)
    let pairsPerRow = 1; 
    if (count === 2) pairsPerRow = 2;
    if (count >= 3) pairsPerRow = 3;

    const totalCols = pairsPerRow * 2;

    // 1. Build Colgroup based on pairsPerRow
    let colgroup = '<colgroup>';
    // Logic: 1 pair = 70/30, 2 pairs = 35/15, 3 pairs = 20/13.3
    const wItem = pairsPerRow === 1 ? '70%' : (pairsPerRow === 2 ? '35%' : '20%');
    const wRate = pairsPerRow === 1 ? '30%' : (pairsPerRow === 2 ? '15%' : '13%');

    for(let i=0; i<pairsPerRow; i++) {
         colgroup += `<col style="width:${wItem}"><col style="width:${wRate}">`;
    }
    colgroup += '</colgroup>';

    // 2. Build Subhead row
    let subhead = '<tr class="do-gray">';
    for(let i=0; i<pairsPerRow; i++) {
        subhead += `<td>Item</td><td class="do-center">Rate</td>`;
    }
    subhead += '</tr>';

    // 3. Build Data Rows
    let rowsHtml = '';
    
    if (count === 0) {
         // Show empty placeholder row
         rowsHtml = `<tr><td colspan="${totalCols}" class="do-center">&nbsp;</td></tr>`;
    } else {
        // Loop through items in chunks of `pairsPerRow`
        for (let i = 0; i < count; i += pairsPerRow) {
            rowsHtml += '<tr>';
            for (let j = 0; j < pairsPerRow; j++) {
                const pair = pairs[i + j];
                if (pair) {
                    rowsHtml += `<td>${escHtml(pair.item)}</td><td class="do-num">${escHtml(pair.rate)}</td>`;
                } else {
                    // Fill empty cells if valid items ran out in this row
                    rowsHtml += `<td>&nbsp;</td><td>&nbsp;</td>`;
                }
            }
            rowsHtml += '</tr>';
        }
    }

    return `
    <table class="do-table do-tight sauda-table">
        ${colgroup}
        <tr><td class="do-subhead" colspan="${totalCols}">Item &amp; Sauda Rates</td></tr>
        ${subhead}
        ${rowsHtml}
    </table>
    `;
}

function buildMainRows(data){
  let sr=1, total=0, rows="";
  
  (data.items||[]).forEach(block=>{
    const itemName=(block.item||"").trim();
    (block.sizes||[]).forEach(s=>{
      const size=(s.size||"").trim();
      const qty=parseFloat(s.qty);
      if(!itemName || !size || !Number.isFinite(qty) || qty<=0) return;
      
      total+=qty;
      
      // ‚úÖ Added .do-wrap to Breakdown column
      rows+=`<tr>
        <td class="do-center">${sr++}</td>
        <td>${escHtml(itemName)}</td>
        <td>${escHtml(size)}</td>
        <td class="do-num">${qty.toFixed(3)}</td>
        <td class="do-num">${escHtml(String(Math.round(parseFloat(s.rate)||0)))}</td>
        <td class="do-wrap" style="font-size:10px;">${escHtml((s.bd||"").trim())}</td>
      </tr>`;
    });
  });

  if(!rows){
    rows=`<tr><td class="do-center">1</td><td>&nbsp;</td><td>&nbsp;</td><td class="do-num">&nbsp;</td><td class="do-num">&nbsp;</td><td>&nbsp;</td></tr>`;
  }

  // ‚úÖ FIXED: Total Row Structure
  // Col 1-3 merged: "Total"
  // Col 4: Qty
  // Col 5: "MT" (Separate cell)
  // Col 6: Empty (Under Breakdown)
  const totalRow=`<tr style="font-weight:700; background:#f9f9f9;">
    <td colspan="3" class="do-center">Total</td>
    <td class="do-num">${total>0?total.toFixed(3):"‚Äî"}</td>
    <td class="do-center">MT</td>
    <td>&nbsp;</td>
  </tr>`;

  return {rows, totalRow};
}

function buildPrintLayout(data){
  const billType=escHtml(data.billType||"");
  const dateTxt=isoToDDMMYYYY(data.orderDate||"");
  const freight=escHtml((data.freight??"").toString());
  const lorryNo=escHtml(data.lorryNo||"");
  const ob=escHtml((data.ob??"").toString());

  const dealerName=escHtml(data.dealerName||"");
  const billingName=escHtml(data.billingName||"");
  const billingAddress=escHtml(data.billingAddress||"").replaceAll("\n","<br>");
  const dispatchAddress=escHtml(data.dispatchAddress||"").replaceAll("\n","<br>");

  const note=(data.note||"").trim();
  const signedBy=escHtml(data.signedBy||"");
  const approvedBy=escHtml(data.approvedBy||"");

  // Use new dynamic builder
  const saudaTableHTML = buildSaudaTableHTML(data);
  const {rows:mainRows, totalRow}=buildMainRows(data);

  const noteSection = note ? `
    <table class="do-table do-note" style="margin-top:3mm;">
      <tr><td class="do-label do-center" style="width:10%;font-weight:700;">Note:</td>
      <td style="width:90%;">${escHtml(note).replaceAll("\n","<br>")}</td></tr>
    </table>` : "";

  return `
  <table class="do-table do-tight">
    <colgroup><col style="width:66%"><col style="width:34%"></colgroup>
    <tr>
      <td style="padding:0;">
        <table class="do-table do-tight">
          <tr><td class="do-label">Dealer Name</td><td class="do-value">${dealerName||"&nbsp;"}</td></tr>
          <tr><td class="do-label">Billing Name</td><td class="do-value">${billingName||"&nbsp;"}</td></tr>
          <tr><td class="do-label">Billing Address</td><td class="do-value">${billingAddress||"&nbsp;"}</td></tr>
          <tr><td class="do-label">Dispatch Address</td><td class="do-value">${dispatchAddress||"&nbsp;"}</td></tr>
          <tr><td class="do-label">Bill Type</td><td class="do-value">${billType||"&nbsp;"}</td></tr>
        </table>
      </td>
      <td style="padding:0;">
        <table class="do-right-table do-tight">
          <tr><td class="do-right-label">Date</td><td class="do-right-val">${dateTxt||"&nbsp;"}</td></tr>
          <tr><td class="do-right-label">Freight</td><td class="do-right-val">${freight||"&nbsp;"}</td></tr>
          <tr><td class="do-right-label">Lorry No</td><td class="do-right-val">${lorryNo||"&nbsp;"}</td></tr>
          <tr><td class="do-right-label">OB</td><td class="do-right-val">${ob||"&nbsp;"}</td></tr>
        </table>
      </td>
    </tr>

    <tr>
      <td style="padding:0;">
        <!-- DYNAMIC SAUDA TABLE -->
        ${saudaTableHTML}
      </td>
      <td style="padding:0;">
        <table class="do-right-table do-tight"><tr><td>&nbsp;</td></tr></table>
      </td>
    </tr>
  </table>

  <div class="do-section-gap"></div>

  <!-- MAIN ITEMS TABLE -->
  <table class="do-table do-tight">
    <colgroup>
      <col style="width:5%"><!-- Sr -->
      <col style="width:22%"><!-- Item -->
      <col style="width:22%"><!-- Size -->
      <col style="width:12%"><!-- Qty -->
      <col style="width:12%"><!-- Rate -->
      <col style="width:27%"><!-- Breakdown -->
    </colgroup>

    <tr class="do-gray">
      <td class="do-center">Sr</td><td>Item</td><td>Sizes</td>
      <td class="do-center">Qty (MT)</td><td class="do-center">Net Rate</td><td>Breakdown</td>
    </tr>
    ${mainRows}
    ${totalRow}
  </table>

  ${noteSection}

  <table class="do-table do-sign" style="margin-top:3mm;">
    <colgroup><col style="width:50%"><col style="width:50%"></colgroup>
    <tr>
      <td><div style="font-weight:700;">Order Signed</div><div style="margin-top:10mm;">${signedBy||"&nbsp;"}</div></td>
      <td><div style="font-weight:700;">Approved By</div><div style="margin-top:10mm;">${approvedBy||"&nbsp;"}</div></td>
    </tr>
  </table>`;
}

function applyPrintScale(){
  const page=document.getElementById("printTableLayout");
  if(!page) return;
  page.style.setProperty("--print-scale","1");
  const availablePx=1085; // ~A4 minus margins
  const h=page.getBoundingClientRect().height;
  if(h>0){
    const s=Math.min(1, availablePx/h);
    page.style.setProperty("--print-scale", String(s));
  }
}
function preparePrintAndScale(){
  recalcAll();
  const data=collectData();
  document.getElementById("printDump").innerHTML = buildPrintLayout(data);
  requestAnimationFrame(applyPrintScale);
}
window.addEventListener("beforeprint", ()=>{ try{preparePrintAndScale();}catch(e){} });

      
      function init(){
      setupRealtimeValidation();

      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) {
        try {
          const p = JSON.parse(raw);
          suppressSave = true;
          applyData(p.data);
          suppressSave = false;
          sumSavedAt.textContent = fmtTime(p.savedAt);
          setStatus("ok", "Saved");
        } catch(e) {
          addNewItemBlock();
          setStatus("warn", "Draft");
        }
      } else {
        addNewItemBlock();
        setStatus("warn", "Draft");
      }
      recalcAll();
      validateGlobalSettingsUI();
    }
    init();
  </script>
</body>
</html>